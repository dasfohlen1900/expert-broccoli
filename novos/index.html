<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NovOS 3.1</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --panel: #111118;
    --panel2: #16161f;
    --border: #2a2a3a;
    --accent: #7c6aff;
    --accent2: #ff6a8a;
    --accent3: #6affca;
    --text: #e8e8f0;
    --text2: #8888aa;
    --taskbar-h: 48px;
    --radius: 12px;
  }
  * { margin:0; padding:0; box-sizing:border-box; user-select:none; }
  input, textarea, select { user-select:text; }
  iframe { user-select:auto; pointer-events:auto; }
  body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); width:100vw; height:100vh; overflow:hidden; font-size:13px; }

  /* ══════════════════ LOGIN SCREEN ══════════════════ */
  #login-screen {
    position:fixed; inset:0; z-index:9999;
    background: radial-gradient(ellipse 80% 60% at 20% 80%,#1a0d3a 0%,transparent 60%),
                radial-gradient(ellipse 60% 80% at 80% 20%,#0d1f3a 0%,transparent 60%),
                #07060f;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0;
    transition: opacity 0.6s ease, transform 0.6s ease;
  }
  #login-screen.out { opacity:0; transform:scale(1.04); pointer-events:none; }

  .login-time {
    font-size:72px; font-weight:200; letter-spacing:-2px; color:var(--text);
    line-height:1; margin-bottom:6px;
  }
  .login-date { font-size:16px; color:var(--text2); font-weight:400; margin-bottom:48px; }

  .login-avatar {
    width:80px; height:80px; border-radius:50%;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    display:flex; align-items:center; justify-content:center;
    font-size:36px; margin-bottom:16px;
    box-shadow:0 0 40px rgba(124,106,255,0.4);
  }
  .login-name { font-size:18px; font-weight:600; margin-bottom:6px; }
  .login-sub { font-size:12px; color:var(--text2); margin-bottom:32px; }

  .login-btn {
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border:none; border-radius:50px; padding:13px 40px;
    color:white; font-family:'Inter',sans-serif; font-size:14px; font-weight:600;
    cursor:pointer; transition:transform 0.15s, box-shadow 0.15s;
    box-shadow:0 4px 24px rgba(124,106,255,0.4);
  }
  .login-btn:hover { transform:scale(1.04); box-shadow:0 8px 32px rgba(124,106,255,0.6); }
  .login-btn:active { transform:scale(0.98); }

  .login-stars {
    position:absolute; inset:0; pointer-events:none;
    background-image:
      radial-gradient(1px 1px at 10% 15%,rgba(255,255,255,0.6) 0%,transparent 100%),
      radial-gradient(1px 1px at 22% 55%,rgba(255,255,255,0.3) 0%,transparent 100%),
      radial-gradient(1px 1px at 40% 8%, rgba(255,255,255,0.5) 0%,transparent 100%),
      radial-gradient(1px 1px at 60% 70%,rgba(255,255,255,0.4) 0%,transparent 100%),
      radial-gradient(1px 1px at 75% 30%,rgba(255,255,255,0.6) 0%,transparent 100%),
      radial-gradient(1px 1px at 88% 85%,rgba(255,255,255,0.3) 0%,transparent 100%),
      radial-gradient(1px 1px at 50% 45%,rgba(255,255,255,0.2) 0%,transparent 100%),
      radial-gradient(1px 1px at 30% 90%,rgba(255,255,255,0.4) 0%,transparent 100%),
      radial-gradient(1px 1px at 95% 50%,rgba(255,255,255,0.5) 0%,transparent 100%),
      radial-gradient(1px 1px at 5%  70%,rgba(255,255,255,0.3) 0%,transparent 100%);
  }

  /* ══════════════════ DESKTOP ══════════════════ */
  #desktop {
    width:100%; height:100%; position:relative;
    background:
      radial-gradient(ellipse 80% 60% at 20% 80%,#1a0d3a 0%,transparent 60%),
      radial-gradient(ellipse 60% 80% at 80% 20%,#0d1f3a 0%,transparent 60%),
      radial-gradient(ellipse 40% 40% at 50% 50%,#120f2a 0%,transparent 70%),
      #07060f;
    display:none;
  }
  #desktop.visible { display:block; }
  #desktop::before {
    content:''; position:absolute; inset:0;
    background-image:
      radial-gradient(1px 1px at 15% 20%,rgba(255,255,255,0.5) 0%,transparent 100%),
      radial-gradient(1px 1px at 35% 60%,rgba(255,255,255,0.3) 0%,transparent 100%),
      radial-gradient(1px 1px at 55% 10%,rgba(255,255,255,0.4) 0%,transparent 100%),
      radial-gradient(1px 1px at 75% 45%,rgba(255,255,255,0.6) 0%,transparent 100%),
      radial-gradient(1px 1px at 85% 80%,rgba(255,255,255,0.3) 0%,transparent 100%),
      radial-gradient(1px 1px at 25% 85%,rgba(255,255,255,0.5) 0%,transparent 100%),
      radial-gradient(1px 1px at 65% 30%,rgba(255,255,255,0.4) 0%,transparent 100%),
      radial-gradient(1px 1px at 90% 15%,rgba(255,255,255,0.3) 0%,transparent 100%),
      radial-gradient(1px 1px at 45% 75%,rgba(255,255,255,0.5) 0%,transparent 100%),
      radial-gradient(1px 1px at 10% 50%,rgba(255,255,255,0.4) 0%,transparent 100%);
  }

  /* Desktop icon grid — responsive, respects taskbar */
  .icon-grid {
    position:absolute;
    top:12px;
    left:12px;
    bottom:calc(var(--taskbar-h) + 12px); /* never overlap taskbar */
    right:12px;
    display:grid;
    /* columns fill left-to-right, each 80px wide */
    grid-template-columns:repeat(auto-fill,80px);
    grid-template-rows:repeat(auto-fill,88px);
    grid-auto-flow:column;  /* fill column by column, top to bottom */
    align-content:start;
    justify-content:start;
    gap:4px;
    overflow:hidden; /* no scrollbar — grid itself defines capacity */
    pointer-events:none; /* let clicks fall through to desktop */
  }
  .desk-icon {
    display:flex; flex-direction:column; align-items:center;
    gap:5px; width:80px; height:88px; cursor:pointer; padding:8px 4px 6px;
    border-radius:12px; transition:background 0.15s;
    pointer-events:all; /* re-enable on icons */
    user-select:none;
  }
  .desk-icon:hover  { background:rgba(124,106,255,0.18); }
  .desk-icon:active { background:rgba(124,106,255,0.30); transform:scale(0.95); }
  .desk-icon .ico {
    width:48px; height:48px; border-radius:12px;
    display:flex; align-items:center; justify-content:center; font-size:24px;
    flex-shrink:0;
  }
  .desk-icon span {
    font-size:11px; color:var(--text); text-align:center;
    text-shadow:0 1px 3px rgba(0,0,0,0.6);
    line-height:1.2; max-width:72px;
    overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
  }

  /* ══════════════════ TASKBAR ══════════════════ */
  #taskbar {
    position:absolute; bottom:0; left:0; right:0;
    height:var(--taskbar-h);
    background:rgba(255,255,255,0.7); backdrop-filter:blur(20px);
    border-top:1px solid var(--border);
    display:flex; align-items:center; padding:0 12px; gap:6px; z-index:1000;
  }
  #start-btn {
    width:36px; height:36px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border-radius:10px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; font-size:16px;
    box-shadow:0 0 16px rgba(124,106,255,0.4);
    transition:transform 0.15s, box-shadow 0.15s; flex-shrink:0;
  }
  #start-btn:hover { transform:scale(1.08); box-shadow:0 0 24px rgba(124,106,255,0.6); }
  .taskbar-sep { width:1px; height:28px; background:var(--border); margin:0 4px; flex-shrink:0; }
  #taskbar-apps { display:flex; gap:6px; flex:1; overflow:hidden; }
  .tb-app {
    height:36px; padding:0 10px; background:var(--panel);
    border:1px solid var(--border); border-radius:8px;
    display:flex; align-items:center; gap:6px;
    cursor:pointer; font-size:11px; color:var(--text2);
    transition:all 0.15s; white-space:nowrap; max-width:140px;
  }
  .tb-app:hover { background:var(--panel2); color:var(--text); border-color:var(--accent); }
  .tb-app.active { color:var(--accent); border-color:var(--accent); background:rgba(124,106,255,0.1); }

  #tb-right { display:flex; align-items:center; gap:10px; flex-shrink:0; }
  #tb-icons { display:flex; align-items:center; gap:8px; }
  .tb-icon { font-size:14px; cursor:pointer; opacity:0.7; transition:opacity 0.15s; }
  .tb-icon:hover { opacity:1; }
  #clock { font-size:13px; font-weight:600; color:var(--text); }
  #date-display { font-size:10px; color:var(--text2); }

  /* ══════════════════ CONTROL CENTER ══════════════════ */
  .cc-section { margin-bottom:14px; }
  .cc-section:last-child { margin-bottom:0; }
  .cc-label { font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text2);margin-bottom:8px; }
  .cc-tiles { display:grid;grid-template-columns:1fr 1fr;gap:8px; }
  .cc-tile {
    background:var(--panel2);border:1px solid var(--border);border-radius:12px;
    padding:12px 10px;cursor:pointer;transition:all 0.15s;
    display:flex;flex-direction:column;gap:5px;
  }
  .cc-tile:hover { border-color:var(--accent);background:rgba(124,106,255,0.08); }
  .cc-tile.on { background:rgba(124,106,255,0.18);border-color:var(--accent); }
  .cc-tile-icon { font-size:20px;line-height:1; }
  .cc-tile-name { font-size:11px;font-weight:600;color:var(--text); }
  .cc-tile-sub  { font-size:10px;color:var(--text2); }
  .cc-slider-row { display:flex;align-items:center;gap:10px;padding:4px 0; }
  .cc-slider-icon { font-size:16px;flex-shrink:0; }
  .cc-slider {
    flex:1;-webkit-appearance:none;height:4px;border-radius:2px;
    background:var(--border);outline:none;cursor:pointer;
  }
  .cc-slider::-webkit-slider-thumb {
    -webkit-appearance:none;width:16px;height:16px;border-radius:50%;
    background:var(--accent);cursor:pointer;box-shadow:0 0 6px rgba(124,106,255,0.5);
  }
  .cc-bat-bar { height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:4px; }
  .cc-bat-fill { height:100%;border-radius:4px;transition:width 0.6s ease; }

  /* ══════════════════ START MENU ══════════════════ */
  #start-menu {
    position:absolute; bottom:calc(var(--taskbar-h) + 8px); left:12px;
    width:320px; background:rgba(14,14,24,0.97);
    backdrop-filter:blur(24px); border:1px solid var(--border);
    border-radius:14px; box-shadow:0 24px 80px rgba(0,0,0,0.8);
    padding:16px; z-index:2000; display:none;
    animation:fadeUp 0.18s ease;
  }
  @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  #start-menu.open { display:block; }
  .sm-header {
    font-size:20px; font-weight:800;
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    margin-bottom:12px;
  }
  .sm-search {
    width:100%; background:var(--panel2); border:1px solid var(--border);
    border-radius:8px; padding:8px 12px; color:var(--text);
    font-family:'Inter',sans-serif; font-size:12px; outline:none; margin-bottom:12px;
  }
  .sm-search:focus { border-color:var(--accent); }
  .sm-section { font-size:10px; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
  .sm-apps { display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:12px; }
  .sm-app {
    background:var(--panel2); border:1px solid var(--border);
    border-radius:8px; padding:9px 10px;
    display:flex; align-items:center; gap:8px;
    cursor:pointer; transition:all 0.15s;
  }
  .sm-app:hover { border-color:var(--accent); background:rgba(124,106,255,0.1); }
  .sm-app .ico { font-size:16px; }
  .sm-app .name { font-size:12px; color:var(--text); }
  .sm-footer {
    border-top:1px solid var(--border); padding-top:10px; margin-top:4px;
    display:flex; gap:6px;
  }
  .sm-footer-btn {
    flex:1; padding:8px; border-radius:8px;
    background:var(--panel2); border:1px solid var(--border);
    display:flex; align-items:center; justify-content:center; gap:6px;
    cursor:pointer; font-size:11px; color:var(--text2); transition:all 0.15s;
  }
  .sm-footer-btn:hover { border-color:var(--accent); color:var(--text); }

  /* ══════════════════ WINDOW ══════════════════ */
  .window {
    position:absolute; background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:0 24px 80px rgba(0,0,0,0.7),0 0 0 1px rgba(255,255,255,0.04);
    display:flex; flex-direction:column; overflow:hidden; transition:box-shadow 0.2s;
    min-width:280px; min-height:200px;
  }
  .window.focused {
    box-shadow:0 24px 80px rgba(0,0,0,0.8),0 0 0 1px rgba(124,106,255,0.3),0 0 60px rgba(124,106,255,0.05);
    border-color:rgba(124,106,255,0.3);
  }
  .win-titlebar {
    height:38px; background:var(--panel2); border-bottom:1px solid var(--border);
    display:flex; align-items:center; padding:0 12px; gap:8px;
    cursor:grab; flex-shrink:0;
  }
  .win-titlebar:active { cursor:grabbing; }
  .win-btns { display:flex; gap:6px; }
  .win-btn { width:12px; height:12px; border-radius:50%; cursor:pointer; border:none; outline:none; transition:filter 0.15s; }
  .win-btn:hover { filter:brightness(1.3); }
  .btn-close { background:#ff5f57; }
  .btn-min   { background:#febc2e; }
  .btn-max   { background:#28c840; }
  .win-title { font-size:12px; color:var(--text2); margin-left:4px; flex:1; display:flex; align-items:center; gap:6px; }
  .win-body { flex:1; overflow:hidden; display:flex; flex-direction:column; min-height:0; }
  .resize-handle { position:absolute; bottom:0; right:0; width:16px; height:16px; cursor:nw-resize; opacity:0.4; }
  .resize-handle::after {
    content:''; position:absolute; bottom:4px; right:4px;
    width:8px; height:8px; border-right:2px solid var(--text2); border-bottom:2px solid var(--text2); border-radius:1px;
  }

  /* ══════════════════ CONTEXT MENU ══════════════════ */
  #ctx-menu {
    position:absolute; z-index:3000; background:rgba(14,14,24,0.97);
    backdrop-filter:blur(20px); border:1px solid var(--border);
    border-radius:10px; padding:6px; box-shadow:0 16px 48px rgba(0,0,0,0.7);
    min-width:190px; display:none; animation:ctxIn 0.12s ease;
  }
  @keyframes ctxIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
  #ctx-menu.open { display:block; }
  .ctx-item {
    padding:8px 12px; border-radius:6px; cursor:pointer;
    font-size:12px; color:var(--text2);
    display:flex; align-items:center; gap:10px; transition:all 0.1s;
  }
  .ctx-item:hover { background:rgba(124,106,255,0.15); color:var(--text); }
  .ctx-item.danger:hover { background:rgba(255,106,138,0.15); color:var(--accent2); }
  .ctx-sep { height:1px; background:var(--border); margin:4px 0; }

  /* ══════════════════ NOTIFICATIONS ══════════════════ */
  #notif-area { position:absolute; top:16px; right:16px; display:flex; flex-direction:column; gap:8px; z-index:4000; pointer-events:none; }
  .notif {
    background:rgba(14,14,24,0.97); backdrop-filter:blur(20px);
    border:1px solid var(--border); border-left:3px solid var(--accent);
    border-radius:10px; padding:12px 16px; min-width:260px;
    box-shadow:0 8px 32px rgba(0,0,0,0.6); animation:notifIn 0.3s ease; pointer-events:all;
  }
  .notif.out { animation:notifOut 0.3s ease forwards; }
  @keyframes notifIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:none} }
  @keyframes notifOut { from{opacity:1;transform:none} to{opacity:0;transform:translateX(20px)} }
  .notif-title { font-size:12px; font-weight:600; color:var(--text); margin-bottom:3px; }
  .notif-msg { font-size:11px; color:var(--text2); }

  /* ══════════════════ DIALOGS ══════════════════ */
  #nov-dialog-overlay {
    position:fixed; inset:0; z-index:9000;
    background:rgba(0,0,0,0.45); backdrop-filter:blur(4px);
    display:flex; align-items:center; justify-content:center;
    animation:fadeIn 0.12s ease;
  }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  #nov-dialog {
    background:var(--panel); border:1px solid var(--border);
    border-radius:16px; padding:28px 28px 22px;
    box-shadow:0 24px 80px rgba(0,0,0,0.55);
    min-width:320px; max-width:440px; width:90%;
    animation:dialogPop 0.15s cubic-bezier(0.34,1.56,0.64,1);
  }
  @keyframes dialogPop { from{opacity:0;transform:scale(0.88)} to{opacity:1;transform:scale(1)} }
  .dlg-icon   { font-size:36px; text-align:center; margin-bottom:10px; }
  .dlg-title  { font-size:15px; font-weight:700; color:var(--text); margin-bottom:6px; }
  .dlg-msg    { font-size:13px; color:var(--text2); margin-bottom:18px; line-height:1.5; white-space:pre-wrap; }
  .dlg-input  {
    width:100%; box-sizing:border-box;
    background:var(--panel2); border:1px solid var(--border);
    border-radius:9px; padding:9px 12px; color:var(--text);
    font-family:'Inter',sans-serif; font-size:13px; outline:none;
    margin-bottom:18px; transition:border-color 0.15s;
  }
  .dlg-input:focus { border-color:var(--accent); }
  .dlg-btns   { display:flex; gap:8px; justify-content:flex-end; }
  .dlg-btn {
    padding:8px 20px; border-radius:8px; font-size:13px; font-weight:600;
    cursor:pointer; border:none; font-family:'Inter',sans-serif; transition:all 0.15s;
  }
  .dlg-btn-primary { background:var(--accent); color:white; }
  .dlg-btn-primary:hover { filter:brightness(1.12); }
  .dlg-btn-secondary { background:var(--panel2); color:var(--text2); border:1px solid var(--border); }
  .dlg-btn-secondary:hover { color:var(--text); border-color:var(--text2); }
  .dlg-btn-danger { background:var(--accent2); color:white; }
  .dlg-btn-danger:hover { filter:brightness(1.12); }

  /* ══════════════════ SCROLLBAR ══════════════════ */
  ::-webkit-scrollbar { width:5px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
  ::-webkit-scrollbar-thumb:hover { background:var(--text2); }

  /* ══════════════════ TERMINAL ══════════════════ */
  .terminal-body {
    background:var(--panel); padding:14px;
    font-family:'Courier New',monospace; font-size:12px;
    color:var(--accent3); overflow-y:auto; flex:1; line-height:1.6;
  }
  .terminal-line { margin-bottom:2px; }
  .terminal-prompt { color:var(--accent); }
  .terminal-cmd { color:var(--text); }
  .terminal-out { color:var(--text2); }
  .terminal-err { color:var(--accent2); }
  .terminal-input-row {
    display:flex; align-items:center; gap:6px;
    padding:8px 14px; border-top:1px solid var(--border); background:var(--panel2);
  }
  .terminal-prompt-inp { color:var(--accent); flex-shrink:0; font-family:'Courier New',monospace; font-size:12px; }
  .terminal-input {
    flex:1; background:none; border:none; outline:none;
    color:var(--text); font-family:'Courier New',monospace; font-size:12px;
  }

  /* ══════════════════ FILE MANAGER ══════════════════ */
  .fm-sidebar { width:160px; flex-shrink:0; border-right:1px solid var(--border); padding:10px 8px; background:var(--panel2); overflow-y:auto; }
  .fm-section { font-size:10px; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin:10px 0 4px; padding:0 6px; font-weight:700; }
  .fm-item {
    display:flex; align-items:center; gap:8px;
    padding:7px 8px; border-radius:7px;
    cursor:pointer; font-size:12px; color:var(--text2); transition:all 0.1s;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .fm-item:hover { background:var(--border); color:var(--text); }
  .fm-item.active { background:rgba(124,106,255,0.18); color:var(--accent); font-weight:600; }
  .fm-toolbar {
    display:flex; align-items:center; gap:6px; padding:8px 12px;
    border-bottom:1px solid var(--border); background:var(--panel2); flex-shrink:0; flex-wrap:wrap;
  }
  .fm-breadcrumb {
    display:flex; align-items:center; gap:4px; flex:1;
    font-size:11px; color:var(--text2); overflow:hidden;
  }
  .fm-crumb {
    cursor:pointer; color:var(--text2); padding:2px 4px; border-radius:4px; transition:all 0.1s;
    white-space:nowrap;
  }
  .fm-crumb:hover { color:var(--accent); background:rgba(124,106,255,0.1); }
  .fm-crumb.current { color:var(--text); font-weight:600; cursor:default; }
  .fm-crumb.current:hover { background:none; color:var(--text); }
  .fm-sep { color:var(--border); }
  .fm-content { flex:1; padding:14px; overflow-y:auto; background:var(--panel); min-height:0; }
  .fm-grid { display:grid; grid-template-columns:repeat(auto-fill,82px); gap:6px; }
  .fm-file {
    display:flex; flex-direction:column; align-items:center; gap:4px;
    padding:10px 6px 8px; border-radius:10px; cursor:pointer; transition:all 0.12s;
    border:2px solid transparent; position:relative;
  }
  .fm-file:hover { background:rgba(124,106,255,0.10); }
  .fm-file.selected { background:rgba(124,106,255,0.18); border-color:rgba(124,106,255,0.4); }
  .fm-file .ico { font-size:30px; line-height:1.2; }
  .fm-file .name {
    font-size:10px; color:var(--text); text-align:center;
    word-break:break-word; line-height:1.3; max-width:74px;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }
  .fm-file .name.text2 { color:var(--text2); }
  .fm-empty {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:10px; height:100%; color:var(--text2); padding:40px;
  }
  /* FM context menu */
  #fm-ctx {
    position:fixed; z-index:9900;
    background:var(--panel); border:1px solid var(--border);
    border-radius:10px; padding:5px; box-shadow:0 12px 40px rgba(0,0,0,0.35);
    min-width:180px; display:none;
    backdrop-filter:blur(12px);
  }

  /* ══════════════════ BROWSER ══════════════════ */
  .browser-bar {
    display:flex; align-items:center; gap:6px;
    padding:8px 10px; border-bottom:1px solid var(--border); background:var(--panel2); flex-shrink:0;
  }
  .browser-nav-btn {
    width:26px; height:26px; border-radius:6px; background:none; border:none;
    color:var(--text2); cursor:pointer; font-size:13px;
    display:flex; align-items:center; justify-content:center; transition:all 0.1s;
  }
  .browser-nav-btn:hover { background:var(--border); color:var(--text); }
  .browser-url {
    flex:1; background:var(--panel); border:1px solid var(--border); border-radius:20px;
    padding:5px 14px; color:var(--text); font-family:'Inter',sans-serif; font-size:12px; outline:none;
  }
  .browser-url:focus { border-color:var(--accent); }
  .browser-tabs { display:flex; gap:2px; padding:6px 10px 0; background:var(--panel2); flex-shrink:0; }
  .browser-tab {
    padding:5px 14px; border-radius:6px 6px 0 0; font-size:11px; cursor:pointer;
    background:var(--panel); color:var(--text2); border:1px solid var(--border); border-bottom:none;
    transition:all 0.1s;
  }
  .browser-tab.active { background:var(--panel); color:var(--text); border-color:rgba(124,106,255,0.3); }
  .browser-content { flex:1; overflow-y:auto; }
  .browser-page { max-width:640px; margin:0 auto; padding:24px; }
  .browser-page h1 { font-size:22px; font-weight:800; color:var(--accent); margin-bottom:8px; }
  .browser-page h2 { font-size:15px; font-weight:700; color:var(--text); margin:18px 0 8px; }
  .browser-page p { color:var(--text2); line-height:1.7; margin-bottom:10px; font-size:13px; }
  .browser-page a { color:var(--accent); cursor:pointer; }
  .browser-quicklinks { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:16px; }
  .browser-ql {
    padding:14px; background:var(--panel2); border:1px solid var(--border); border-radius:10px;
    cursor:pointer; transition:all 0.15s;
  }
  .browser-ql:hover { border-color:var(--accent); }
  .browser-ql .ql-icon { font-size:20px; margin-bottom:6px; }
  .browser-ql .ql-title { font-size:12px; font-weight:600; color:var(--text); }
  .browser-ql .ql-url { font-size:10px; color:var(--text2); margin-top:2px; }

  /* ══════════════════ MUSIC ══════════════════ */
  .music-shell {
    display:flex; flex:1; overflow:hidden; background:var(--panel);
  }
  .music-sidebar {
    width:190px; flex-shrink:0; border-right:1px solid var(--border);
    background:var(--panel2); padding:12px 8px; overflow-y:auto; display:flex; flex-direction:column; gap:2px;
  }
  .music-nav-section { font-size:9px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:1px; padding:12px 8px 4px; }
  .music-nav-item {
    display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:7px;
    cursor:pointer; font-size:12px; color:var(--text2); transition:all 0.12s;
  }
  .music-nav-item:hover { background:var(--border); color:var(--text); }
  .music-nav-item.active { background:rgba(124,106,255,0.18); color:var(--accent); font-weight:600; }
  .music-main-area {
    flex:1; display:flex; flex-direction:column; overflow:hidden;
  }
  .music-library {
    flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:0;
  }
  .music-lib-header {
    display:flex; align-items:center; justify-content:space-between;
    padding:0 8px 12px; flex-shrink:0;
  }
  .music-lib-title { font-size:18px; font-weight:700; color:var(--text); }
  .music-track-row {
    display:grid; grid-template-columns:28px 1fr 1fr 60px;
    align-items:center; gap:12px; padding:8px 10px; border-radius:8px;
    cursor:pointer; transition:background 0.1s; border-bottom:1px solid var(--border);
  }
  .music-track-row:hover { background:var(--border); }
  .music-track-row.playing { background:rgba(124,106,255,0.12); }
  .music-track-row .tnum { font-size:11px; color:var(--text2); text-align:center; }
  .music-track-row .tnum.eq { color:var(--accent); animation:eq-pulse 1s ease-in-out infinite; }
  @keyframes eq-pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .music-track-row .tname { font-size:12px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .music-track-row .tartist { font-size:11px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .music-track-row .tdur { font-size:11px; color:var(--text2); text-align:right; }
  .music-player-bar {
    border-top:1px solid var(--border); background:var(--panel2); padding:12px 16px;
    display:flex; flex-direction:column; gap:10px; flex-shrink:0;
  }
  .music-player-top { display:flex; align-items:center; gap:16px; }
  .music-mini-art {
    width:44px; height:44px; border-radius:8px; flex-shrink:0;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    display:flex; align-items:center; justify-content:center; font-size:20px;
    box-shadow:0 4px 16px rgba(124,106,255,0.4);
    animation:spin-slow 20s linear infinite paused;
  }
  .music-mini-art.playing { animation-play-state:running; }
  @keyframes spin-slow { to{transform:rotate(360deg)} }
  .music-mini-info { flex:1; min-width:0; }
  .music-mini-title { font-size:13px; font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .music-mini-artist { font-size:11px; color:var(--text2); }
  .music-player-controls { display:flex; align-items:center; gap:10px; flex-shrink:0; }
  .music-ctrl-btn { background:none; border:none; cursor:pointer; color:var(--text2); font-size:16px; padding:6px; border-radius:6px; transition:all 0.12s; }
  .music-ctrl-btn:hover { color:var(--text); background:rgba(255,255,255,0.07); }
  .music-ctrl-btn.active { color:var(--accent); }
  .music-play-btn {
    width:38px; height:38px; border-radius:50%; border:none; cursor:pointer;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:white; font-size:14px; display:flex; align-items:center; justify-content:center;
    box-shadow:0 4px 16px rgba(124,106,255,0.5); transition:transform 0.15s;
  }
  .music-play-btn:hover { transform:scale(1.08); }
  .music-player-progress { display:flex; align-items:center; gap:10px; }
  .music-prog-time { font-size:10px; color:var(--text2); width:30px; flex-shrink:0; }
  .music-prog-time.end { text-align:right; }
  .music-prog-track { flex:1; height:3px; background:var(--border); border-radius:2px; cursor:pointer; position:relative; }
  .music-prog-fill { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:2px; transition:width 0.8s linear; pointer-events:none; }
  .music-vol-row { display:flex; align-items:center; gap:8px; }
  .music-vol-icon { font-size:12px; color:var(--text2); cursor:pointer; }
  .music-vol-slider {
    flex:1; height:2px; background:var(--border); border-radius:2px; cursor:pointer;
    -webkit-appearance:none; appearance:none; outline:none;
  }
  .music-vol-slider::-webkit-slider-thumb {
    -webkit-appearance:none; width:10px; height:10px; border-radius:50%; background:var(--accent); cursor:pointer;
  }

  /* ══════════════════ SETTINGS ══════════════════ */
  .settings-sidebar { width:170px; flex-shrink:0; border-right:1px solid var(--border); padding:12px 8px; background:var(--panel2); overflow-y:auto; }
  .settings-content { flex:1; padding:20px; overflow-y:auto; min-height:0; }
  .setting-group { margin-bottom:24px; }
  .setting-group h3 { font-size:14px; font-weight:700; margin-bottom:12px; color:var(--text); padding-bottom:6px; border-bottom:1px solid var(--border); }
  .setting-row { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(42,42,58,0.5); }
  .setting-label { color:var(--text2); font-size:12px; }
  .setting-label small { display:block; font-size:10px; color:var(--text2); opacity:0.6; margin-top:2px; }
  .toggle { width:40px; height:22px; background:var(--border); border-radius:11px; cursor:pointer; position:relative; transition:background 0.2s; flex-shrink:0; }
  .toggle.on { background:var(--accent); }
  .toggle::after { content:''; position:absolute; top:3px; left:3px; width:16px; height:16px; border-radius:50%; background:white; transition:left 0.2s; }
  .toggle.on::after { left:21px; }
  .setting-select {
    background:var(--panel); border:1px solid var(--border); border-radius:6px;
    padding:4px 8px; color:var(--text); font-family:'Inter',sans-serif; font-size:11px; outline:none; cursor:pointer;
  }
  .setting-btn {
    padding:6px 14px; border-radius:6px; border:1px solid var(--border);
    background:var(--panel); color:var(--text2); font-family:'Inter',sans-serif;
    font-size:11px; cursor:pointer; transition:all 0.15s;
  }
  .setting-btn:hover { border-color:var(--accent); color:var(--accent); }
  .setting-btn.danger:hover { border-color:var(--accent2); color:var(--accent2); }
  .about-box {
    background:var(--panel2); border:1px solid var(--border); border-radius:10px;
    padding:16px; display:flex; gap:14px; align-items:center;
  }
  .about-logo { font-size:36px; }
  .about-name { font-size:16px; font-weight:700; }
  .about-ver { font-size:11px; color:var(--text2); margin-top:3px; }

  /* ══════════════════ CALCULATOR ══════════════════ */
  .calc-shell { flex:1; display:flex; flex-direction:column; background:var(--panel); overflow:hidden; }
  .calc-mode-bar {
    display:flex; border-bottom:1px solid var(--border); background:var(--panel2); flex-shrink:0;
  }
  .calc-mode-btn {
    flex:1; padding:7px; font-size:11px; font-weight:600; background:none; border:none;
    color:var(--text2); cursor:pointer; transition:all 0.12s; border-bottom:2px solid transparent;
    font-family:'Inter',sans-serif;
  }
  .calc-mode-btn.active { color:var(--accent); border-bottom-color:var(--accent); background:rgba(124,106,255,0.07); }
  .calc-display {
    padding:14px 16px 10px; text-align:right; flex-shrink:0;
    background:var(--panel2);
  }
  .calc-history-strip { font-size:10px; color:var(--text2); min-height:14px; opacity:0.7; word-break:break-all; }
  .calc-expr { font-size:12px; color:var(--text2); min-height:16px; margin-bottom:4px; }
  .calc-val { font-size:32px; font-weight:200; color:var(--text); word-break:break-all; line-height:1.1; }
  .calc-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; padding:10px; flex:1; }
  .calc-grid-sci { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; padding:8px; flex:1; }
  .calc-btn {
    border-radius:10px; border:1px solid var(--border); cursor:pointer;
    font-family:'Inter',sans-serif; font-size:15px; font-weight:500;
    background:var(--panel2); color:var(--text);
    display:flex; align-items:center; justify-content:center; padding:0;
    transition:all 0.08s; min-height:52px;
  }
  .calc-btn:hover  { filter:brightness(0.92); }
  .calc-btn:active { transform:scale(0.93); filter:brightness(0.85); }
  .calc-btn.op   { background:rgba(124,106,255,0.13); color:var(--accent); border-color:rgba(124,106,255,0.25); }
  .calc-btn.op:hover { background:rgba(124,106,255,0.22); }
  .calc-btn.eq   { background:linear-gradient(135deg,var(--accent),var(--accent2)); color:white; border:none; box-shadow:0 4px 20px rgba(124,106,255,0.4); }
  .calc-btn.eq:hover { filter:brightness(1.12); }
  .calc-btn.clr  { color:var(--accent2); background:rgba(255,106,138,0.08); }
  .calc-btn.sci  { font-size:11px; background:rgba(106,255,202,0.06); color:var(--accent3); border-color:rgba(106,255,202,0.15); }
  .calc-btn.sci:hover { background:rgba(106,255,202,0.12); }
  .calc-btn.span2 { grid-column:span 2; }
  .calc-history-panel {
    max-height:90px; overflow-y:auto; padding:0 12px 8px;
    display:flex; flex-direction:column; gap:2px;
  }
  .calc-hist-row {
    font-size:10px; color:var(--text2); text-align:right; padding:2px 0;
    border-bottom:1px solid var(--border); cursor:pointer;
  }
  .calc-hist-row:hover { color:var(--accent); }

  /* ══════════════════ TEXT EDITOR ══════════════════ */
  .editor-toolbar {
    display:flex; align-items:center; gap:6px; padding:6px 12px;
    border-bottom:1px solid var(--border); background:var(--panel2); flex-shrink:0; flex-wrap:wrap;
  }
  .editor-btn {
    padding:4px 8px; border-radius:5px; border:1px solid var(--border);
    background:none; color:var(--text2); font-family:'Inter',sans-serif; font-size:11px;
    cursor:pointer; transition:all 0.1s;
  }
  .editor-btn:hover { background:var(--border); color:var(--text); }
  .editor-sep { width:1px; height:18px; background:var(--border); margin:0 2px; }
  .editor-area {
    flex:1; background:var(--panel); padding:16px; color:var(--text);
    font-family:'Courier New',monospace; font-size:13px; line-height:1.7;
    outline:none; resize:none; border:none; overflow-y:auto;
    white-space:pre-wrap; tab-size:2;
  }
  .editor-statusbar {
    display:flex; justify-content:space-between; align-items:center;
    padding:4px 12px; border-top:1px solid var(--border); background:var(--panel2);
    font-size:10px; color:var(--text2); flex-shrink:0;
  }

  /* ══════════════════ SYSTEM MONITOR ══════════════════ */
  .sysmon-shell { flex:1; display:flex; flex-direction:column; background:var(--panel); overflow:hidden; }
  .sysmon-tabs { display:flex; border-bottom:1px solid var(--border); background:var(--panel2); flex-shrink:0; }
  .sysmon-tab {
    padding:8px 16px; font-size:11px; cursor:pointer; color:var(--text2);
    border-bottom:2px solid transparent; transition:all 0.12s; user-select:none;
  }
  .sysmon-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
  .sysmon-tab:hover:not(.active) { color:var(--text); background:var(--border); }
  .sysmon-pane { flex:1; overflow-y:auto; padding:14px; display:flex; flex-direction:column; gap:12px; min-height:0; }
  .sysmon-overview { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .sysmon-card {
    background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:14px;
  }
  .sysmon-card-title { font-size:10px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:0.6px; margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; }
  .sysmon-val-row { display:flex; align-items:baseline; gap:6px; margin-bottom:8px; }
  .sysmon-big { font-size:28px; font-weight:700; color:var(--text); line-height:1; }
  .sysmon-sub { font-size:11px; color:var(--text2); }
  .bar-track { width:100%; height:7px; background:var(--border); border-radius:4px; overflow:hidden; margin-bottom:8px; }
  .bar-fill { height:100%; border-radius:4px; transition:width 0.8s ease; }
  .spark-wrap { height:44px; overflow:hidden; position:relative; }
  .spark-canvas { width:100%; height:44px; display:block; }
  .sysmon-label-row { display:flex; justify-content:space-between; font-size:9px; color:var(--text2); opacity:0.6; }
  .proc-table { width:100%; border-collapse:collapse; font-size:11px; }
  .proc-table th { text-align:left; color:var(--text2); font-weight:600; font-size:10px; text-transform:uppercase; letter-spacing:0.5px; padding:6px 8px; border-bottom:1px solid var(--border); cursor:pointer; user-select:none; }
  .proc-table th:hover { color:var(--text); }
  .proc-table td { padding:7px 8px; color:var(--text); border-bottom:1px solid rgba(255,255,255,0.04); }
  .proc-table tr:hover td { background:var(--border); }
  .proc-table .kill-btn {
    background:rgba(255,80,80,0.15); border:1px solid rgba(255,80,80,0.3); border-radius:4px;
    color:#ff5050; padding:2px 8px; font-size:10px; cursor:pointer; transition:all 0.1s;
  }
  .proc-table .kill-btn:hover { background:rgba(255,80,80,0.3); }
  .proc-cpu-bar { display:inline-block; height:3px; border-radius:2px; background:var(--accent); vertical-align:middle; margin-left:6px; transition:width 0.5s; }

  /* ══════════════════ PDF VIEWER ══════════════════ */
  .pdf-toolbar {
    display:flex; align-items:center; gap:6px; padding:6px 12px;
    border-bottom:1px solid var(--border); background:var(--panel2);
    flex-shrink:0; flex-wrap:wrap;
  }
  .pdf-body {
    flex:1; display:flex; overflow:hidden; background:var(--bg);
  }
  .pdf-sidebar {
    width:180px; flex-shrink:0; border-right:1px solid var(--border);
    background:var(--panel2); overflow-y:auto; padding:8px;
  }
  .pdf-sidebar-title {
    font-size:10px; font-weight:700; text-transform:uppercase;
    letter-spacing:0.5px; color:var(--text2); margin-bottom:8px; padding:4px 2px;
  }
  .pdf-thumb {
    background:white; border:1px solid var(--border); border-radius:6px;
    margin-bottom:6px; cursor:pointer; overflow:hidden; transition:all 0.15s;
    position:relative;
  }
  .pdf-thumb:hover { border-color:var(--accent); box-shadow:0 2px 8px rgba(124,106,255,0.2); }
  .pdf-thumb.active { border-color:var(--accent); box-shadow:0 0 0 2px rgba(124,106,255,0.3); }
  .pdf-thumb-page { height:100px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; }
  .pdf-thumb-num { font-size:10px; color:var(--text2); text-align:center; padding:4px; background:var(--panel2); border-top:1px solid var(--border); }
  .pdf-main {
    flex:1; overflow-y:auto; padding:24px; display:flex; flex-direction:column;
    align-items:center; gap:20px; min-height:0;
  }
  .pdf-page {
    background:white; box-shadow:0 4px 24px rgba(0,0,0,0.15);
    border-radius:4px; width:100%; max-width:600px;
    min-height:800px; position:relative; overflow:hidden;
    transition:transform 0.15s;
  }
  .pdf-page-content {
    padding:48px 56px; color:#1a1a2e; font-family:'Georgia',serif;
    font-size:13px; line-height:1.8;
  }
  .pdf-page-num {
    position:absolute; bottom:16px; left:0; right:0;
    text-align:center; font-size:10px; color:#888;
  }
  .pdf-empty {
    flex:1; display:flex; flex-direction:column; align-items:center;
    justify-content:center; gap:16px; color:var(--text2);
  }

  /* ══════════════════ GALLERY ══════════════════ */
  .gallery-shell { display:flex; flex:1; overflow:hidden; }
  .gallery-sidebar {
    width:160px; flex-shrink:0; border-right:1px solid var(--border);
    background:var(--panel2); padding:10px 8px; overflow-y:auto; display:flex; flex-direction:column; gap:1px;
  }
  .gallery-nav-section { font-size:9px; font-weight:700; color:var(--text2); text-transform:uppercase; letter-spacing:1px; padding:10px 8px 4px; }
  .gallery-nav-item {
    display:flex; align-items:center; gap:9px; padding:7px 10px; border-radius:7px;
    cursor:pointer; font-size:12px; color:var(--text2); transition:all 0.1s;
  }
  .gallery-nav-item:hover { background:var(--border); color:var(--text); }
  .gallery-nav-item.active { background:rgba(124,106,255,0.18); color:var(--accent); font-weight:600; }
  .gallery-main { flex:1; display:flex; flex-direction:column; overflow:hidden; }
  .gallery-toolbar {
    display:flex; align-items:center; gap:8px; padding:8px 12px;
    border-bottom:1px solid var(--border); background:var(--panel2); flex-shrink:0;
  }
  .gallery-view-toggle { display:flex; border:1px solid var(--border); border-radius:6px; overflow:hidden; }
  .gallery-view-btn {
    padding:4px 9px; background:none; border:none; color:var(--text2); cursor:pointer; font-size:11px; transition:all 0.1s;
  }
  .gallery-view-btn.active { background:var(--accent); color:white; }
  .gallery-content { flex:1; overflow-y:auto; padding:14px; }
  .gallery-section-header {
    font-size:11px; font-weight:700; color:var(--text2); text-transform:uppercase;
    letter-spacing:0.5px; padding:8px 2px 6px; border-bottom:1px solid var(--border); margin-bottom:10px;
  }
  .gallery-grid-view { display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:6px; }
  .gallery-list-view { display:flex; flex-direction:column; gap:1px; }
  .gallery-tile {
    border-radius:8px; overflow:hidden; cursor:pointer;
    border:2px solid transparent; transition:all 0.15s; position:relative;
  }
  .gallery-tile:hover { border-color:var(--accent); transform:scale(1.02); }
  .gallery-tile.selected { border-color:var(--accent); box-shadow:0 0 0 2px rgba(124,106,255,0.3); }
  .gallery-tile-img { width:100%; aspect-ratio:4/3; display:flex; align-items:center; justify-content:center; font-size:36px; }
  .gallery-tile-label {
    padding:4px 6px; font-size:9px; color:var(--text2); background:var(--panel2);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .gallery-list-row {
    display:grid; grid-template-columns:36px 1fr 80px 80px; align-items:center; gap:12px;
    padding:8px 10px; border-radius:6px; cursor:pointer; transition:background 0.1s;
    font-size:12px; border-bottom:1px solid var(--border);
  }
  .gallery-list-row:hover { background:var(--border); }
  .gallery-info-bar {
    border-top:1px solid var(--border); background:var(--panel2); padding:8px 14px;
    display:flex; align-items:center; gap:16px; flex-shrink:0; font-size:11px; color:var(--text2);
  }

  /* ══════════════════ WEATHER ══════════════════ */
  .weather-shell { flex:1; overflow-y:auto; background:linear-gradient(160deg,#0d1a2e 0%,#07060f 60%); display:flex; flex-direction:column; color:white; }
  .weather-search-bar {
    display:flex; align-items:center; gap:8px; padding:12px 16px;
    background:rgba(0,0,0,0.2); border-bottom:1px solid rgba(255,255,255,0.08); flex-shrink:0;
  }
  .weather-search-inp {
    flex:1; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.15);
    border-radius:20px; padding:7px 14px; color:white; font-family:'Inter',sans-serif; font-size:12px; outline:none; transition:border-color 0.15s;
  }
  .weather-search-inp::placeholder { color:rgba(255,255,255,0.4); }
  .weather-search-inp:focus { border-color:var(--accent); }
  .weather-hero { padding:24px 24px 16px; text-align:center; }
  .weather-anim-icon { font-size:80px; margin-bottom:4px; line-height:1; filter:drop-shadow(0 8px 24px rgba(0,0,0,0.5)); animation:float-icon 3s ease-in-out infinite; }
  @keyframes float-icon { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
  .weather-temp-big { font-size:64px; font-weight:100; color:white; line-height:1; letter-spacing:-2px; }
  .weather-feels { font-size:12px; color:rgba(255,255,255,0.5); margin-top:4px; }
  .weather-desc-big { font-size:18px; color:rgba(255,255,255,0.8); margin-top:6px; }
  .weather-location { font-size:12px; color:rgba(255,255,255,0.5); margin-top:4px; }
  .weather-stats {
    display:grid; grid-template-columns:repeat(4,1fr); gap:8px; padding:0 16px 16px;
  }
  .weather-stat {
    background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.1);
    border-radius:12px; padding:12px; text-align:center;
  }
  .weather-stat-ico { font-size:18px; margin-bottom:4px; }
  .weather-stat-val { font-size:16px; font-weight:700; color:white; }
  .weather-stat-label { font-size:9px; color:rgba(255,255,255,0.45); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px; }
  .weather-hourly {
    padding:0 16px 16px; overflow-x:auto; display:flex; gap:0;
    background:rgba(0,0,0,0.15); border-top:1px solid rgba(255,255,255,0.06);
    border-bottom:1px solid rgba(255,255,255,0.06); margin:0;
  }
  .weather-hour {
    flex-shrink:0; width:70px; padding:14px 0; text-align:center; cursor:pointer;
    transition:background 0.1s; border-right:1px solid rgba(255,255,255,0.05);
  }
  .weather-hour:hover { background:rgba(255,255,255,0.07); }
  .weather-hour.now { background:rgba(124,106,255,0.25); }
  .weather-hour .wh-time { font-size:10px; color:rgba(255,255,255,0.5); }
  .weather-hour .wh-ico  { font-size:20px; margin:6px 0; }
  .weather-hour .wh-temp { font-size:13px; font-weight:600; color:white; }
  .weather-hour .wh-rain { font-size:9px; color:#6affca; }
  .weather-forecast-section { padding:16px; }
  .weather-forecast-title { font-size:10px; font-weight:700; color:rgba(255,255,255,0.4); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }
  .forecast-row {
    display:grid; grid-template-columns:80px 1fr 80px 70px; align-items:center; gap:12px;
    padding:10px 4px; border-bottom:1px solid rgba(255,255,255,0.06);
  }
  .forecast-row:last-child { border-bottom:none; }
  .forecast-day { font-size:13px; color:rgba(255,255,255,0.85); font-weight:600; }
  .forecast-ico  { font-size:20px; }
  .forecast-bar-wrap { height:4px; background:rgba(255,255,255,0.12); border-radius:2px; position:relative; }
  .forecast-bar-fill { position:absolute; top:0; height:100%; background:linear-gradient(90deg,#6affca,#ffca6a); border-radius:2px; }
  .forecast-temps { font-size:12px; color:rgba(255,255,255,0.75); text-align:right; }
  .forecast-temps .low { color:rgba(255,255,255,0.35); margin-left:6px; }

  /* ══════════════════ CLOCK APP ══════════════════ */
  .clock-shell { flex:1; display:flex; flex-direction:column; overflow:hidden; background:var(--panel); }
  .clock-tabs { display:flex; border-bottom:1px solid var(--border); background:var(--panel2); flex-shrink:0; }
  .clock-tab {
    flex:1; padding:10px 4px; font-size:11px; font-weight:600; background:none; border:none;
    color:var(--text2); cursor:pointer; transition:all 0.12s; border-bottom:2px solid transparent;
    font-family:'Inter',sans-serif; text-align:center;
  }
  .clock-tab:hover { color:var(--text); }
  .clock-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
  .clock-pane { flex:1; overflow-y:auto; display:flex; flex-direction:column; align-items:center; padding:16px; gap:16px; }

  /* Analog clock */
  .analog-face {
    width:200px; height:200px; border-radius:50%; position:relative; flex-shrink:0;
    background:radial-gradient(circle at 35% 30%, #1e1e2e, #0d0d1a);
    border:3px solid rgba(124,106,255,0.3);
    box-shadow:0 0 0 1px rgba(124,106,255,0.1), 0 8px 40px rgba(0,0,0,0.6), inset 0 1px 1px rgba(255,255,255,0.05);
  }
  .clock-hand { position:absolute; bottom:50%; left:50%; transform-origin:bottom center; border-radius:3px; }
  .hand-hour   { width:4px; margin-left:-2px; background:var(--text); box-shadow:0 0 6px rgba(255,255,255,0.2); }
  .hand-min    { width:2.5px; margin-left:-1.25px; background:var(--accent); box-shadow:0 0 8px rgba(124,106,255,0.5); }
  .hand-sec    { width:1.5px; margin-left:-.75px; background:var(--accent2); box-shadow:0 0 6px rgba(255,80,120,0.6); }
  .clock-center { position:absolute; top:50%; left:50%; width:10px; height:10px; border-radius:50%; background:var(--accent2); transform:translate(-50%,-50%); z-index:10; }
  .clock-dot {
    position:absolute; width:4px; height:4px; background:rgba(255,255,255,0.5); border-radius:50%;
    top:50%; left:50%; transform-origin:center;
  }
  .clock-number {
    position:absolute; font-size:11px; font-weight:700; color:rgba(255,255,255,0.6);
    width:20px; text-align:center; top:50%; left:50%;
  }

  /* Digital display */
  .clock-digital {
    font-size:48px; font-weight:100; letter-spacing:4px; color:var(--text);
    font-variant-numeric:tabular-nums; line-height:1;
  }
  .clock-digital-sm { font-size:13px; color:var(--text2); text-align:center; margin-top:4px; letter-spacing:1px; }
  .clock-ampm { font-size:18px; color:var(--accent); margin-left:8px; font-weight:600; vertical-align:super; }

  /* World clocks */
  .world-clock-row {
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; background:var(--panel2); border:1px solid var(--border);
    border-radius:10px; width:100%; box-sizing:border-box; cursor:default;
    transition:border-color 0.15s;
  }
  .world-clock-row:hover { border-color:rgba(124,106,255,0.3); }
  .wc-city { font-size:13px; font-weight:600; color:var(--text); }
  .wc-tz { font-size:10px; color:var(--text2); margin-top:2px; }
  .wc-time { font-size:20px; font-weight:300; color:var(--accent); letter-spacing:2px; font-variant-numeric:tabular-nums; }
  .wc-offset { font-size:10px; color:var(--text2); text-align:right; margin-top:2px; }

  /* Stopwatch & timer */
  .sw-display { font-size:56px; font-weight:100; letter-spacing:4px; color:var(--text); font-variant-numeric:tabular-nums; line-height:1; }
  .sw-ms { font-size:28px; color:var(--accent); }
  .clock-btn-row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  .clock-btn {
    padding:10px 24px; border-radius:24px; border:1.5px solid var(--border);
    background:var(--panel2); color:var(--text); font-family:'Inter',sans-serif;
    font-size:12px; font-weight:600; cursor:pointer; transition:all 0.15s; min-width:90px;
  }
  .clock-btn:hover { border-color:var(--accent); color:var(--accent); }
  .clock-btn.primary { background:var(--accent); border-color:var(--accent); color:white; }
  .clock-btn.primary:hover { opacity:0.88; }
  .clock-btn.danger { border-color:var(--accent2); }
  .clock-btn.danger:hover { color:var(--accent2); }
  .laps-list { width:100%; max-height:120px; overflow-y:auto; display:flex; flex-direction:column; gap:2px; }
  .lap-row {
    display:flex; justify-content:space-between; padding:6px 12px;
    background:var(--panel2); border-radius:6px; font-size:11px;
    color:var(--text2); font-variant-numeric:tabular-nums;
  }
  .lap-row span:first-child { color:var(--text); font-weight:600; }

  /* Alarm */
  .alarm-row {
    display:flex; align-items:center; gap:12px; padding:12px 16px;
    background:var(--panel2); border:1px solid var(--border); border-radius:10px;
    width:100%; box-sizing:border-box;
  }
  .alarm-time-disp { font-size:22px; font-weight:300; color:var(--text); letter-spacing:2px; flex:1; }
  .alarm-label { font-size:11px; color:var(--text2); }
  .alarm-ring { animation:ring-pulse 0.3s ease-in-out infinite alternate; }
  @keyframes ring-pulse { from{transform:rotate(-8deg)} to{transform:rotate(8deg)} }

  /* Timer ring */
  .timer-ring-wrap { position:relative; width:180px; height:180px; flex-shrink:0; }
  .timer-ring-wrap svg { transform:rotate(-90deg); }
  .timer-ring-bg { fill:none; stroke:var(--border); stroke-width:8; }
  .timer-ring-fill { fill:none; stroke:var(--accent); stroke-width:8; stroke-linecap:round; transition:stroke-dashoffset 0.9s linear; }
  .timer-center-text { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .timer-ring-urgent { animation:ring-urgent 0.8s ease-in-out infinite; }
  @keyframes ring-urgent { 0%,100%{stroke:var(--accent2)} 50%{stroke:#ff0} }
</style>
</head>
<body>

<!-- ══ LOGIN SCREEN ══ -->
<div id="login-screen">
  <div class="login-stars"></div>
  <div class="login-time" id="login-time">00:00</div>
  <div class="login-date" id="login-date">Montag, 1. Januar</div>
  <div class="login-avatar">👤</div>
  <div class="login-name">Nova User</div>
  <div class="login-sub">NovOS 3.1 · Willkommen zurück</div>
  <button class="login-btn" onclick="doLogin()">Anmelden</button>
</div>

<!-- ══ DESKTOP ══ -->
<div id="desktop">

  <div class="icon-grid">
    <div class="desk-icon" ondblclick="openApp('files')">
      <div class="ico" style="background:linear-gradient(135deg,#1e3a5f,#0d2040)">📂</div>
      <span>Dateien</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('browser')">
      <div class="ico" style="background:linear-gradient(135deg,#1a2040,#0d0f2a)">🌐</div>
      <span>Browser</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('terminal')">
      <div class="ico" style="background:linear-gradient(135deg,#0f1f0f,#0a150a)">💻</div>
      <span>Terminal</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('music')">
      <div class="ico" style="background:linear-gradient(135deg,#3a1040,#1a0520)">🎵</div>
      <span>Musik</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('calc')">
      <div class="ico" style="background:linear-gradient(135deg,#1a3a20,#0a1f10)">🧮</div>
      <span>Rechner</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('editor')">
      <div class="ico" style="background:linear-gradient(135deg,#3a2a10,#1f1508)">📝</div>
      <span>Editor</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('gallery')">
      <div class="ico" style="background:linear-gradient(135deg,#2a1a3a,#150a20)">🖼️</div>
      <span>Galerie</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('weather')">
      <div class="ico" style="background:linear-gradient(135deg,#0d2a3a,#061520)">🌤️</div>
      <span>Wetter</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('sysmon')">
      <div class="ico" style="background:linear-gradient(135deg,#2a1a10,#150d08)">📊</div>
      <span>Monitor</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('settings')">
      <div class="ico" style="background:linear-gradient(135deg,#222,#111)">⚙️</div>
      <span>Einstellungen</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('pdf')">
      <div class="ico" style="background:linear-gradient(135deg,#3a0a0a,#1f0505)">📋</div>
      <span>NovPDF</span>
    </div>
    <div class="desk-icon" ondblclick="openApp('clock')">
      <div class="ico" style="background:linear-gradient(135deg,#0a1a3a,#050d1f)">🕐</div>
      <span>Uhr</span>
    </div>
  </div>

  <!-- Notifications -->
  <div id="notif-area"></div>

  <!-- Context Menu -->
  <div id="ctx-menu">
    <div class="ctx-item" onclick="cycleWallpaper();closeCtxMenu()">🖼️ Hintergrund ändern</div>
    <div class="ctx-item" onclick="openApp('files');closeCtxMenu()">📂 Neues Datei-Fenster</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item" onclick="showNotif('Desktop','Anzeige aktualisiert ✓');closeCtxMenu()">🔄 Aktualisieren</div>
    <div class="ctx-item" onclick="openApp('settings');closeCtxMenu()">⚙️ Einstellungen</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item danger" onclick="closeCtxMenu();doLogout()">🔴 Abmelden</div>
  </div>

  <!-- Start Menu -->
  <div id="start-menu">
    <div class="sm-header">NovOS 3.1</div>
    <input class="sm-search" type="text" placeholder="🔍 Apps durchsuchen..." id="sm-search-inp" oninput="filterStartMenu(this.value)">
    <div class="sm-section">Apps</div>
    <div class="sm-apps" id="sm-apps-grid">
      <div class="sm-app" data-app="terminal" onclick="openApp('terminal');closeStartMenu()"><span class="ico">💻</span><span class="name">Terminal</span></div>
      <div class="sm-app" data-app="files"    onclick="openApp('files');closeStartMenu()"><span class="ico">📂</span><span class="name">Dateien</span></div>
      <div class="sm-app" data-app="browser"  onclick="openApp('browser');closeStartMenu()"><span class="ico">🌐</span><span class="name">Browser</span></div>
      <div class="sm-app" data-app="music"    onclick="openApp('music');closeStartMenu()"><span class="ico">🎵</span><span class="name">Musik</span></div>
      <div class="sm-app" data-app="calc"     onclick="openApp('calc');closeStartMenu()"><span class="ico">🧮</span><span class="name">Rechner</span></div>
      <div class="sm-app" data-app="editor"   onclick="openApp('editor');closeStartMenu()"><span class="ico">📝</span><span class="name">Editor</span></div>
      <div class="sm-app" data-app="gallery"  onclick="openApp('gallery');closeStartMenu()"><span class="ico">🖼️</span><span class="name">Galerie</span></div>
      <div class="sm-app" data-app="weather"  onclick="openApp('weather');closeStartMenu()"><span class="ico">🌤️</span><span class="name">Wetter</span></div>
      <div class="sm-app" data-app="sysmon"   onclick="openApp('sysmon');closeStartMenu()"><span class="ico">📊</span><span class="name">Monitor</span></div>
      <div class="sm-app" data-app="settings" onclick="openApp('settings');closeStartMenu()"><span class="ico">⚙️</span><span class="name">Einstellungen</span></div>
      <div class="sm-app" data-app="pdf"      onclick="openApp('pdf');closeStartMenu()"><span class="ico">📋</span><span class="name">NovPDF</span></div>
      <div class="sm-app" data-app="clock"    onclick="openApp('clock');closeStartMenu()"><span class="ico">🕐</span><span class="name">NovUhr</span></div>
    </div>
    <div class="sm-footer">
      <div class="sm-footer-btn" onclick="closeStartMenu();showNotif('NovOS','Energie-Optionen...')">⚡ Energie</div>
      <div class="sm-footer-btn" onclick="closeStartMenu();doLogout()">🔴 Abmelden</div>
      <div class="sm-footer-btn" onclick="closeStartMenu();showNotif('NovOS','Neustart...')">🔄 Neustart</div>
    </div>
  </div>

  <!-- Taskbar -->
  <div id="taskbar">
    <div id="start-btn" onclick="toggleStartMenu()" title="Start">✦</div>
    <div class="taskbar-sep"></div>
    <div id="taskbar-apps"></div>
    <div id="tb-right">
      <div id="tb-icons">
        <span class="tb-icon" id="tb-wifi"   title="WLAN"      onclick="toggleCC()">📶</span>
        <span class="tb-icon" id="tb-vol"    title="Lautstärke" onclick="toggleCC()">🔊</span>
        <span class="tb-icon" id="tb-battery" title="Akku"     onclick="toggleCC()">🔋</span>
        <span class="tb-icon" id="tb-bat-pct" style="font-size:10px;font-weight:600;color:var(--text2);cursor:pointer" onclick="toggleCC()"></span>
      </div>
      <div style="text-align:right;cursor:pointer" onclick="toggleCC()" title="Kontrollzentrum">
        <div id="clock" style="pointer-events:none"></div>
        <div id="date-display" style="pointer-events:none"></div>
      </div>
    </div>
  </div>

  <!-- CONTROL CENTER -->
  <div id="control-center" style="
    position:absolute;bottom:calc(var(--taskbar-h) + 8px);right:12px;
    width:320px;background:rgba(14,14,24,0.97);backdrop-filter:blur(24px);
    border:1px solid var(--border);border-radius:16px;
    box-shadow:0 24px 80px rgba(0,0,0,0.7);padding:16px;
    z-index:2000;display:none;animation:fadeUp 0.18s ease;">
  </div>

<script>
// ══════════════════════════════════════
// CLOCK
// ══════════════════════════════════════
const DAYS = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
const MONTHS = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
const DAYS_SHORT = ['So','Mo','Di','Mi','Do','Fr','Sa'];

function updateClock() {
  const n = new Date();
  const h = String(n.getHours()).padStart(2,'0');
  const m = String(n.getMinutes()).padStart(2,'0');
  const timeStr = `${h}:${m}`;
  const dateStr = `${DAYS_SHORT[n.getDay()]}, ${n.getDate()}. ${MONTHS[n.getMonth()].slice(0,3)}`;

  const c = document.getElementById('clock');
  const d = document.getElementById('date-display');
  const lt = document.getElementById('login-time');
  const ld = document.getElementById('login-date');

  if(c) c.textContent = timeStr;
  if(d) d.textContent = dateStr;
  if(lt) lt.textContent = timeStr;
  if(ld) ld.textContent = `${DAYS[n.getDay()]}, ${n.getDate()}. ${MONTHS[n.getMonth()]}`;
}
setInterval(updateClock, 1000);
updateClock();

// ── Desktop icon grid: recalc row count on resize ──
function updateIconGrid() {
  const grid = document.querySelector('.icon-grid');
  if(!grid) return;
  // grid height is set by CSS (bottom: taskbar + 12px), so just
  // let CSS handle it — but we update --taskbar-h if needed
  const tbH = parseInt(getComputedStyle(document.documentElement)
    .getPropertyValue('--taskbar-h')) || 48;
  const avail = window.innerHeight - tbH - 24; // top 12 + bottom 12
  const rowH = 92; // 88px icon + 4px gap
  const rows = Math.max(1, Math.floor(avail / rowH));
  grid.style.gridTemplateRows = 'repeat(' + rows + ', 88px)';
}
window.addEventListener('resize', updateIconGrid);
// Will be called once desktop becomes visible (after login)

// ══════════════════════════════════════
// DIALOG SYSTEM (replaces prompt/confirm/alert)
// ══════════════════════════════════════
let _dlgResolve = null;

function novDialog({ icon='', title, msg='', input=false, inputDefault='', inputPlaceholder='',
                     confirmLabel='OK', cancelLabel='Abbrechen',
                     danger=false, alertOnly=false }) {
  return new Promise(resolve => {
    _dlgResolve = resolve;

    // Remove existing overlay
    document.getElementById('nov-dialog-overlay')?.remove();

    const overlay = document.createElement('div');
    overlay.id = 'nov-dialog-overlay';

    const inputHtml = input
      ? `<input class="dlg-input" id="dlg-input" type="text"
           value="${inputDefault.replace(/"/g,'&quot;')}"
           placeholder="${inputPlaceholder.replace(/"/g,'&quot;')}"
           onkeydown="if(event.key==='Enter')novDlgConfirm();if(event.key==='Escape')novDlgCancel()">`
      : '';

    const cancelBtn = alertOnly ? '' :
      `<button class="dlg-btn dlg-btn-secondary" onclick="novDlgCancel()">${cancelLabel}</button>`;

    const confirmBtn = `<button class="dlg-btn ${danger?'dlg-btn-danger':'dlg-btn-primary'}" id="dlg-confirm-btn" onclick="novDlgConfirm()">${confirmLabel}</button>`;

    overlay.innerHTML = `
      <div id="nov-dialog">
        ${icon ? `<div class="dlg-icon">${icon}</div>` : ''}
        <div class="dlg-title">${title}</div>
        ${msg ? `<div class="dlg-msg">${msg}</div>` : ''}
        ${inputHtml}
        <div class="dlg-btns">${cancelBtn}${confirmBtn}</div>
      </div>`;

    // Close on backdrop click (only for alert/non-destructive)
    overlay.addEventListener('click', e => {
      if(e.target === overlay) alertOnly ? novDlgConfirm() : novDlgCancel();
    });

    document.getElementById('desktop').appendChild(overlay);

    if(input) {
      setTimeout(() => {
        const inp = document.getElementById('dlg-input');
        if(inp) { inp.focus(); inp.select(); }
      }, 60);
    } else {
      setTimeout(() => document.getElementById('dlg-confirm-btn')?.focus(), 60);
    }
  });
}

function novDlgConfirm() {
  const inp = document.getElementById('dlg-input');
  const val = inp ? inp.value : true;
  document.getElementById('nov-dialog-overlay')?.remove();
  if(_dlgResolve) { _dlgResolve(val); _dlgResolve = null; }
}
function novDlgCancel() {
  document.getElementById('nov-dialog-overlay')?.remove();
  if(_dlgResolve) { _dlgResolve(null); _dlgResolve = null; }
}

// Keyboard ESC closes dialog
document.addEventListener('keydown', e => {
  if(e.key === 'Escape' && document.getElementById('nov-dialog-overlay')) novDlgCancel();
});

// ── Dialog helpers for inline-onclick calls ──────────
async function novDlgLogout() {
  const ok = await novDialog({
    icon:'🔒', title:'NovOS sperren',
    msg:'Möchtest du dich wirklich abmelden?',
    confirmLabel:'Abmelden', danger:true
  });
  if(!ok) return;
  doLogout(); toggleCC();
}
async function novDlgResetSettings() {
  const ok = await novDialog({
    icon:'⚙️', title:'Einstellungen zurücksetzen',
    msg:'Alle Einstellungen auf Standard zurücksetzen?',
    confirmLabel:'Zurücksetzen', danger:true
  });
  if(!ok) return;
  localStorage.removeItem('novos_settings');
  NovSettings = {...DEFAULT_SETTINGS};
  applyAllSettings();
  loadSettings('design');
  showNotif('Einstellungen','Zurückgesetzt ✓','#ff6a8a');
}
async function novDlgResetVFS() {
  const ok = await novDialog({
    icon:'🗑️', title:'Dateisystem zurücksetzen',
    msg:'Alle eigenen Dateien und Ordner gehen verloren.\nDiese Aktion kann nicht rückgängig gemacht werden.',
    confirmLabel:'Zurücksetzen', danger:true
  });
  if(!ok) return;
  localStorage.removeItem('novos_vfs');
  location.reload();
}
async function novDlgClearAll() {
  const ok = await novDialog({
    icon:'⚠️', title:'Alle Daten löschen',
    msg:'Alle gespeicherten Daten (Einstellungen, Dateien, Verlauf) löschen?\nDiese Aktion kann nicht rückgängig gemacht werden.',
    confirmLabel:'Alles löschen', danger:true
  });
  if(!ok) return;
  localStorage.clear();
  showNotif('Datenschutz','Alle Daten gelöscht','#ff6a8a');
}

// ══════════════════════════════════════
// CONTROL CENTER
// ══════════════════════════════════════
let ccOpen = false;
let ccBattery = null;
let ccVolume = 70;       // synced with NovSettings after load
let ccBrightness = 80;
let ccWifi = true;
let ccBluetooth = false;
let ccDnd = false;
let ccAirplane = false;

// Init Battery API
if(navigator.getBattery) {
  navigator.getBattery().then(bat => {
    ccBattery = bat;
    updateBatteryIcon();
    bat.addEventListener('levelchange', updateBatteryIcon);
    bat.addEventListener('chargingchange', updateBatteryIcon);
  });
}

function updateBatteryIcon() {
  if(!ccBattery) return;
  const pct = Math.round(ccBattery.level * 100);
  const charging = ccBattery.charging;
  const icon = charging ? '⚡' : pct > 80 ? '🔋' : pct > 40 ? '🪫' : '🪫';
  const el = document.getElementById('tb-battery');
  const pctEl = document.getElementById('tb-bat-pct');
  if(el) el.textContent = charging ? '⚡' : icon;
  if(pctEl) pctEl.textContent = pct + '%';
  // Update CC if open
  if(ccOpen) renderCC();
}

function toggleCC() {
  const cc = document.getElementById('control-center');
  if(!cc) return;
  ccOpen = !ccOpen;
  if(ccOpen) {
    // Close start menu if open
    document.getElementById('start-menu')?.classList.remove('open');
    renderCC();
    cc.style.display = 'block';
  } else {
    cc.style.display = 'none';
  }
}

function renderCC() {
  const cc = document.getElementById('control-center');
  if(!cc) return;

  // Battery info
  let batPct = 100, batCharging = false, batKnown = false;
  if(ccBattery) {
    batPct = Math.round(ccBattery.level * 100);
    batCharging = ccBattery.charging;
    batKnown = true;
  }
  const batColor = batPct > 60 ? '#2ecc71' : batPct > 20 ? '#f39c12' : '#e74c3c';
  const batIcon = batCharging ? '⚡' : batPct > 80 ? '🔋' : batPct > 30 ? '🪫' : '🪫';
  const batLabel = batKnown
    ? (batCharging ? 'Lädt… ' + batPct + '%' : batPct + '% – ' + (batPct > 80 ? 'Gut' : batPct > 30 ? 'Mittel' : 'Niedrig'))
    : 'Nicht verfügbar';

  const n = new Date();
  const timeStr = String(n.getHours()).padStart(2,'0') + ':' + String(n.getMinutes()).padStart(2,'0');
  const dateStr = DAYS[n.getDay()] + ', ' + n.getDate() + '. ' + MONTHS[n.getMonth()] + ' ' + n.getFullYear();

  cc.innerHTML = `
    <div style="text-align:center;margin-bottom:14px;border-bottom:1px solid var(--border);padding-bottom:12px">
      <div style="font-size:32px;font-weight:200;letter-spacing:-1px;color:var(--text)">${timeStr}</div>
      <div style="font-size:11px;color:var(--text2);margin-top:2px">${dateStr}</div>
    </div>

    <div class="cc-section">
      <div class="cc-label">Verbindungen</div>
      <div class="cc-tiles">
        <div class="cc-tile ${ccWifi?'on':''}" onclick="ccToggle('wifi',this)">
          <div class="cc-tile-icon">📶</div>
          <div class="cc-tile-name">WLAN</div>
          <div class="cc-tile-sub">${ccWifi?'NovNet-5G':'Aus'}</div>
        </div>
        <div class="cc-tile ${ccBluetooth?'on':''}" onclick="ccToggle('bt',this)">
          <div class="cc-tile-icon">🦷</div>
          <div class="cc-tile-name">Bluetooth</div>
          <div class="cc-tile-sub">${ccBluetooth?'An':'Aus'}</div>
        </div>
        <div class="cc-tile ${ccAirplane?'on':''}" onclick="ccToggle('airplane',this)">
          <div class="cc-tile-icon">✈️</div>
          <div class="cc-tile-name">Flugmodus</div>
          <div class="cc-tile-sub">${ccAirplane?'Aktiv':'Inaktiv'}</div>
        </div>
        <div class="cc-tile ${ccDnd?'on':''}" onclick="ccToggle('dnd',this)">
          <div class="cc-tile-icon">${ccDnd?'🔕':'🔔'}</div>
          <div class="cc-tile-name">Nicht stören</div>
          <div class="cc-tile-sub">${ccDnd?'An':'Aus'}</div>
        </div>
      </div>
    </div>

    <div class="cc-section">
      <div class="cc-label">Steuerung</div>
      <div class="cc-slider-row">
        <div class="cc-slider-icon">🔆</div>
        <input type="range" class="cc-slider" min="10" max="100" value="${ccBrightness}"
          oninput="ccBrightness=+this.value;document.getElementById('desktop').style.filter='brightness('+((ccBrightness/100)*0.4+0.6).toFixed(2)+')'">
        <div style="font-size:10px;color:var(--text2);width:28px;text-align:right">${ccBrightness}%</div>
      </div>
      <div class="cc-slider-row">
        <div class="cc-slider-icon" onclick="ccMuteToggle()" style="cursor:pointer">${ccVolume===0?'🔇':ccVolume<50?'🔉':'🔊'}</div>
        <input type="range" class="cc-slider" min="0" max="100" value="${ccVolume}"
          oninput="ccVolume=+this.value;setSetting('volume',ccVolume);this.previousElementSibling.textContent=ccVolume===0?'🔇':ccVolume<50?'🔉':'🔊';this.nextElementSibling.textContent=ccVolume+'%'">
        <div style="font-size:10px;color:var(--text2);width:28px;text-align:right">${ccVolume}%</div>
      </div>
    </div>

    <div class="cc-section">
      <div class="cc-label">Akku</div>
      <div style="background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:22px">${batIcon}</span>
            <div>
              <div style="font-size:13px;font-weight:700;color:var(--text)">${batKnown ? batPct+'%' : '–'}</div>
              <div style="font-size:10px;color:var(--text2)">${batLabel}</div>
            </div>
          </div>
          ${batCharging ? '<span style="font-size:11px;color:#2ecc71;font-weight:600">⚡ Lädt</span>' : ''}
        </div>
        ${batKnown ? `
        <div class="cc-bat-bar">
          <div class="cc-bat-fill" style="width:${batPct}%;background:${batColor}"></div>
        </div>` : '<div style="font-size:11px;color:var(--text2)">Battery API nicht unterstützt</div>'}
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border)">
      <button onclick="openApp('settings');toggleCC()" style="flex:1;padding:8px;background:var(--panel2);border:1px solid var(--border);border-radius:8px;color:var(--text2);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">⚙️ Einstellungen</button>
      <button onclick="novDlgLogout()" style="flex:1;padding:8px;background:var(--panel2);border:1px solid var(--border);border-radius:8px;color:var(--text2);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s" onmouseover="this.style.borderColor='var(--accent2)'" onmouseout="this.style.borderColor='var(--border)'">🔒 Sperren</button>
    </div>`;
}

function ccToggle(key, el) {
  if(key==='wifi')     { ccWifi=!ccWifi; setSetting('wifiEnabled',ccWifi); }
  if(key==='bt')       { ccBluetooth=!ccBluetooth; setSetting('bluetooth',ccBluetooth); }
  if(key==='airplane') { ccAirplane=!ccAirplane; if(ccAirplane){ccWifi=false;ccBluetooth=false;} }
  if(key==='dnd')      { ccDnd=!ccDnd; setSetting('doNotDisturb',ccDnd); }
  renderCC();
  // Close after a short delay so the toggle animation is visible
  setTimeout(() => {
    const cc = document.getElementById('control-center');
    if(cc) { ccOpen = false; cc.style.display = 'none'; }
  }, 350);
}

function ccMuteToggle() {
  ccVolume = ccVolume > 0 ? 0 : 70;
  setSetting('volume', ccVolume);
  renderCC();
}

// Close CC when clicking outside
document.addEventListener('click', e => {
  const cc = document.getElementById('control-center');
  if(!cc || !ccOpen) return;
  if(!cc.contains(e.target) && !e.target.closest('#tb-right')) {
    ccOpen = false;
    cc.style.display = 'none';
  }
});

// ══════════════════════════════════════════════════════
// PERSISTENT SETTINGS (localStorage) — defined early so
// loadNovSettings() can be called right after clock init
// ══════════════════════════════════════════════════════
const ACCENT_PRESETS = {
  lila:  { accent:'#7c6aff', accent2:'#ff6a8a', accent3:'#6affca' },
  blau:  { accent:'#3a8fff', accent2:'#6affca', accent3:'#ffca6a' },
  gruen: { accent:'#2ecc71', accent2:'#6affca', accent3:'#a78bfa' },
  pink:  { accent:'#ff6ab0', accent2:'#ff9f6a', accent3:'#6affca' },
  orange:{ accent:'#ff8c42', accent2:'#ff6a8a', accent3:'#6affca' },
  cyan:  { accent:'#00d4ff', accent2:'#ff6a8a', accent3:'#ffca6a' },
};
const WALLPAPER_PRESETS = [
  // Light presets (idx 0-3)
  'linear-gradient(135deg,#e8eaf6 0%,#f3e5f5 50%,#e3f2fd 100%)',
  'linear-gradient(135deg,#fce4ec 0%,#f3e5f5 50%,#e8eaf6 100%)',
  'linear-gradient(160deg,#e0f7fa 0%,#e8f5e9 50%,#f3e5f5 100%)',
  'linear-gradient(135deg,#fff8e1 0%,#fce4ec 50%,#f3e5f5 100%)',
  // Dark presets (idx 4-7)
  'radial-gradient(ellipse 80% 60% at 20% 80%,#1a0d3a 0%,transparent 60%),radial-gradient(ellipse 60% 80% at 80% 20%,#0d1f3a 0%,transparent 60%),#07060f',
  'radial-gradient(ellipse 80% 60% at 80% 20%,#0d3a1a 0%,transparent 60%),radial-gradient(ellipse 60% 80% at 20% 80%,#1a3a0d 0%,transparent 60%),#060f07',
  'radial-gradient(ellipse 80% 60% at 50% 10%,#3a0d1a 0%,transparent 60%),radial-gradient(ellipse 60% 80% at 50% 90%,#0d1a3a 0%,transparent 60%),#0f0607',
  'linear-gradient(135deg,#0a0a0f 0%,#1a0a2e 50%,#0a1a2e 100%)',
];
const DEFAULT_SETTINGS = {
  accentPreset: 'lila',
  wallpaperIdx: 0,
  darkMode: false,
  userName: 'Nova User',
  uiScale: '13px',
  animations: true,
  transparency: true,
  systemSounds: true,
  volume: 70,
  doNotDisturb: false,
  showClock: true,
  taskbarPos: 'bottom',
  notifBrowser: true,
  notifMusic: true,
  notifMail: true,
  wifiEnabled: true,
  bluetooth: false,
  vpn: false,
  telemetry: false,
  locationServices: true,
  browserHomepage: 'nov://start',
  browserSearch: 'DuckDuckGo',
};
let NovSettings = {};
function loadNovSettings() {
  try {
    const saved = JSON.parse(localStorage.getItem('novos_settings') || '{}');
    NovSettings = Object.assign({}, DEFAULT_SETTINGS, saved);
  } catch(e) { NovSettings = {...DEFAULT_SETTINGS}; }
  applyAllSettings();
}
function saveNovSettings() {
  try { localStorage.setItem('novos_settings', JSON.stringify(NovSettings)); } catch(e) {}
}
function setSetting(key, value) {
  NovSettings[key] = value;
  saveNovSettings();
  applyAllSettings();
}
function applyAllSettings() {
  // Sync CC state
  if(NovSettings.volume !== undefined) ccVolume = NovSettings.volume;
  const preset = ACCENT_PRESETS[NovSettings.accentPreset] || ACCENT_PRESETS.lila;
  const root = document.documentElement;
  root.style.setProperty('--accent', preset.accent);
  root.style.setProperty('--accent2', preset.accent2);
  root.style.setProperty('--accent3', preset.accent3);
  if(!NovSettings.darkMode) {
    root.style.setProperty('--bg','#f2f2f7');
    root.style.setProperty('--panel','#ffffff');
    root.style.setProperty('--panel2','#e8e8f0');
    root.style.setProperty('--border','#d0d0e0');
    root.style.setProperty('--text','#1c1c2e');
    root.style.setProperty('--text2','#6b6b8a');
  } else {
    root.style.setProperty('--bg','#0a0a0f');
    root.style.setProperty('--panel','#111118');
    root.style.setProperty('--panel2','#16161f');
    root.style.setProperty('--border','#2a2a3a');
    root.style.setProperty('--text','#e8e8f0');
    root.style.setProperty('--text2','#8888aa');
  }
  const wpEl = document.getElementById('desktop');
  if(wpEl) {
    // Auto-pick wallpaper based on mode if on default index
    const wpIdx = NovSettings.wallpaperIdx;
    wpEl.style.background = WALLPAPER_PRESETS[wpIdx % WALLPAPER_PRESETS.length];
  }
  document.body.style.fontSize = NovSettings.uiScale;
  const tb = document.getElementById('taskbar');
  if(tb) tb.style.background = NovSettings.darkMode ? 'rgba(10,10,20,0.85)' : 'rgba(255,255,255,0.75)';
  document.querySelectorAll('.login-name').forEach(el => el.textContent = NovSettings.userName);
  // Update login screen theme
  const ls = document.getElementById('login-screen');
  if(ls && !NovSettings.darkMode) {
    ls.style.background = 'linear-gradient(135deg,#e8eaf6 0%,#f3e5f5 60%,#e3f2fd 100%)';
  } else if(ls) {
    ls.style.background = '';
  }
  if(!NovSettings.animations) {
    const s = document.getElementById('anim-disable-style') || document.createElement('style');
    s.id = 'anim-disable-style';
    s.textContent = '* { animation:none!important; transition:none!important; }';
    document.head.appendChild(s);
  } else {
    document.getElementById('anim-disable-style')?.remove();
  }
}
function cycleWallpaper() {
  NovSettings.wallpaperIdx = (NovSettings.wallpaperIdx + 1) % WALLPAPER_PRESETS.length;
  saveNovSettings();
  applyAllSettings();
  showNotif('Desktop', 'Hintergrund geändert 🖼️');
}

// Load persistent settings immediately
loadNovSettings();

// ══════════════════════════════════════
// LOGIN
// ══════════════════════════════════════
function doLogin() {
  const ls = document.getElementById('login-screen');
  const desktop = document.getElementById('desktop');
  ls.classList.add('out');
  setTimeout(() => {
    ls.style.display = 'none';
    desktop.classList.add('visible');
    updateIconGrid();
    setTimeout(() => showNotif('NovOS 3.1', 'Willkommen, Nova User! 👋'), 400);
    setTimeout(() => showNotif('NovUpdate', '3 Updates verfügbar', '#6affca'), 2000);
  }, 600);
}
function doLogout() {
  const ls = document.getElementById('login-screen');
  const desktop = document.getElementById('desktop');
  [...Object.keys(windows)].forEach(id => closeWindow(id));
  musicPlaying=false; clearInterval(musicInterval);
  clearInterval(sysmonInterval);
  browserHistory=['nov://start']; browserPos=0;
  calcVal='0'; calcExpr=''; calcNewNum=true;
  desktop.classList.remove('visible');
  ls.style.display = 'flex';
  ls.classList.remove('out');
}

// ══════════════════════════════════════
// NOTIFICATIONS
// ══════════════════════════════════════
function showNotif(title, msg, color) {
  const area = document.getElementById('notif-area');
  const el = document.createElement('div');
  el.className = 'notif';
  if(color) el.style.borderLeftColor = color;
  el.innerHTML = `<div class="notif-title">${title}</div><div class="notif-msg">${msg}</div>`;
  area.appendChild(el);
  setTimeout(() => { el.classList.add('out'); setTimeout(()=>el.remove(),300); }, 3500);
}

// cycleWallpaper and wallpapers are defined in the SETTINGS section below

// ══════════════════════════════════════
// START MENU
// ══════════════════════════════════════
function toggleStartMenu() {
  const sm = document.getElementById('start-menu');
  const isOpen = sm.classList.contains('open');
  sm.classList.toggle('open', !isOpen);
  if(!isOpen) setTimeout(()=>document.getElementById('sm-search-inp')?.focus(),50);
}
function closeStartMenu() {
  document.getElementById('start-menu').classList.remove('open');
}
function filterStartMenu(q) {
  const items = document.querySelectorAll('#sm-apps-grid .sm-app');
  const query = q.toLowerCase();
  items.forEach(item => {
    const name = item.querySelector('.name').textContent.toLowerCase();
    item.style.display = (!query || name.includes(query)) ? 'flex' : 'none';
  });
}

// ══════════════════════════════════════
// CONTEXT MENU
// ══════════════════════════════════════
document.getElementById('desktop').addEventListener('contextmenu', e => {
  if(e.target.closest('.window') || e.target.closest('#taskbar')) return;
  e.preventDefault();
  const cm = document.getElementById('ctx-menu');
  cm.style.left = Math.min(e.clientX, window.innerWidth-210) + 'px';
  cm.style.top  = Math.min(e.clientY, window.innerHeight-200) + 'px';
  cm.classList.add('open');
});
document.addEventListener('click', e => {
  if(!e.target.closest('#ctx-menu')) closeCtxMenu();
  if(!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) closeStartMenu();
});
function closeCtxMenu() { document.getElementById('ctx-menu').classList.remove('open'); }

// ══════════════════════════════════════
// WINDOW SYSTEM
// ══════════════════════════════════════
let windows = {}, topZ = 10, isDragging = false, isResizing = false, dragData = {};

const appDefs = {
  terminal: { title:'Terminal',    icon:'💻', w:560, h:420 },
  files:    { title:'Dateien',     icon:'📂', w:640, h:440 },
  browser:  { title:'NovBrowser',  icon:'🌐', w:720, h:520 },
  music:    { title:'NovMusic',    icon:'🎵', w:340, h:520 },
  calc:     { title:'Rechner',     icon:'🧮', w:300, h:440 },
  editor:   { title:'TextEditor',  icon:'📝', w:600, h:460 },
  gallery:  { title:'Galerie',     icon:'🖼️', w:600, h:440 },
  weather:  { title:'Wetter',      icon:'🌤️', w:380, h:520 },
  sysmon:   { title:'Systemmonitor',icon:'📊',w:500, h:440 },
  settings: { title:'Einstellungen',icon:'⚙️',w:560, h:440 },
  pdf:      { title:'NovPDF',      icon:'📋', w:680, h:520 },
  clock:    { title:'NovUhr',      icon:'🕐', w:480, h:500 },
};

function openApp(app) {
  if(windows[app]) { focusWindow(app); return; }
  const def = appDefs[app];
  if(!def) return;
  const el = document.createElement('div');
  el.className = 'window focused';
  el.id = 'win-'+app;
  el.style.cssText = `width:${def.w}px;height:${def.h}px;left:${80+Math.random()*100}px;top:${50+Math.random()*80}px;z-index:${++topZ}`;
  el.innerHTML = `
    <div class="win-titlebar" id="tb-${app}">
      <div class="win-btns">
        <button class="win-btn btn-close" onclick="closeWindow('${app}')"></button>
        <button class="win-btn btn-min"   onclick="minimizeWindow('${app}')"></button>
        <button class="win-btn btn-max"   onclick="maximizeWindow('${app}')"></button>
      </div>
      <div class="win-title">${def.icon} ${def.title}</div>
    </div>
    <div class="win-body" id="body-${app}">${buildAppBody(app)}</div>
    <div class="resize-handle" id="rh-${app}"></div>`;
  document.getElementById('desktop').appendChild(el);
  windows[app] = { el, def, minimized:false };
  setupDrag(app); setupResize(app); addTaskbarBtn(app); focusWindow(app);
  if(app==='gallery')  setTimeout(()=>initGallery(),10);
  if(app==='weather')  setTimeout(()=>initWeather(),10);
  if(app==='browser')  setTimeout(()=>browserInit(),10);
  if(app==='terminal') setTimeout(()=>initTerminal(),10);
  if(app==='music')    setTimeout(()=>initMusic(),10);
  if(app==='files')    setTimeout(()=>{ fmRebuildMeta(); fmNavStack=['home']; fmNavPos=0; fmNavTo('home'); },50);
  if(app==='sysmon')   setTimeout(()=>initSysmon(),10);
  if(app==='editor')   setTimeout(()=>initEditor(),10);
  if(app==='settings') setTimeout(()=>initSettingsSidebar(),10);
  if(app==='pdf')      setTimeout(()=>initPDF(),10);
  if(app==='clock')    setTimeout(()=>initClock(),10);
}

function buildAppBody(id) {
  switch(id) {
    case 'terminal': return buildTerminal();
    case 'files':    return buildFiles();
    case 'browser':  return buildBrowser();
    case 'music':    return buildMusic();
    case 'calc':     return buildCalc();
    case 'editor':   return buildEditor();
    case 'gallery':  return buildGallery();
    case 'weather':  return buildWeather();
    case 'sysmon':   return buildSysmon();
    case 'settings': return buildSettings();
    case 'pdf':      return buildPDF();
    case 'clock':    return buildClock();
    default: return '<div style="padding:20px;color:var(--text2)">Laden...</div>';
  }
}

function closeWindow(id) {
  if(id==='music') { clearInterval(musicInterval); musicPlaying=false; }
  if(id==='sysmon') clearInterval(sysmonInterval);
  if(id==='clock')  { clearInterval(clockInterval); clearInterval(swInterval); clearInterval(timerInterval); }
  document.getElementById('win-'+id)?.remove();
  removeTaskbarBtn(id);
  delete windows[id];
}
function minimizeWindow(id) {
  const w = windows[id]; if(!w) return;
  w.el.style.display='none'; w.minimized=true;
  document.querySelector(`.tb-app[data-id="${id}"]`)?.classList.remove('active');
}
function maximizeWindow(id) {
  const w = windows[id]; if(!w) return;
  if(w.maximized) {
    const r = w.prevRect;
    w.el.style.left=r.l; w.el.style.top=r.t; w.el.style.width=r.w; w.el.style.height=r.h;
    w.maximized=false;
  } else {
    w.prevRect = { l:w.el.style.left, t:w.el.style.top, w:w.el.style.width, h:w.el.style.height };
    w.el.style.left='0'; w.el.style.top='0';
    w.el.style.width='100vw';
    w.el.style.height=`calc(100vh - ${getComputedStyle(document.documentElement).getPropertyValue('--taskbar-h')})`;
    w.maximized=true;
  }
}
function focusWindow(id) {
  document.querySelectorAll('.window').forEach(w=>w.classList.remove('focused'));
  document.querySelectorAll('.tb-app').forEach(b=>b.classList.remove('active'));
  const w = windows[id]; if(!w) return;
  w.el.style.zIndex=++topZ; w.el.classList.add('focused');
  w.el.style.display='flex'; w.minimized=false;
  document.querySelector(`.tb-app[data-id="${id}"]`)?.classList.add('active');
}
function addTaskbarBtn(id) {
  const def = appDefs[id];
  const btn = document.createElement('div');
  btn.className='tb-app active'; btn.dataset.id=id;
  btn.innerHTML=`${def.icon} ${def.title}`;
  btn.onclick=()=>{
    if(windows[id]?.minimized) focusWindow(id);
    else if(windows[id]?.el.classList.contains('focused')) minimizeWindow(id);
    else focusWindow(id);
  };
  document.getElementById('taskbar-apps').appendChild(btn);
}
function removeTaskbarBtn(id) {
  document.querySelector(`.tb-app[data-id="${id}"]`)?.remove();
}

function setupDrag(id) {
  document.getElementById('tb-'+id).addEventListener('mousedown', e => {
    if(e.target.classList.contains('win-btn')) return;
    focusWindow(id); isDragging=true;
    document.querySelectorAll('iframe').forEach(f=>f.style.pointerEvents='none');
    const r=document.getElementById('win-'+id).getBoundingClientRect();
    dragData={id, ox:e.clientX-r.left, oy:e.clientY-r.top}; e.preventDefault();
  });
}
document.addEventListener('mousemove', e => {
  if(isDragging) {
    const w=document.getElementById('win-'+dragData.id); if(!w) return;
    w.style.left=(e.clientX-dragData.ox)+'px';
    w.style.top=Math.max(0,e.clientY-dragData.oy)+'px';
  }
  if(isResizing) {
    const w=document.getElementById('win-'+dragData.id); if(!w) return;
    const r=w.getBoundingClientRect();
    w.style.width=Math.max(280,e.clientX-r.left)+'px';
    w.style.height=Math.max(200,e.clientY-r.top)+'px';
  }
});
document.addEventListener('mousedown', ()=>{
  // Disable iframes during any potential drag start so they don't steal events
  if(isDragging||isResizing) document.querySelectorAll('iframe').forEach(f=>f.style.pointerEvents='none');
});
document.addEventListener('mouseup',()=>{
  isDragging=false; isResizing=false;
  document.querySelectorAll('iframe').forEach(f=>f.style.pointerEvents='auto');
});

function setupResize(id) {
  document.getElementById('rh-'+id).addEventListener('mousedown', e=>{
    isResizing=true; dragData={id}; e.preventDefault(); e.stopPropagation();
  });
}
document.getElementById('desktop').addEventListener('mousedown', e=>{
  const w=e.target.closest('.window');
  if(w) focusWindow(w.id.replace('win-',''));
});

// ══════════════════════════════════════
// TERMINAL
// ══════════════════════════════════════
function buildTerminal() {
  return `
    <div class="terminal-body" id="term-output">
      <div class="terminal-line" style="color:var(--accent);font-weight:600">NovOS Terminal v3.1.0 — novsh 2.1</div>
      <div class="terminal-line terminal-out" style="color:var(--text2)">Angemeldet als <span style="color:var(--accent3)">user</span> · Tippe <span style="color:var(--accent)">'help'</span> für alle Befehle</div>
      <div class="terminal-line"> </div>
    </div>
    <div class="terminal-input-row">
      <span class="terminal-prompt-inp" id="term-prompt-lbl">user@novos:~$</span>
      <input class="terminal-input" id="term-input" type="text" autocomplete="off" spellcheck="false" placeholder="">
    </div>`;
}

const termHistory = []; let histIdx = -1;
let termCwd = 'home';

const termDirMap = { home:'~', docs:'~/Dokumente', pics:'~/Bilder', dl:'~/Downloads', vids:'~/Videos' };
function termPrompt() { return `user@novos:${termDirMap[termCwd]||('~/'+termCwd)}$`; }

function initTerminal() {
  const inp = document.getElementById('term-input'); if(!inp) return;
  inp.focus();
  inp.addEventListener('keydown', e => {
    if(e.key === 'Enter') {
      const cmd = inp.value.trim();
      if(cmd) { termHistory.unshift(cmd); histIdx = -1; }
      runTermCmd(cmd); inp.value = '';
    } else if(e.key === 'ArrowUp') {
      histIdx = Math.min(histIdx+1, termHistory.length-1);
      inp.value = termHistory[histIdx] || '';
    } else if(e.key === 'ArrowDown') {
      histIdx = Math.max(histIdx-1, -1);
      inp.value = histIdx === -1 ? '' : termHistory[histIdx];
    } else if(e.key === 'Tab') {
      e.preventDefault(); termAutocomplete(inp);
    } else if(e.key === 'l' && e.ctrlKey) {
      e.preventDefault(); document.getElementById('term-output').innerHTML = ''; 
    } else if(e.key === 'c' && e.ctrlKey) {
      e.preventDefault(); inp.value = '';
      termPrint('<span style="color:var(--accent2)">^C</span>', false);
    }
  });
  document.getElementById('term-prompt-lbl').textContent = termPrompt();
}

function termAutocomplete(inp) {
  const val = inp.value;
  const parts = val.trim().split(' ');
  const last = parts[parts.length-1];
  if(parts.length === 1) {
    const allCmds = ['help','ls','ll','pwd','cd','echo','date','uname','whoami','hostname','uptime','clear','neofetch','cat','edit','nano','touch','mkdir','rmdir','rm','cp','mv','find','grep','wc','head','tail','history','top','ps','kill','df','du','free','ping','curl','openapp','exit','printenv','env','alias','source','chmod','chown'];
    const match = allCmds.find(c => c.startsWith(last) && c !== last);
    if(match) inp.value = match;
  } else {
    const files = (vfs[termCwd]||[]).map(f => f.n);
    const match = files.find(f => f.startsWith(last) && f !== last);
    if(match) { parts[parts.length-1] = match; inp.value = parts.join(' '); }
  }
}

function termPrint(html, isCmd = false, cmdText = '') {
  const out = document.getElementById('term-output'); if(!out) return;
  const line = document.createElement('div');
  line.className = 'terminal-line' + (isCmd ? '' : ' terminal-out');
  if(isCmd) {
    line.innerHTML = `<span class="terminal-prompt">${termPrompt()}</span> <span class="terminal-cmd">${cmdText.replace(/</g,'&lt;')}</span>`;
  } else {
    line.innerHTML = html;
  }
  out.appendChild(line);
  out.scrollTop = out.scrollHeight;
  return line;
}

function runTermCmd(rawCmd) {
  const out = document.getElementById('term-output'); if(!out) return;
  if(rawCmd !== '') termPrint('', true, rawCmd);

  const cmd = rawCmd.trim();
  if(!cmd) return;

  // Parse pipes (basic)
  const parts = cmd.split('|').map(s => s.trim());
  let output = termExec(parts[0]);
  // simple grep pipe
  if(parts.length > 1) {
    for(let i=1; i<parts.length; i++) {
      const p = parts[i];
      if(p.startsWith('grep ')) {
        const pat = p.slice(5).trim().replace(/^['"]|['"]$/g,'');
        const lines = output.replace(/<[^>]+>/g,'').split('\n');
        output = lines.filter(l => l.includes(pat)).join('\n') || `<span style="color:var(--text2)">(keine Treffer)</span>`;
      } else if(p.startsWith('wc')) {
        const lines = output.replace(/<[^>]+>/g,'').split('\n');
        output = `${lines.length} Zeilen, ${output.replace(/<[^>]+>/g,'').split(/\s+/).filter(Boolean).length} Wörter`;
      }
    }
  }

  if(output !== null) termPrint(output);
  const lbl = document.getElementById('term-prompt-lbl');
  if(lbl) lbl.textContent = termPrompt();
}

function termExec(cmd) {
  const argv = cmd.match(/(?:[^\s"']+|"[^"]*"|'[^']*')+/g) || [];
  const arg0 = argv[0] || '';
  const args = argv.slice(1);
  const flag = args.find(a=>a.startsWith('-')) || '';
  const target = args.find(a=>!a.startsWith('-')) || '';

  const c = arg => arg.replace(/^['"]|['"]$/g,'');
  const color = (text, col) => `<span style="color:${col}">${text}</span>`;
  const bold = text => `<span style="font-weight:700;color:var(--text)">${text}</span>`;

  // ── Help ────────────────────────────────────────────
  if(arg0 === 'help') return `${color('NovOS Shell 2.1 — Verfügbare Befehle:','var(--accent)')}

${color('Navigation:','var(--accent3)')}  cd &lt;dir&gt;  ls [Optionen]  ll  pwd  find

${color('Dateien:','var(--accent3)')}     cat &lt;datei&gt;  head  tail  touch  mkdir  rmdir  rm  cp  mv  nano/edit

${color('System:','var(--accent3)')}      top  ps  kill &lt;pid&gt;  free  df  du  uptime  uname  hostname  neofetch

${color('Netzwerk:','var(--accent3)')}    ping &lt;host&gt;  curl &lt;url&gt;

${color('Sonstiges:','var(--accent3)')}   echo  date  whoami  history  clear  openapp &lt;app&gt;  printenv  alias

${color('Tipp:','var(--text2)')} Tab für Autovervollständigung · ↑↓ für Verlauf · Strg+L zum Leeren · Pipe | grep/wc`;

  // ── Navigation ──────────────────────────────────────
  if(arg0 === 'pwd') return `/home/user${termCwd==='home'?'':'/'+termCwd}`;
  if(arg0 === 'cd') {
    const dest = c(target);
    if(!dest || dest === '~' || dest === '/home/user') { termCwd='home'; return ''; }
    if(dest === '..') {
      const p = fmGetMeta(termCwd)?.parent || 'home';
      termCwd = p;
      return '';
    }
    // find dir in current
    const entry = (vfs[termCwd]||[]).find(f=>f.n===dest&&f.type==='dir');
    if(entry && entry.key && vfs[entry.key]) { termCwd=entry.key; return ''; }
    // top-level aliases
    const aliases = {docs:'docs','Dokumente':'docs',pics:'pics','Bilder':'pics',dl:'dl','Downloads':'dl',vids:'vids','Videos':'vids'};
    if(aliases[dest] && vfs[aliases[dest]]) { termCwd=aliases[dest]; return ''; }
    return color(`cd: ${dest}: Kein solches Verzeichnis`,'var(--accent2)');
  }

  // ── ls ──────────────────────────────────────────────
  if(arg0 === 'ls' || arg0 === 'll') {
    const dirKey = target && vfs[target] ? target : termCwd;
    const files = vfs[dirKey] || [];
    if(flag === '-la' || flag === '-l' || arg0==='ll') {
      const now = new Date();
      const dateStr = now.toLocaleDateString('de-DE',{day:'2-digit',month:'short'});
      return files.map(f=>{
        const isDir = f.type==='dir';
        const perm = isDir ? 'drwxr-xr-x' : (f.n.startsWith('.')? '-rw-------' : '-rw-r--r--');
        const size = isDir ? '4096' : Math.floor(Math.random()*50000+500)+'';
        return `${color(perm,'var(--text2)')}  ${color('user','var(--accent3)')} ${color('user','var(--accent3)')}  ${size.padStart(6)} ${dateStr}  ${isDir?color(f.n+'/','var(--accent)'):color(f.n,'var(--text)')}`;
      }).join('\n') || color('(leer)','var(--text2)');
    }
    if(flag === '-a') {
      return [color('.','var(--text2)'),color('..','var(--text2)'), ...files.map(f=>f.type==='dir'?color(f.n+'/','var(--accent)'):color(f.n,'var(--text)'))].join('  ');
    }
    if(files.length===0) return color('(leeres Verzeichnis)','var(--text2)');
    return files.map(f => f.type==='dir' ? color(f.n+'/','var(--accent)') : f.n).join('  ');
  }

  // ── find ────────────────────────────────────────────
  if(arg0 === 'find') {
    const needle = args.find(a=>a.startsWith('-name'))?args[args.indexOf(args.find(a=>a.startsWith('-name')))+1]:'';
    const results = [];
    for(const [dir,files] of Object.entries(vfs)) {
      files.forEach(f => {
        const path = `~/${dir==='home'?'':dir+'/'}${f.n}`;
        if(!needle || f.n.includes(c(needle).replace(/\*/g,''))) results.push(color(path,'var(--accent3)'));
      });
    }
    return results.length ? results.join('\n') : color('Keine Treffer','var(--text2)');
  }

  // ── cat / head / tail ───────────────────────────────
  if(arg0 === 'cat' || arg0 === 'head' || arg0 === 'tail') {
    const fname = c(target);
    if(!fname) return color(`${arg0}: Kein Dateiname angegeben`,'var(--accent2)');
    const path = Object.keys(vfsContents).find(k => k.endsWith('/'+fname));
    if(path) {
      let content = vfsContents[path];
      if(content.startsWith('data:')) return color(`${arg0}: ${fname}: Binärdatei (nicht lesbar)`,'var(--accent2)');
      const lines = content.split('\n');
      const shown = arg0==='head' ? lines.slice(0,10) : arg0==='tail' ? lines.slice(-10) : lines;
      return `<pre style="color:var(--accent3);white-space:pre-wrap;margin:0">${shown.join('\n').replace(/</g,'&lt;')}</pre>`;
    }
    return color(`${arg0}: ${fname}: Keine solche Datei`,'var(--accent2)');
  }

  // ── grep ────────────────────────────────────────────
  if(arg0 === 'grep') {
    const pat = c(args[0]||'');
    const fname = c(args[1]||'');
    if(!pat) return color('grep: Muster fehlt','var(--accent2)');
    const path = Object.keys(vfsContents).find(k => k.endsWith('/'+fname));
    if(!path && fname) return color(`grep: ${fname}: Keine solche Datei`,'var(--accent2)');
    const content = path ? vfsContents[path] : Object.values(vfsContents).join('\n');
    const lines = content.split('\n').filter(l=>l.includes(pat));
    if(!lines.length) return color('(keine Treffer)','var(--text2)');
    return lines.map(l=>`<span style="color:var(--text)">${l.replace(pat,`<span style="color:var(--accent2);font-weight:700">${pat}</span>`)}</span>`).join('\n');
  }

  // ── wc ──────────────────────────────────────────────
  if(arg0 === 'wc') {
    const fname = c(target);
    const path = Object.keys(vfsContents).find(k=>k.endsWith('/'+fname));
    if(!path) return color(`wc: ${fname}: Keine solche Datei`,'var(--accent2)');
    const t = vfsContents[path];
    const lines = t.split('\n').length;
    const words = t.trim().split(/\s+/).filter(Boolean).length;
    const chars = t.length;
    return `${color(lines,'var(--accent)')} Zeilen  ${color(words,'var(--accent3)')} Wörter  ${color(chars,'var(--text2)')} Zeichen  ${fname}`;
  }

  // ── touch / mkdir / rmdir ───────────────────────────
  if(arg0 === 'touch') {
    const fname = c(target);
    if(!fname) return color('touch: Dateiname fehlt','var(--accent2)');
    if(!vfs[termCwd].find(f=>f.n===fname)) {
      vfs[termCwd].push({ico:getFileIcon(fname,'txt'),n:fname,type:'txt'});
      vfsContents[termCwd+'/'+fname]='';
      vfsSave();
    }
    return '';
  }
  if(arg0 === 'mkdir') {
    const name = c(target);
    if(!name) return color('mkdir: Ordnername fehlt','var(--accent2)');
    if(vfs[termCwd].find(f=>f.n===name)) return color(`mkdir: ${name}: Existiert bereits`,'var(--accent2)');
    const key='dir_'+Date.now();
    vfs[key]=[];
    fmDirMeta[key]={label:name,icon:'📂',parent:termCwd};
    vfs[termCwd].push({ico:'📂',n:name,type:'dir',key});
    vfsSave();
    return '';
  }
  if(arg0 === 'rmdir') {
    const name = c(target);
    const entry = (vfs[termCwd]||[]).find(f=>f.n===name&&f.type==='dir');
    if(!entry) return color(`rmdir: ${name}: Kein solches Verzeichnis`,'var(--accent2)');
    if(entry.key && vfs[entry.key]?.length) return color(`rmdir: ${name}: Verzeichnis nicht leer`,'var(--accent2)');
    if(entry.key) { delete vfs[entry.key]; delete fmDirMeta[entry.key]; }
    vfs[termCwd].splice(vfs[termCwd].indexOf(entry),1);
    vfsSave();
    return '';
  }

  // ── rm ──────────────────────────────────────────────
  if(arg0 === 'rm') {
    const name = c(target);
    if(!name) return color('rm: Dateiname fehlt','var(--accent2)');
    const idx = (vfs[termCwd]||[]).findIndex(f=>f.n===name);
    if(idx<0) return color(`rm: ${name}: Keine solche Datei`,'var(--accent2)');
    if(flag==='-i') return color(`rm: Sicherheitshinweis: Nutze Dateimanager für interaktives Löschen`,'var(--text2)');
    if(vfs[termCwd][idx].type==='dir' && !flag.includes('r')) return color(`rm: ${name}: Ist ein Verzeichnis (rm -r für Ordner)`,'var(--accent2)');
    vfs[termCwd].splice(idx,1);
    delete vfsContents[termCwd+'/'+name];
    vfsSave();
    return color(`'${name}' entfernt`,'var(--accent3)');
  }

  // ── cp / mv ─────────────────────────────────────────
  if(arg0 === 'cp' || arg0 === 'mv') {
    const src = c(args[0]||''); const dst = c(args[1]||'');
    if(!src||!dst) return color(`${arg0}: Quelle und Ziel erforderlich`,'var(--accent2)');
    const entry = (vfs[termCwd]||[]).find(f=>f.n===src);
    if(!entry) return color(`${arg0}: ${src}: Keine solche Datei`,'var(--accent2)');
    const newEntry = {...entry, n:dst, ico:getFileIcon(dst,entry.type)};
    vfs[termCwd].push(newEntry);
    if(vfsContents[termCwd+'/'+src] !== undefined) vfsContents[termCwd+'/'+dst]=vfsContents[termCwd+'/'+src];
    if(arg0==='mv') { vfs[termCwd].splice(vfs[termCwd].indexOf(entry),1); delete vfsContents[termCwd+'/'+src]; }
    vfsSave();
    return color(`'${src}' → '${dst}' ${arg0==='mv'?'verschoben':'kopiert'}`,'var(--accent3)');
  }

  // ── nano / edit ─────────────────────────────────────
  if(arg0 === 'nano' || arg0 === 'edit') {
    const fname = c(target);
    if(!fname) return color(`${arg0}: Dateiname fehlt`,'var(--accent2)');
    const path = Object.keys(vfsContents).find(k=>k.endsWith('/'+fname));
    if(path) { const [dir,name]=path.split('/'); fmOpenTxt(dir,name); openApp('editor'); }
    else {
      vfs[termCwd].push({ico:getFileIcon(fname,'txt'),n:fname,type:'txt'});
      vfsContents[termCwd+'/'+fname]='';
      vfsSave();
      fmOpenTxt(termCwd,fname); openApp('editor');
    }
    return color(`${fname} in NovEdit geöffnet ✓`,'var(--accent3)');
  }

  // ── echo / printenv / env ───────────────────────────
  if(arg0 === 'echo') {
    const txt = args.join(' ').replace(/^['"]|['"]$/g,'');
    if(txt.startsWith('$')) {
      const envMap = { USER:'user', HOME:'/home/user', SHELL:'/bin/novsh', TERM:'xterm-256color', LANG:'de_DE.UTF-8', PATH:'/usr/local/bin:/usr/bin:/bin:/home/user/.local/bin', DISPLAY:':0', XDG_SESSION_TYPE:'x11' };
      return envMap[txt.slice(1)] || '';
    }
    return txt;
  }
  if(arg0 === 'printenv' || arg0 === 'env') {
    return ['USER=user','HOME=/home/user','SHELL=/bin/novsh','TERM=xterm-256color','LANG=de_DE.UTF-8','PATH=/usr/local/bin:/usr/bin:/bin:/home/user/.local/bin','DISPLAY=:0','XDG_SESSION_TYPE=x11','NOVOS_VERSION=3.1.0','NOVOS_DE=NovaShell'].map(e=>`<span style="color:var(--accent3)">${e.split('=')[0]}</span>=<span style="color:var(--text)">${e.split('=').slice(1).join('=')}</span>`).join('\n');
  }
  if(arg0 === 'alias') return ['alias ll=\'ls -la\'','alias la=\'ls -a\'','alias ..=\'cd ..\'','alias grep=\'grep --color=auto\'','alias cls=\'clear\''].map(a=>`<span style="color:var(--text2)">${a}</span>`).join('\n');

  // ── System info ─────────────────────────────────────
  if(arg0 === 'whoami') return color('user','var(--accent3)');
  if(arg0 === 'hostname') return color('novos-desktop','var(--accent)');
  if(arg0 === 'date') return new Date().toLocaleString('de-DE',{weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(arg0 === 'uname') {
    if(flag==='-a') return 'NovOS 3.1.0-nova #1 SMP PREEMPT '+new Date().toLocaleDateString('de-DE')+' x86_64 GNU/Linux';
    if(flag==='-r') return '3.1.0-nova';
    if(flag==='-m') return 'x86_64';
    return 'NovOS';
  }
  if(arg0 === 'uptime') {
    const h = Math.floor(Math.random()*48+1);
    const m = Math.floor(Math.random()*60);
    return ` ${new Date().toLocaleTimeString('de-DE')} up ${h}:${String(m).padStart(2,'0')},  1 user,  load average: ${(Math.random()*2).toFixed(2)}, ${(Math.random()*1.5).toFixed(2)}, ${(Math.random()).toFixed(2)}`;
  }
  if(arg0 === 'free') {
    const used = (Math.random()*4+2).toFixed(0);
    const total = 16384;
    const usedKB = parseInt(used)*1024;
    const freeKB = total*1024 - usedKB;
    return `              total        used        free      shared     buffers
${color('Speicher:','var(--text2)')}   ${String(total*1024).padStart(10)}  ${String(usedKB).padStart(10)}  ${String(freeKB).padStart(10)}       ${Math.floor(Math.random()*200+100)}       ${Math.floor(Math.random()*400+200)}
${color('Swap:','var(--text2)')}        8388608       24576     8364032`;
  }
  if(arg0 === 'df') {
    return `${color('Dateisystem      1K-Blöcke    Benutzt Verfügbar Verw% Eingehängt auf','var(--text2)')}
${color('/dev/nova0      524288000  134217728  390070272   26% /','var(--text)')}
${color('tmpfs             8388608     102400    8286208    2% /dev/shm','var(--text2)')}
${color('/dev/nova1       52428800    1048576   51380224    3% /boot','var(--text2)')}`;
  }
  if(arg0 === 'du') {
    const dir = termDirMap[termCwd] || '~';
    const size = Math.floor(Math.random()*50000+5000);
    return `${size}\t${dir}`;
  }

  // ── top / ps ────────────────────────────────────────
  if(arg0 === 'top') {
    const cpu = (Math.random()*40+5).toFixed(1);
    const ram = (Math.random()*4+2).toFixed(1);
    const procs = [
      ['novshell','1842','user',  (Math.random()*3).toFixed(1),  '184'],
      ['Xorg',    '1203','root',  (Math.random()*5+1).toFixed(1),'256'],
      ['NovBrow.','2891','user',  (Math.random()*12+2).toFixed(1),'512'],
      ['novd',    ' 892','root',  (Math.random()*2).toFixed(1),  ' 64'],
      ['audio-srv','1445','user', (Math.random()*2).toFixed(1),  ' 48'],
      ['net-mgr', '1120','root',  (Math.random()*1).toFixed(1),  ' 32'],
      ['NovEdit', '3104','user',  (Math.random()*3).toFixed(1),  '128'],
      ['sysmon',  '3201','user',  (Math.random()*1).toFixed(1),  ' 24'],
    ];
    return `${color(`top — ${new Date().toLocaleTimeString('de-DE')}  up 12:43,  1 user,  load: ${(cpu/40).toFixed(2)}`, 'var(--accent)')}
${color('Aufgaben:','var(--text2)')} ${color('142','var(--text)')} gesamt,  ${color('3','var(--accent3)')} laufend,  ${color('139','var(--text2)')} schlafend
${color(`%CPU: ${cpu}%  Mem: ${ram}GB/16GB  Swap: 0.2GB/8GB`,'var(--text2)')}

${color('  PID  USER     CPU%   MEM   Befehl','var(--text2)')}
${procs.map(([n,pid,usr,c,m])=>`${color(pid.padStart(5),'var(--accent3)')}  ${usr.padEnd(8)} ${color(c.padStart(5)+'%','var(--accent)')}  ${m.padStart(4)}M  ${bold(n)}`).join('\n')}`;
  }
  if(arg0 === 'ps') {
    const procs = [['1842','user','novshell'],['1203','root','Xorg'],['2891','user','NovBrowser'],['892','root','novd'],['1445','user','audio-srv'],['3104','user','NovEdit'],['3201','user','sysmon']];
    return `${color('  PID  USER     COMMAND','var(--text2)')}
${procs.map(([pid,usr,cmd])=>`${color(pid.padStart(5),'var(--accent3)')}  ${color(usr.padEnd(8),'var(--text2)')}  ${cmd}`).join('\n')}`;
  }
  if(arg0 === 'kill') {
    const pid = target;
    if(!pid) return color('kill: PID fehlt','var(--accent2)');
    return color(`kill: (${pid}) Prozess beendet`,'var(--accent3)');
  }

  // ── Network ─────────────────────────────────────────
  if(arg0 === 'ping') {
    const host = c(target) || 'localhost';
    const times = [8,12,11,9,10].map(t => t + Math.floor(Math.random()*3));
    return `${color(`PING ${host} (${host==='localhost'?'127.0.0.1':'93.184.216.34'}): 56 Byte Daten`,'var(--text)')}
${times.map((t,i)=>`64 Bytes von ${host}: icmp_seq=${i+1} ttl=64 ${color('Zeit='+t+' ms','var(--accent3)')}`).join('\n')}
${color(`--- ${host} Ping-Statistik ---`,'var(--text2)')}
5 Pakete übertragen, 5 empfangen, 0% Paketverlust
Umlaufzeiten: min/avg/max = ${Math.min(...times)}/${(times.reduce((a,b)=>a+b)/times.length).toFixed(1)}/${Math.max(...times)} ms`;
  }
  if(arg0 === 'curl') {
    const url = c(target);
    if(!url) return color('curl: URL fehlt','var(--accent2)');
    if(url.startsWith('nov://')) return color(`curl: ${url} — Internes Protokoll, nicht via curl erreichbar`,'var(--text2)');
    return color(`curl: (6) Konnte Host auflösen: '${url.replace(/https?:\/\//,'')}'  (Netzwerk deaktiviert in dieser Umgebung)`,'var(--accent2)');
  }

  // ── openapp ─────────────────────────────────────────
  if(arg0 === 'openapp') {
    const a = target;
    if(appDefs[a]) { openApp(a); return color(`${appDefs[a].title} geöffnet ✓`,'var(--accent3)'); }
    const all = Object.keys(appDefs).join(', ');
    return color(`App nicht gefunden: '${a}'\nVerfügbar: ${all}`,'var(--accent2)');
  }

  // ── history / clear / exit ───────────────────────────
  if(arg0 === 'history') {
    if(!termHistory.length) return color('(kein Verlauf)','var(--text2)');
    return termHistory.slice().reverse().map((c,i)=>`${color(String(i+1).padStart(4),'var(--text2)')}  ${c}`).join('\n');
  }
  if(arg0 === 'clear' || arg0 === 'cls') {
    document.getElementById('term-output').innerHTML = '';
    return null;
  }
  if(arg0 === 'exit' || arg0 === 'logout') {
    termPrint(color('Sitzung beendet.','var(--text2)'));
    return null;
  }

  // ── neofetch ────────────────────────────────────────
  if(arg0 === 'neofetch') {
    const cpu = (Math.random()*3+1.2).toFixed(1);
    const ram = (Math.random()*4+2).toFixed(1);
    const [c1,c2] = ['var(--accent)','var(--accent2)'];
    return `<pre style="line-height:1.6;margin:0">${color('      ✦✦✦✦✦✦','var(--accent)')}    ${bold('user@novos')}
${color('    ✦✦✦✦✦✦✦✦✦✦','var(--accent)')}  ${color('──────────────────','var(--border)')}
${color('   ✦✦✦✦✦✦✦✦✦✦✦✦✦','var(--accent)')} OS:       ${color('NovOS 3.1.0','var(--text)')}
${color('  ✦✦✦✦✦✦✦✦✦✦✦✦✦✦✦','var(--accent)')} Kernel:   ${color('nova-6.4.2-lts x86_64','var(--text)')}
${color('  ✦✦✦✦✦✦✦✦✦✦✦✦✦✦✦','var(--accent)')} Shell:    ${color('novsh 2.1','var(--text)')}
${color('   ✦✦✦✦✦✦✦✦✦✦✦✦✦','var(--accent)')} DE:       ${color('NovaShell 3.1','var(--text)')}
${color('    ✦✦✦✦✦✦✦✦✦✦','var(--accent)')}  Uptime:   ${color('12h 43m','var(--text)')}
${color('      ✦✦✦✦✦✦','var(--accent)')}    CPU:      ${color('Nova-Core i9 @ '+cpu+'GHz','var(--text)')}
              RAM:      ${color(ram+'GB / 16.0GB','var(--text)')}
              Display:  ${color('1920×1080 (60Hz)','var(--text)')}
              Terminal: ${color('NovTerm 3.1','var(--text)')}
              Locale:   ${color('de_DE.UTF-8','var(--text)')}</pre>`;
  }

  if(arg0 === 'chmod') return color('chmod: Berechtigungen geändert (simuliert)','var(--accent3)');
  if(arg0 === 'chown') return color('chown: Besitzer geändert (simuliert)','var(--accent3)');
  if(arg0 === 'source') return '';
  if(arg0 === 'which') return target ? color(`/usr/bin/${target}`,'var(--accent3)') : color('which: fehlender Argument','var(--accent2)');
  if(arg0 === 'man') return target ? color(`man ${target}: Keine Handbuchseite für '${target}'\nVerwende 'help' für NovOS-spezifische Hilfe`,'var(--text2)') : color('was manual? tippe help','var(--text2)');

  return color(`novsh: Befehl nicht gefunden: '${arg0}'\nHinweis: tippe 'help' für verfügbare Befehle`,'var(--accent2)');
}

// ══════════════════════════════════════
// VIRTUAL FILESYSTEM
// ══════════════════════════════════════
// ══════════════════════════════════════
// VIRTUAL FILE SYSTEM (persistent)
// ══════════════════════════════════════
const VFS_DEFAULT = {
  home: [
    {ico:'📂',n:'Dokumente',type:'dir',key:'docs'},
    {ico:'📂',n:'Bilder',type:'dir',key:'pics'},
    {ico:'📂',n:'Downloads',type:'dir',key:'dl'},
    {ico:'📂',n:'Videos',type:'dir',key:'vids'},
    {ico:'📝',n:'README.txt',type:'txt'},
    {ico:'⚙️',n:'config.json',type:'file'},
  ],
  docs: [
    {ico:'📝',n:'Notizen.txt',type:'txt'},
    {ico:'📝',n:'Ideen.txt',type:'txt'},
    {ico:'📝',n:'Tagebuch.txt',type:'txt'},
    {ico:'📄',n:'Brief.docx',type:'file'},
    {ico:'📊',n:'Statistik.xlsx',type:'file'},
    {ico:'📋',n:'Bericht.pdf',type:'pdf'},
  ],
  pics: [
    {ico:'🖼️',n:'Urlaub.png',type:'file'},
    {ico:'🖼️',n:'Profil.jpg',type:'file'},
    {ico:'🖼️',n:'Screenshot.png',type:'file'},
    {ico:'🎨',n:'Design.svg',type:'file'},
  ],
  dl: [
    {ico:'📦',n:'setup.exe',type:'file'},
    {ico:'🗜️',n:'Archiv.zip',type:'file'},
    {ico:'🎵',n:'Song.mp3',type:'file'},
    {ico:'🎬',n:'Film.mkv',type:'file'},
  ],
  vids: [
    {ico:'🎬',n:'Urlaub.mp4',type:'file'},
    {ico:'🎬',n:'Aufnahme.mkv',type:'file'},
    {ico:'🎥',n:'Tutorial.webm',type:'file'},
  ],
};
const VFS_CONTENTS_DEFAULT = {
  'home/README.txt': '# NovOS 3.1\n\nWillkommen in deinem Heimordner!\nDu kannst hier Dateien erstellen,\nbearbeiten und speichern.\n\n- Doppelklick öffnet .txt Dateien\n- Rechtsklick für mehr Optionen\n\nViel Spaß! ✦',
  'docs/Notizen.txt': 'Meine Notizen\n=============\n\n- NovOS ausprobieren ✓\n- Texteditor testen ✓\n- Neue Datei erstellen\n- Cloud-Sync einrichten\n',
  'docs/Ideen.txt': 'Projektideen\n============\n\n1. KI-Integration in NovEdit\n2. Dark Mode Varianten\n3. Cloud-Speicher erweitern\n4. Plugin-System entwickeln\n5. Mobile Version planen\n',
  'docs/Tagebuch.txt': new Date().toLocaleDateString('de-DE') + '\n\nHeute habe ich NovOS 3.1 ausprobiert.\nDer neue Texteditor gefällt mir sehr!\nBesonders das virtuelle Dateisystem\nist eine tolle Neuerung.\n',
};

function vfsLoad() {
  try {
    const saved = JSON.parse(localStorage.getItem('novos_vfs') || 'null');
    if(saved && saved.dirs && saved.contents) {
      Object.assign(vfs, saved.dirs);
      Object.assign(vfsContents, saved.contents);
    }
  } catch(e) {}
}
function vfsSave() {
  try {
    localStorage.setItem('novos_vfs', JSON.stringify({dirs: vfs, contents: vfsContents}));
  } catch(e) {}
}

// Rebuild fmDirMeta for any custom dirs found in VFS after load
function fmRebuildMeta() {
  // Walk all known dirs and find custom entries
  const knownBuiltin = new Set(['home','docs','pics','dl','vids']);
  for(const [parentKey, files] of Object.entries(vfs)) {
    for(const f of files) {
      if(f.type === 'dir' && f.key && !knownBuiltin.has(f.key)) {
        if(!fmDirMeta[f.key]) {
          fmDirMeta[f.key] = { label: f.n, icon: '📂', parent: parentKey };
        }
      }
    }
  }
}

// Initialize with defaults, then load saved state on top
const vfs = JSON.parse(JSON.stringify(VFS_DEFAULT)); // deep copy
const vfsContents = Object.assign({}, VFS_CONTENTS_DEFAULT);
vfsLoad(); // overlay with any saved data

// FILE MANAGER
function buildFiles() {
  return `
    <div class="fm-toolbar">
      <button class="editor-btn" id="fm-btn-back" onclick="fmBack()" title="Zurück">←</button>
      <button class="editor-btn" id="fm-btn-fwd"  onclick="fmFwd()"  title="Vor">→</button>
      <div class="fm-breadcrumb" id="fm-breadcrumb"></div>
      <button class="editor-btn" onclick="fmNewTxt()" title="Neue Textdatei">📝</button>
      <button class="editor-btn" onclick="fmNewFolder()" title="Neuer Ordner">📁</button>
      <button class="editor-btn" onclick="fmImportFile()" title="Datei importieren">📥</button>
    </div>
    <div style="display:flex;flex:1;overflow:hidden;min-height:0">
      <div class="fm-sidebar" id="fm-sidebar">
        <div class="fm-section">Orte</div>
        <div class="fm-item" data-fmkey="home"  onclick="fmNavTo('home')">🏠 Privat</div>
        <div class="fm-item" data-fmkey="docs"  onclick="fmNavTo('docs')">📄 Dokumente</div>
        <div class="fm-item" data-fmkey="pics"  onclick="fmNavTo('pics')">🖼️ Bilder</div>
        <div class="fm-item" data-fmkey="dl"    onclick="fmNavTo('dl')">⬇️ Downloads</div>
        <div class="fm-item" data-fmkey="vids"  onclick="fmNavTo('vids')">🎬 Videos</div>
        <div class="fm-section">Aktionen</div>
        <div class="fm-item" onclick="fmImportFile()">📥 Importieren</div>
        <div class="fm-item" onclick="showNotif('NovCloud','Verbunden – 12,4 GB frei ☁️','#6affca')">☁️ NovCloud</div>
      </div>
      <div class="fm-content" id="fm-content" oncontextmenu="fmBgCtx(event)">
        <div class="fm-grid" id="fm-grid"></div>
      </div>
    </div>
    <div id="fm-ctx">
      <div class="ctx-item" id="fmctx-open">📂 Öffnen</div>
      <div class="ctx-item" id="fmctx-rename">🏷️ Umbenennen</div>
      <div class="ctx-item" id="fmctx-download">💾 Herunterladen</div>
      <div class="ctx-sep"></div>
      <div class="ctx-item danger" id="fmctx-delete">🗑️ Löschen</div>
    </div>`;
}

// ── Navigation history ──────────────────────────────
let fmCurrentDir  = 'home';
let fmSelectedFile= null;
let fmHistory     = ['home'];   // breadcrumb trail of keys
let fmNavStack    = ['home'];   // back/forward stack
let fmNavPos      = 0;          // current position in stack

// Human-readable names & parent map
const fmDirMeta = {
  home: { label:'Privat',    icon:'🏠', parent:null },
  docs: { label:'Dokumente', icon:'📄', parent:'home' },
  pics: { label:'Bilder',    icon:'🖼️', parent:'home' },
  dl:   { label:'Downloads', icon:'⬇️', parent:'home' },
  vids: { label:'Videos',    icon:'🎬', parent:'home' },
};

function fmGetMeta(key) {
  return fmDirMeta[key] || { label: key, icon:'📂', parent: fmCurrentDir };
}

// Navigate to a dir key, push onto history
function fmNavTo(key, pushStack=true) {
  if(!vfs[key]) return;
  fmCurrentDir  = key;
  fmSelectedFile= null;
  if(pushStack) {
    // Truncate forward history
    fmNavStack = fmNavStack.slice(0, fmNavPos+1);
    fmNavStack.push(key);
    fmNavPos = fmNavStack.length - 1;
  }
  // Build breadcrumb trail (guard against cycles)
  fmHistory = [];
  let k = key;
  const seen = new Set();
  while(k && !seen.has(k)) {
    seen.add(k);
    fmHistory.unshift(k);
    k = fmGetMeta(k).parent;
  }
  fmRender();
}

function fmBack() {
  if(fmNavPos > 0) {
    fmNavPos--;
    fmNavTo(fmNavStack[fmNavPos], false);
  }
}
function fmFwd() {
  if(fmNavPos < fmNavStack.length-1) {
    fmNavPos++;
    fmNavTo(fmNavStack[fmNavPos], false);
  }
}

function fmRender() {
  // Update sidebar active state
  document.querySelectorAll('#fm-sidebar .fm-item[data-fmkey]').forEach(el => {
    el.classList.toggle('active', el.dataset.fmkey === fmCurrentDir);
  });

  // Update back/forward buttons
  const btnBack = document.getElementById('fm-btn-back');
  const btnFwd  = document.getElementById('fm-btn-fwd');
  if(btnBack) btnBack.disabled = fmNavPos <= 0;
  if(btnFwd)  btnFwd.disabled  = fmNavPos >= fmNavStack.length-1;

  // Update breadcrumb
  const bc = document.getElementById('fm-breadcrumb');
  if(bc) {
    bc.innerHTML = fmHistory.map((k, i) => {
      const meta = fmGetMeta(k);
      const isLast = i === fmHistory.length-1;
      return (i > 0 ? '<span class="fm-sep">›</span>' : '') +
        '<span class="fm-crumb' + (isLast?' current':'') + '"' +
        (isLast ? '' : ' onclick="fmNavTo(\'' + k + '\')"') + '>' +
        meta.icon + ' ' + meta.label + '</span>';
    }).join('');
  }

  // Render file grid
  const grid = document.getElementById('fm-grid');
  if(!grid) return;
  const files = vfs[fmCurrentDir] || [];

  if(files.length === 0) {
    grid.innerHTML = '<div class="fm-empty"><div style="font-size:48px">📂</div><div>Dieser Ordner ist leer</div><div style="font-size:11px">Rechtsklick zum Erstellen einer neuen Datei</div></div>';
    return;
  }

  // Sort: dirs first, then alphabetical
  const sorted = [...files].sort((a,b) => {
    if(a.type==='dir' && b.type!=='dir') return -1;
    if(a.type!=='dir' && b.type==='dir') return 1;
    return a.n.localeCompare(b.n);
  });

  grid.innerHTML = sorted.map((f, i) => {
    const sel = fmSelectedFile === f.n;
    return '<div class="fm-file' + (sel?' selected':'') + '" data-name="' + f.n + '" data-type="' + f.type + '"' +
      ' onclick="fmSelect(this)"' +
      ' ondblclick="fmOpen(\'' + f.n + '\',\'' + f.type + '\')"' +
      ' oncontextmenu="fmFileCtx(event,\'' + f.n + '\',\'' + f.type + '\')"' +
      ' title="' + f.n + '">' +
      '<div class="ico">' + f.ico + '</div>' +
      '<div class="name">' + f.n + '</div>' +
      '</div>';
  }).join('');
}

// loadDir is an alias kept for backward compat (editor, terminal call it)
function loadDir(key) { fmNavTo(key); }

function fmSelect(el) {
  document.querySelectorAll('#fm-grid .fm-file').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  fmSelectedFile = el.dataset.name;
}

function fmOpen(name, type) {
  if(type === 'dir') {
    // Find the key for this dir entry
    const entry = (vfs[fmCurrentDir]||[]).find(f => f.n===name && f.type==='dir');
    const key = (entry && entry.key) ? entry.key : null;
    // Register in fmDirMeta if not known
    if(key && !fmDirMeta[key]) {
      fmDirMeta[key] = { label:name, icon:'📂', parent:fmCurrentDir };
    }
    if(key && vfs[key]) { fmNavTo(key); return; }
    showNotif('Dateien', '"' + name + '" kann nicht geöffnet werden', '#ff6a8a');
    return;
  }
  if(type === 'txt') { fmOpenTxt(fmCurrentDir, name); return; }
  if(type === 'pdf') { pdfOpenFromVFS(fmCurrentDir, name); return; }
  if(/\.(png|jpg|jpeg|gif|svg|webp)$/i.test(name)) {
    showNotif('Galerie', '"' + name + '" – Bild öffnet sich in NovGalerie (bald)', '#ffca6a'); return;
  }
  if(/\.(mp3|wav|ogg|flac|aac)$/i.test(name)) {
    openApp('music'); showNotif('NovMusic', '"' + name + '" – Wiedergabe aus VFS bald verfügbar', '#6affca'); return;
  }
  showNotif('Dateien', '"' + name + '" – Kein Viewer für diesen Dateityp', '#ffca6a');
}

function fmOpenTxt(dirKey, name) {
  const path = dirKey + '/' + name;
  const content = vfsContents[path] || '';
  editorOpenFile(name, content, path);
}

// ── Context menu ──────────────────────────────────
let fmCtxTarget = null;

function fmFileCtx(e, name, type) {
  e.preventDefault(); e.stopPropagation();
  // Select the file (e.currentTarget is null in inline handlers — use closest)
  const el = e.target.closest('.fm-file');
  if(el) fmSelect(el);
  fmCtxTarget = { name, type, dir: fmCurrentDir };

  const ctx = document.getElementById('fm-ctx');
  if(!ctx) return;

  // Position
  const x = Math.min(e.clientX, window.innerWidth  - 200);
  const y = Math.min(e.clientY, window.innerHeight - 160);
  ctx.style.left    = x + 'px';
  ctx.style.top     = y + 'px';
  ctx.style.display = 'block';

  // Wire up items
  document.getElementById('fmctx-open').onclick   = () => { fmCtxClose(); fmOpen(name, type); };
  document.getElementById('fmctx-rename').onclick  = () => { fmCtxClose(); fmRename(fmCurrentDir, name); };
  document.getElementById('fmctx-download').onclick= () => { fmCtxClose(); fmDownload(fmCurrentDir, name, type); };
  document.getElementById('fmctx-delete').onclick  = () => { fmCtxClose(); fmDelete(fmCurrentDir, name); };
}

function fmBgCtx(e) {
  if(e.target.closest('.fm-file')) return;
  e.preventDefault();
  fmCtxClose();
  // Deselect
  document.querySelectorAll('#fm-grid .fm-file').forEach(el => el.classList.remove('selected'));
  fmSelectedFile = null;
}

function fmCtxClose() {
  const ctx = document.getElementById('fm-ctx');
  if(ctx) ctx.style.display = 'none';
}
// Register only once at top level
if(!window._fmCtxListenerSet) {
  window._fmCtxListenerSet = true;
  document.addEventListener('click', e => {
    if(!e.target.closest('#fm-ctx')) fmCtxClose();
  });
}

// ── File operations ──────────────────────────────
async function fmRename(key, oldName) {
  const newName = await novDialog({
    icon: '🏷️', title: 'Umbenennen',
    msg: 'Neuer Name für "' + oldName + '":',
    input: true, inputDefault: oldName,
    confirmLabel: 'Umbenennen'
  });
  if(!newName || newName === oldName) return;
  if(vfs[key].find(f => f.n === newName)) {
    showNotif('Dateien', '"' + newName + '" existiert bereits', '#ff6a8a'); return;
  }
  const f = vfs[key].find(x => x.n === oldName);
  if(!f) return;
  const oldPath = key + '/' + oldName;
  const newPath = key + '/' + newName;
  if(vfsContents[oldPath] !== undefined) {
    vfsContents[newPath] = vfsContents[oldPath];
    delete vfsContents[oldPath];
  }
  // If dir entry, update key label
  if(f.key && fmDirMeta[f.key]) fmDirMeta[f.key].label = newName;
  f.n   = newName;
  f.ico = getFileIcon(newName, f.type);
  fmSelectedFile = newName;
  fmRender();
  vfsSave();
  showNotif('Dateien', '"' + oldName + '" → "' + newName + '" ✓', '#6affca');
}

async function fmDelete(key, name) {
  const ok = await novDialog({
    icon: '🗑️', title: 'Löschen bestätigen',
    msg: '"' + name + '" wirklich löschen?\nDiese Aktion kann nicht rückgängig gemacht werden.',
    confirmLabel: 'Löschen', danger: true
  });
  if(!ok) return;
  const arr = vfs[key];
  const idx = arr.findIndex(x => x.n === name);
  if(idx >= 0) {
    const entry = arr[idx];
    // If it's a dir, also clean up its key
    if(entry.type === 'dir' && entry.key) {
      delete vfs[entry.key];
      delete fmDirMeta[entry.key];
    }
    arr.splice(idx, 1);
  }
  delete vfsContents[key + '/' + name];
  if(fmSelectedFile === name) fmSelectedFile = null;
  fmRender();
  vfsSave();
  showNotif('Dateien', '"' + name + '" gelöscht 🗑️', '#ff6a8a');
}

function fmDownload(key, name, type) {
  const path = key + '/' + name;
  const content = vfsContents[path];
  if(content !== undefined) {
    const blob = new Blob([content], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name; a.click();
    showNotif('Dateien', '"' + name + '" wird heruntergeladen 💾', '#6affca');
  } else {
    showNotif('Dateien', 'Kein Inhalt zum Herunterladen (Binärdatei)', '#ffca6a');
  }
}

async function fmNewTxt() {
  const name = await novDialog({
    icon: '📝', title: 'Neue Textdatei',
    msg: 'Dateiname:',
    input: true, inputDefault: 'Neue Datei.txt', inputPlaceholder: 'dateiname.txt',
    confirmLabel: 'Erstellen'
  });
  if(!name) return;
  const safeName = name.includes('.') ? name : name + '.txt';
  if(vfs[fmCurrentDir].find(f => f.n === safeName)) {
    showNotif('Dateien', '"' + safeName + '" existiert bereits', '#ff6a8a'); return;
  }
  vfs[fmCurrentDir].push({ico: getFileIcon(safeName, 'txt'), n:safeName, type:'txt'});
  vfsContents[fmCurrentDir + '/' + safeName] = '';
  fmSelectedFile = safeName;
  fmRender();
  vfsSave();
  showNotif('Dateien', '"' + safeName + '" erstellt ✓', '#6affca');
  setTimeout(() => fmOpenTxt(fmCurrentDir, safeName), 80);
}

async function fmNewFolder() {
  const name = await novDialog({
    icon: '📁', title: 'Neuer Ordner',
    msg: 'Ordnername:',
    input: true, inputDefault: 'Neuer Ordner', inputPlaceholder: 'Ordnername',
    confirmLabel: 'Erstellen'
  });
  if(!name) return;
  if(vfs[fmCurrentDir].find(f => f.n === name)) {
    showNotif('Dateien', '"' + name + '" existiert bereits', '#ff6a8a'); return;
  }
  const key = 'dir_' + Date.now();
  vfs[key] = [];
  fmDirMeta[key] = { label:name, icon:'📂', parent:fmCurrentDir };
  vfs[fmCurrentDir].push({ico:'📂', n:name, type:'dir', key});
  fmSelectedFile = name;
  fmRender();
  vfsSave();
  showNotif('Dateien', 'Ordner "' + name + '" erstellt 📂', '#6affca');
}

function fmImportFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.txt,.md,.json,.csv,.log,.xml,.html,.js,.py,.css,.ts,.sh,.yaml,.toml,.pdf';
  input.multiple = true;
  input.onchange = e => {
    const files = Array.from(e.target.files);
    let done = 0;
    let lastPdf = null;

    files.forEach(file => {
      const name = file.name;
      const isPdf = /\.pdf$/i.test(name);
      const isTxt = !isPdf && /\.(txt|md|json|csv|log|xml|html|js|py|css|ts|sh|yaml|toml)$/i.test(name);
      const type  = isPdf ? 'pdf' : isTxt ? 'txt' : 'file';

      const finish = content => {
        if(!vfs[fmCurrentDir].find(f => f.n === name)) {
          vfs[fmCurrentDir].push({ico: getFileIcon(name, type), n:name, type});
        } else {
          // update existing entry type in case it was 'file' before
          const f = vfs[fmCurrentDir].find(f => f.n === name);
          if(f) { f.type = type; f.ico = getFileIcon(name, type); }
        }
        if(isTxt || isPdf) vfsContents[fmCurrentDir + '/' + name] = content;
        if(isPdf) lastPdf = name;
        done++;
        if(done === files.length) {
          fmRender();
          vfsSave();
          showNotif('Dateien', done + ' Datei(en) importiert ✓', '#6affca');
          // Auto-open: single txt in editor, single pdf in NovPDF
          if(files.length === 1 && isTxt)  setTimeout(() => fmOpenTxt(fmCurrentDir, name), 120);
          if(files.length === 1 && lastPdf) setTimeout(() => pdfOpenFromVFS(fmCurrentDir, lastPdf), 120);
        }
      };

      if(isPdf) {
        // Read as ArrayBuffer, convert to base64 for storage
        const reader = new FileReader();
        reader.onload = ev => {
          const ab = ev.target.result;
          const bytes = new Uint8Array(ab);
          let binary = '';
          for(let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
          finish('data:application/pdf;base64,' + btoa(binary));
        };
        reader.readAsArrayBuffer(file);
      } else {
        const reader = new FileReader();
        reader.onload = ev => finish(ev.target.result);
        reader.readAsText(file);
      }
    });
  };
  input.click();
}

function getFileIcon(name, type) {
  if(type==='dir')  return '📂';
  const n = name.toLowerCase();
  if(/\.(txt|md|log|readme)$/.test(n)) return '📝';
  if(/\.(json|xml|yaml|toml|ini|cfg|conf)$/.test(n)) return '⚙️';
  if(/\.(html|htm|css|js|ts|jsx|tsx|vue)$/.test(n)) return '🌐';
  if(/\.(py|rb|php|java|c|cpp|cs|go|rs|sh|bat)$/.test(n)) return '💻';
  if(/\.(png|jpg|jpeg|gif|svg|webp|ico|bmp)$/.test(n)) return '🖼️';
  if(/\.(mp3|wav|ogg|flac|aac|m4a)$/.test(n)) return '🎵';
  if(/\.(mp4|mkv|webm|avi|mov|wmv)$/.test(n)) return '🎬';
  if(/\.(pdf)$/.test(n)) return '📋';
  if(/\.(zip|rar|tar|gz|7z)$/.test(n)) return '🗜️';
  if(/\.(exe|msi|dmg|appimage)$/.test(n)) return '📦';
  if(/\.(doc|docx)$/.test(n)) return '📃';
  if(/\.(xls|xlsx|csv)$/.test(n)) return '📊';
  if(/\.(ppt|pptx)$/.test(n)) return '📑';
  return '📄';
}

// ══════════════════════════════════════
// ══════════════════════════════════════
// BROWSER (MULTI-TAB + REAL IFRAME)
// ══════════════════════════════════════
let browserTabsData = [];
let browserActiveTab = null;
let browserBookmarks = [];
let browserNextTabId = 1;

function browserLoadState() {
  try {
    const s = JSON.parse(localStorage.getItem('novos_browser') || '{}');
    browserBookmarks = s.bookmarks || [
      {title:'NovOS Start', url:'nov://start'},
      {title:'Nachrichten', url:'nov://news'},
      {title:'NovStore', url:'nov://store'},
    ];
    browserTabsData = s.tabs || [];
    if(!browserTabsData.length) {
      browserTabsData = [{id:'t1', url:'nov://start', title:'NovBrowser', favicon:'✦', history:['nov://start'], histPos:0}];
    }
    browserActiveTab = s.activeTab || browserTabsData[0].id;
    // Ensure activeTab actually exists
    if(!browserTabsData.find(t=>t.id===browserActiveTab)) browserActiveTab = browserTabsData[0].id;
    browserNextTabId = Math.max(...browserTabsData.map(t=>parseInt(t.id.replace('t',''))||0), 1) + 1;
  } catch(e) {
    browserTabsData = [{id:'t1', url:'nov://start', title:'NovBrowser', favicon:'✦', history:['nov://start'], histPos:0}];
    browserActiveTab = 't1'; browserBookmarks = []; browserNextTabId = 2;
  }
}

function browserSaveState() {
  try {
    // Don't persist iframe-loaded tabs (security/size), just mark them
    const saveTabs = browserTabsData.map(t => ({...t, history: t.history.slice(-10)}));
    localStorage.setItem('novos_browser', JSON.stringify({tabs: saveTabs, activeTab: browserActiveTab, bookmarks: browserBookmarks}));
  } catch(e) {}
}

function buildBrowser() {
  browserLoadState();
  return `
    <div id="br-tabs-bar" style="display:flex;align-items:center;background:var(--panel2);border-bottom:1px solid var(--border);overflow-x:auto;flex-shrink:0;min-height:36px;scrollbar-width:none;"></div>
    <div class="browser-bar">
      <button class="browser-nav-btn" id="br-back-btn" onclick="browserBack()" title="Zurück (Alt+←)">‹</button>
      <button class="browser-nav-btn" id="br-fwd-btn"  onclick="browserFwd()"  title="Vor (Alt+→)">›</button>
      <button class="browser-nav-btn" id="br-reload-btn" onclick="browserRefresh()" title="Neu laden (F5)">↻</button>
      <button class="browser-nav-btn" onclick="browserHome()" title="Startseite">⌂</button>
      <div style="display:flex;align-items:center;flex:1;background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:0 10px;gap:6px;transition:border-color 0.15s" id="br-url-wrap"
           onfocusin="this.style.borderColor='var(--accent)'" onfocusout="this.style.borderColor='var(--border)'">
        <span id="br-security-icon" style="font-size:11px;color:var(--accent3);flex-shrink:0;cursor:default" title="Verbindungsstatus">✦</span>
        <input class="browser-url" id="browser-url" style="border:none;background:transparent;border-radius:0;padding:5px 0;flex:1;outline:none;font-size:12px;color:var(--text);" value="nov://start"
          onkeydown="if(event.key==='Enter'){browserGo(this.value.trim())}"
          onfocus="this.select()">
      </div>
      <button class="browser-nav-btn" onclick="browserAddBookmark()" title="Lesezeichen hinzufügen">🔖</button>
      <button class="browser-nav-btn" onclick="browserGo('nov://bookmarks')" title="Alle Lesezeichen">📚</button>
      <button class="browser-nav-btn" onclick="browserNewTab()" title="Neuer Tab">+</button>
    </div>
    <div id="browser-main" style="flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0;">
      <div id="browser-novpage" style="flex:1;overflow-y:auto;min-height:0;"></div>
      <div id="browser-iframe-wrap" style="flex:1;min-height:0;position:relative;display:none;">
        <div id="browser-loading-bar" style="position:absolute;top:0;left:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%;transition:width 0.4s ease;z-index:5;pointer-events:none;"></div>
        <iframe id="browser-iframe" style="width:100%;height:100%;border:none;" referrerpolicy="no-referrer"></iframe>
      </div>
      <div id="browser-error-page" style="flex:1;overflow-y:auto;min-height:0;display:none;"></div>
    </div>`;
}

function browserInit() {
  browserRebuildTabs();
  const tab = browserTabsData.find(t=>t.id===browserActiveTab) || browserTabsData[0];
  browserNavigateTo(tab.url, false);
}

function browserRebuildTabs() {
  const bar = document.getElementById('br-tabs-bar');
  if(!bar) return;
  bar.innerHTML = browserTabsData.map(tab => {
    const active = tab.id === browserActiveTab;
    const title = (tab.favicon||'') + ' ' + (tab.title||'Neuer Tab');
    return `<div onclick="browserSwitchTab('${tab.id}')" title="${tab.title||''}" style="
        display:inline-flex;align-items:center;gap:5px;padding:0 10px;height:36px;cursor:pointer;
        white-space:nowrap;border-right:1px solid var(--border);flex-shrink:0;
        min-width:80px;max-width:160px;
        background:${active?'var(--panel)':'transparent'};
        color:${active?'var(--text)':'var(--text2)'};
        border-bottom:2px solid ${active?'var(--accent)':'transparent'};
        font-size:11px;transition:background 0.1s;">
      <span style="overflow:hidden;text-overflow:ellipsis;flex:1;pointer-events:none">${title}</span>
      <span onclick="browserCloseTab(event,'${tab.id}')"
        style="flex-shrink:0;width:14px;height:14px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:10px;opacity:0.4;transition:opacity 0.1s,background 0.1s;"
        onmouseover="this.style.opacity=1;this.style.background='var(--border)'"
        onmouseout="this.style.opacity=0.4;this.style.background='none'">✕</span>
    </div>`;
  }).join('');
}

function browserGetActiveTab() {
  return browserTabsData.find(t=>t.id===browserActiveTab);
}

function browserNewTab(url) {
  const id = 't' + (browserNextTabId++);
  const u = url || NovSettings.browserHomepage || 'nov://start';
  browserTabsData.push({id, url:u, title:'Neuer Tab', favicon:'', history:[u], histPos:0});
  browserActiveTab = id;
  browserRebuildTabs();
  browserNavigateTo(u, false);
  browserSaveState();
}

function browserSwitchTab(id) {
  if(browserActiveTab === id) return;
  browserActiveTab = id;
  browserRebuildTabs();
  const tab = browserTabsData.find(t=>t.id===id);
  if(tab) browserNavigateTo(tab.url, false);
}

function browserCloseTab(e, id) {
  e.stopPropagation();
  if(browserTabsData.length <= 1) {
    // Keep one tab but go to start
    const tab = browserTabsData[0];
    tab.url = 'nov://start'; tab.title = 'NovBrowser'; tab.favicon = '✦';
    tab.history = ['nov://start']; tab.histPos = 0;
    browserNavigateTo('nov://start', false);
    browserRebuildTabs();
    return;
  }
  const idx = browserTabsData.findIndex(t=>t.id===id);
  browserTabsData.splice(idx, 1);
  if(browserActiveTab === id) {
    const next = browserTabsData[Math.min(idx, browserTabsData.length-1)];
    browserActiveTab = next.id;
    browserNavigateTo(next.url, false);
  }
  browserRebuildTabs();
  browserSaveState();
}

function browserGo(raw) {
  let url = (raw||'').trim();
  if(!url) return;
  // nov:// → internal
  if(url.startsWith('nov://')) { /* keep */ }
  // has :// already
  else if(url.includes('://')) { /* keep */ }
  // looks like a domain (contains dot, no spaces)
  else if(/^[a-zA-Z0-9-]+\.[a-zA-Z]{2,}/.test(url) && !url.includes(' ')) {
    url = 'https://' + url;
  }
  // search
  else {
    const engines = {
      'DuckDuckGo':'https://duckduckgo.com/?q=',
      'Google':'https://www.google.com/search?q=',
      'Bing':'https://www.bing.com/search?q=',
      'Ecosia':'https://www.ecosia.org/search?q=',
      'Startpage':'https://www.startpage.com/search?q=',
    };
    const base = engines[NovSettings.browserSearch] || engines.DuckDuckGo;
    url = base + encodeURIComponent(url);
  }
  const tab = browserGetActiveTab();
  if(tab) {
    tab.history = tab.history.slice(0, tab.histPos+1);
    tab.history.push(url);
    tab.histPos = tab.history.length - 1;
    tab.url = url;
  }
  browserNavigateTo(url, true);
  browserSaveState();
}

function browserNavigateTo(url, pushState) {
  // Update address bar
  const urlInp = document.getElementById('browser-url');
  if(urlInp) urlInp.value = url;
  // Security icon
  const sec = document.getElementById('br-security-icon');
  if(sec) {
    if(url.startsWith('https://'))    { sec.textContent='🔒'; sec.style.color='var(--accent3)'; sec.title='Sichere Verbindung'; }
    else if(url.startsWith('http://')) { sec.textContent='⚠️'; sec.style.color='var(--accent2)'; sec.title='Nicht sicher'; }
    else                               { sec.textContent='✦'; sec.style.color='var(--accent)'; sec.title='NovOS Intern'; }
  }

  const novpage   = document.getElementById('browser-novpage');
  const iframeWrap= document.getElementById('browser-iframe-wrap');
  const iframe    = document.getElementById('browser-iframe');
  const errPage   = document.getElementById('browser-error-page');
  if(!novpage) return;

  const isInternal = url.startsWith('nov://') || !url.includes('://');

  if(isInternal) {
    novpage.style.display = 'block';
    if(iframeWrap) iframeWrap.style.display = 'none';
    if(errPage)    errPage.style.display = 'none';
    if(iframe)     iframe.src = 'about:blank';
    novpage.innerHTML = browserPage(url);
    browserSetTabMeta(url);
    return;
  }

  // External URL — many sites block iframes via X-Frame-Options.
  // Strategy: show a "blocked" page immediately with option to open in real tab.
  // For sites that DO work in iframes, we still try and show them.
  novpage.style.display = 'none';
  if(errPage) errPage.style.display = 'none';

  browserSetTabMeta(url);

  // Show blocked page right away for known frame-blocking sites
  const knownBlocked = ['bing.com','google.com','google.de','youtube.com','twitter.com','x.com',
    'facebook.com','instagram.com','linkedin.com','amazon.de','amazon.com','netflix.com',
    'ebay.com','ebay.de','paypal.com','apple.com','microsoft.com','github.com'];
  const hostname = (() => { try { return new URL(url).hostname; } catch(e) { return ''; } })();
  const isKnownBlocked = knownBlocked.some(d => hostname.endsWith(d));

  if(isKnownBlocked) {
    if(iframeWrap) iframeWrap.style.display = 'none';
    browserShowBlocked(url, hostname);
    return;
  }

  // For unknown sites, try iframe with timeout fallback
  if(!iframeWrap || !iframe) return;
  iframeWrap.style.display = 'block';

  const bar = document.getElementById('browser-loading-bar');
  if(bar) { bar.style.transition='none'; bar.style.width='0%'; requestAnimationFrame(()=>{ bar.style.transition='width 0.6s ease'; bar.style.width='75%'; }); }

  let handled = false;
  const onBlocked = () => {
    if(handled) return; handled = true;
    iframeWrap.style.display = 'none';
    if(bar) { bar.style.width='0%'; }
    browserShowBlocked(url, hostname);
  };
  const onLoaded = () => {
    if(handled) return; handled = true;
    if(bar) { bar.style.width='100%'; setTimeout(()=>bar.style.width='0%', 600); }
    try { const t=iframe.contentDocument?.title; if(t){const tab=browserGetActiveTab();if(tab){tab.title=t.slice(0,30);tab.favicon='🌐';browserRebuildTabs();}}} catch(e){}
  };

  iframe.onload = onLoaded;
  iframe.onerror = onBlocked;
  const timer = setTimeout(onBlocked, 5000);
  iframe.addEventListener('load', ()=>clearTimeout(timer), {once:true});
  try { iframe.src = url; } catch(ex) { onBlocked(); }
}

function browserShowBlocked(url, hostname) {
  const errPage = document.getElementById('browser-error-page');
  const iframeWrap = document.getElementById('browser-iframe-wrap');
  const novpage = document.getElementById('browser-novpage');
  if(novpage) novpage.style.display = 'none';
  if(iframeWrap) iframeWrap.style.display = 'none';
  if(!errPage) return;
  errPage.style.display = 'block';

  const siteInfo = {
    'bing.com':      ['🔍','Bing','Microsofts Suchmaschine & KI-Chat'],
    'google.com':    ['🔍','Google','Websuche, Bilder, Maps'],
    'google.de':     ['🔍','Google Deutschland','Websuche auf Deutsch'],
    'youtube.com':   ['▶️','YouTube','Videos, Musik & Livestreams'],
    'twitter.com':   ['🐦','Twitter / X','Nachrichten & Trends'],
    'x.com':         ['𝕏','X (Twitter)','Nachrichten & Trends'],
    'facebook.com':  ['👥','Facebook','Soziales Netzwerk'],
    'instagram.com': ['📷','Instagram','Fotos & Videos'],
    'github.com':    ['💻','GitHub','Code-Hosting & Open Source'],
    'reddit.com':    ['🧡','Reddit','Communities & Diskussionen'],
    'netflix.com':   ['🎬','Netflix','Serien, Filme & Dokumentationen'],
    'amazon.de':     ['📦','Amazon','Online-Shopping'],
    'amazon.com':    ['📦','Amazon','Online-Shopping'],
    'microsoft.com': ['🪟','Microsoft','Software, Cloud, Windows'],
    'apple.com':     ['🍎','Apple','Hardware, Software, Store'],
    'paypal.com':    ['💳','PayPal','Online-Zahlungen'],
    'ebay.de':       ['🛒','eBay Deutschland','Online-Marktplatz'],
    'duckduckgo.com':['🦆','DuckDuckGo','Privatsphäre-freundliche Suche'],
    'ecosia.org':    ['🌱','Ecosia','Suche die Bäume pflanzt'],
    'wikipedia.org': ['📖','Wikipedia','Freie Enzyklopädie'],
  };

  let icon = '🌐', name = hostname || 'Externe Website', desc = '';
  for(const [d,[i,n,de]] of Object.entries(siteInfo)) {
    if(hostname && hostname.endsWith(d)) { icon=i; name=n; desc=de; break; }
  }

  errPage.innerHTML = `
  <div class="browser-page" style="max-width:500px;padding-top:32px">
    <div style="text-align:center;margin-bottom:28px">
      <div style="font-size:52px;margin-bottom:12px">${icon}</div>
      <div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:4px">${name}</div>
      ${desc ? `<div style="font-size:12px;color:var(--text2)">${desc}</div>` : ''}
    </div>

    <div style="background:rgba(124,106,255,0.08);border:1px solid rgba(124,106,255,0.2);border-radius:12px;padding:14px 16px;margin-bottom:20px">
      <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:6px">🔒 Iframe-Einbettung blockiert</div>
      <div style="font-size:11px;color:var(--text2);line-height:1.8">
        Diese Website erlaubt aus Sicherheitsgründen keine Einbettung in Frames
        (<code style="background:var(--panel);padding:1px 5px;border-radius:3px">X-Frame-Options: DENY</code>).
        Das ist branchenüblich und schützt vor Clickjacking.
      </div>
    </div>

    <button onclick="window.open('${url}','_blank','noopener')" style="
      width:100%;padding:13px;margin-bottom:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border:none;border-radius:10px;color:white;
      font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;
      box-shadow:0 4px 20px rgba(124,106,255,0.35);transition:filter 0.15s"
      onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='none'">
      🔗 In echtem Browser-Tab öffnen
    </button>

    <div style="display:flex;gap:8px">
      <button class="setting-btn" style="flex:1" onclick="browserHome()">⌂ Startseite</button>
      <button class="setting-btn" style="flex:1" onclick="browserBack()">← Zurück</button>
      <button class="setting-btn" style="flex:1" onclick="browserAddBookmark();showNotif('NovBrowser','🔖 Gespeichert','#6affca')">🔖 Merken</button>
    </div>
  </div>`;
}

function browserSetTabMeta(url) {
  const tab = browserGetActiveTab(); if(!tab) return;
  const pageNames = {'nov://start':'NovBrowser','nov://news':'NovNews','nov://store':'NovStore',
    'nov://maps':'NovMaps','nov://mail':'NovMail','nov://docs':'NovDocs','nov://games':'NovGames','nov://bookmarks':'Lesezeichen'};
  if(pageNames[url]) {
    tab.title = pageNames[url]; tab.favicon = '✦';
  } else if(url.startsWith('nov://search')) {
    const q = decodeURIComponent(url.split('?q=')[1]||'');
    tab.title = '🔍 ' + q.slice(0,20); tab.favicon = '';
  } else {
    try { tab.title = new URL(url).hostname.replace(/^www\./,''); tab.favicon = '🌐'; } catch(e) { tab.title = url.slice(0,20); }
  }
  browserRebuildTabs();
}


function browserBack() {
  const tab = browserGetActiveTab(); if(!tab||tab.histPos<=0) return;
  tab.histPos--; tab.url = tab.history[tab.histPos];
  browserNavigateTo(tab.url, false);
}
function browserFwd() {
  const tab = browserGetActiveTab(); if(!tab||tab.histPos>=tab.history.length-1) return;
  tab.histPos++; tab.url = tab.history[tab.histPos];
  browserNavigateTo(tab.url, false);
}
function browserRefresh() {
  const tab = browserGetActiveTab(); if(!tab) return;
  if(tab.url.startsWith('nov://')) browserNavigateTo(tab.url, false);
  else { const f=document.getElementById('browser-iframe'); if(f) f.src=tab.url; }
}
function browserHome() { browserGo(NovSettings.browserHomepage||'nov://start'); }

function browserAddBookmark() {
  const tab = browserGetActiveTab(); if(!tab) return;
  const bm = {title: tab.title||tab.url, url: tab.url};
  if(browserBookmarks.find(b=>b.url===bm.url)) { showNotif('NovBrowser','Bereits als Lesezeichen gespeichert','#ff6a8a'); return; }
  browserBookmarks.push(bm);
  browserSaveState();
  showNotif('NovBrowser', '"' + bm.title + '" gespeichert 🔖', '#6affca');
}

// ══════════════════════════════════════
// BROWSER PAGE RENDERER (internal nov:// pages)
// ══════════════════════════════════════
function browserPage(url) {
  const nav = u => 'style="cursor:pointer" onclick="browserGo(\'' + u + '\')';

  if(url==='nov://bookmarks') return `<div class="browser-page">
    <h1>📚 Lesezeichen</h1>
    <p>${browserBookmarks.length} gespeichert · <span style="color:var(--accent);cursor:pointer" onclick="browserGo('nov://start')">+ Neu hinzufügen</span></p>
    <div style="margin-top:16px">
    ${browserBookmarks.length ? browserBookmarks.map((bm,i)=>`
      <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:20px">🔖</span>
        <div style="flex:1;overflow:hidden;cursor:pointer" onclick="browserGo('${bm.url}')">
          <div style="font-weight:600;color:var(--text);margin-bottom:2px">${bm.title}</div>
          <div style="font-size:10px;color:var(--accent);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${bm.url}</div>
        </div>
        <button class="setting-btn danger" onclick="browserBookmarks.splice(${i},1);browserSaveState();browserNavigateTo('nov://bookmarks',false)" style="flex-shrink:0">✕</button>
      </div>`).join('')
    : '<p style="color:var(--text2)">Noch keine Lesezeichen. Klicke 🔖 in der Adressleiste beim Besuch einer Seite.</p>'}
    </div></div>`;

  if(url==='nov://start') return `<div class="browser-page">
    <h1 style="margin-bottom:4px">✦ NovBrowser</h1>
    <p style="margin-bottom:20px">Schnell · Sicher · Privat</p>
    <div style="display:flex;gap:8px;margin-bottom:24px">
      <input id="br-search-inp" style="flex:1;background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-family:inherit;font-size:13px;outline:none;transition:border-color 0.15s"
        placeholder="Suchen oder Adresse eingeben…"
        onfocus="this.style.borderColor='var(--accent)'" onfocusout="this.style.borderColor='var(--border)'"
        onkeydown="if(event.key==='Enter')browserGo(this.value.trim())">
      <button class="setting-btn" onclick="browserGo(document.getElementById('br-search-inp').value.trim())" style="padding:0 16px;border-radius:10px">→</button>
    </div>
    <div class="browser-quicklinks">
      <div class="browser-ql" ${nav('nov://news')}><div class="ql-icon">📰</div><div class="ql-title">NovNews</div><div class="ql-url">Aktuelles</div></div>
      <div class="browser-ql" ${nav('nov://games')}><div class="ql-icon">🎮</div><div class="ql-title">NovGames</div><div class="ql-url">Spielen</div></div>
      <div class="browser-ql" ${nav('nov://store')}><div class="ql-icon">🛒</div><div class="ql-title">NovStore</div><div class="ql-url">Apps & Software</div></div>
      <div class="browser-ql" ${nav('nov://maps')}><div class="ql-icon">🗺️</div><div class="ql-title">NovMaps</div><div class="ql-url">Karten</div></div>
      <div class="browser-ql" ${nav('nov://mail')}><div class="ql-icon">📧</div><div class="ql-title">NovMail</div><div class="ql-url">E-Mails</div></div>
      <div class="browser-ql" ${nav('nov://bookmarks')}><div class="ql-icon">📚</div><div class="ql-title">Lesezeichen</div><div class="ql-url">${browserBookmarks.length} gespeichert</div></div>
    </div></div>`;

  if(url.startsWith('nov://search')) {
    const q = decodeURIComponent((url.split('?q=')[1]||''));
    const engine = NovSettings.browserSearch || 'DuckDuckGo';
    const engines = {'DuckDuckGo':'https://duckduckgo.com/?q=','Google':'https://www.google.com/search?q=','Bing':'https://www.bing.com/search?q=','Ecosia':'https://www.ecosia.org/search?q='};
    const realUrl = (engines[engine]||engines.DuckDuckGo) + encodeURIComponent(q);
    // Redirect to real search engine in iframe immediately
    setTimeout(()=>{ const tab=browserGetActiveTab(); if(tab){tab.url=realUrl;tab.history[tab.histPos]=realUrl;} browserNavigateTo(realUrl,false); }, 50);
    return `<div class="browser-page"><p style="color:var(--text2)">Suche nach „${q}" mit ${engine}…</p></div>`;
  }

  if(url==='nov://news') return `<div class="browser-page">
    <h1>📰 NovNews</h1>
    <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">
      ${['Alle','Technik','Wissenschaft','Sport','Wirtschaft'].map(t=>`<span style="padding:4px 12px;border-radius:20px;background:var(--panel2);border:1px solid var(--border);font-size:11px;cursor:pointer;color:var(--text2);transition:all 0.1s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">${t}</span>`).join('')}
    </div>
    ${[
      ['🤖','KI überholt menschliche Entwickler','Neue Studie: Autonome Systeme lösen 94% aller Code-Aufgaben. Nova Corp plant KI-Integration in NovOS 4.0.','vor 2 Std.'],
      ['🚀','NovOS 4.0 angekündigt','Nova Corp kündigt nächste Systemgeneration für 2027 an. Neuer Copilot in allen Apps.','vor 5 Std.'],
      ['🌕','Mondstation Alpha eröffnet','Erste permanente Menschenbewohnung auf dem Mond. 12 Wissenschaftler starten Mission.','vor 1 Tag'],
      ['⚛️','Quantencomputer: 1-Mio-Qubit-Barriere durchbrochen','Historischer Meilenstein. Neue Anwendungen in der Kryptographie.','vor 2 Tagen'],
      ['🌿','Europas größter Solarpark eröffnet','300 km² Solaranlage deckt 8% des EU-Strombedarfs.','vor 3 Tagen'],
    ].map(([ico,h,b,t])=>`<div style="display:flex;gap:14px;padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer" onmouseover="this.style.background='rgba(124,106,255,0.04)'" onmouseout="this.style.background='none'">
      <div style="font-size:28px;flex-shrink:0;line-height:1">${ico}</div>
      <div>
        <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px">${h}</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:4px">${b}</div>
        <div style="font-size:10px;color:var(--accent);opacity:0.7">${t}</div>
      </div></div>`).join('')}</div>`;

  if(url==='nov://games') return `<div class="browser-page"><h1>🎮 NovGames</h1>
    <h2 style="margin-bottom:12px">Kostenlos spielen</h2>
    ${[['⭐','StarRace 3D','Rennspiel · 3D','Kostenlos','#7c6aff'],['🧩','Hexapuzzle','Puzzle · Entspannung','Kostenlos','#6affca'],['🏰','Castle Quest','Strategie · Aufbau','Kostenlos','#ffca6a'],['🐍','Nova Snake','Klassiker','Kostenlos','#ff6a8a']].map(([i,n,g,p,c])=>`
    <div style="display:flex;align-items:center;gap:14px;padding:12px 0;border-bottom:1px solid var(--border)">
      <div style="width:48px;height:48px;border-radius:12px;background:${c}22;border:1px solid ${c}44;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0">${i}</div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--text)">${n}</div><div style="font-size:11px;color:var(--text2)">${g}</div></div>
      <button class="setting-btn" onclick="this.textContent='Lädt…';setTimeout(()=>{this.textContent='Spielen';showNotif('NovGames','${n} gestartet 🎮')},900)" style="flex-shrink:0">${p}</button>
    </div>`).join('')}</div>`;

  if(url==='nov://store') return `<div class="browser-page"><h1>🛒 NovStore</h1>
    <h2 style="margin-bottom:12px">Empfohlen für dich</h2>
    ${[['📊','DataVis Pro','Datenvisualisierung & Charts','9,99 €','#7c6aff'],['🎨','PixelForge','Bild- & Vektorbearbeitung','14,99 €','#ff6a8a'],['🔐','VaultPass','Passwort-Manager','Kostenlos','#6affca'],['📡','NetScanner','Netzwerk-Analyse','Kostenlos','#ffca6a'],['🧠','MindMap Pro','Gedanken organisieren','4,99 €','#a78bfa']].map(([i,n,g,p,c])=>`
    <div style="display:flex;align-items:center;gap:14px;padding:12px 0;border-bottom:1px solid var(--border)">
      <div style="width:44px;height:44px;border-radius:10px;background:${c}22;border:1px solid ${c}44;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${i}</div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600;color:var(--text)">${n}</div><div style="font-size:11px;color:var(--text2)">${g}</div></div>
      <button class="setting-btn" onclick="this.textContent='Installiert ✓';this.disabled=true;showNotif('NovStore','${n} installiert ✓','#6affca')" style="flex-shrink:0;min-width:70px">${p}</button>
    </div>`).join('')}</div>`;

  if(url==='nov://maps') return `<div class="browser-page"><h1>🗺️ NovMaps</h1>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <input style="flex:1;background:var(--panel2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:inherit;font-size:12px;outline:none" placeholder="Ort suchen…">
      <button class="setting-btn">Suchen</button>
    </div>
    <div style="background:linear-gradient(135deg,#0a1f0a,#0a0f1f);border:1px solid var(--border);border-radius:12px;height:220px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;position:relative;overflow:hidden">
      <div style="position:absolute;inset:0;opacity:0.15;background:repeating-linear-gradient(0deg,var(--accent3) 0,var(--accent3) 1px,transparent 0,transparent 40px),repeating-linear-gradient(90deg,var(--accent3) 0,var(--accent3) 1px,transparent 0,transparent 40px)"></div>
      <div style="font-size:48px;position:relative">🗺️</div>
      <div style="color:var(--text2);font-size:12px;position:relative">Nova City, 52.5°N 13.4°E</div>
    </div>
    <h2>In der Nähe</h2>
    ${[['☕','NovCafé','200m · Café'],['🏪','TechStore','450m · Elektronik'],['🏥','Nova-Klinikum','1.2km · Krankenhaus'],['🏋️','FitNova','800m · Fitnessstudio'],['🍕','PizzaNova','350m · Restaurant']].map(([i,n,d])=>`
    <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onmouseover="this.style.background='rgba(124,106,255,0.05)'" onmouseout="this.style.background='none'">
      <span style="font-size:20px">${i}</span>
      <div style="flex:1"><div style="font-size:13px;color:var(--text)">${n}</div><div style="font-size:10px;color:var(--text2)">${d}</div></div>
      <button class="setting-btn" style="font-size:10px;padding:4px 8px" onclick="showNotif('NovMaps','Route zu ${n} gestartet 🧭')">Route</button>
    </div>`).join('')}</div>`;

  if(url==='nov://mail') {
    const mails=[
      ['Nova Corp','📌 NovOS 4.0 Preview – Einladung','Wir freuen uns, dich zur geschlossenen Beta einzuladen!','vor 1 Std.',true,'#7c6aff'],
      ['NovStore','Deine Bestellung #4821','App erfolgreich installiert. Viel Spaß!','vor 3 Std.',false,'#6affca'],
      ['NovNews','Dein täglicher Digest','Top-Meldungen von heute: KI, Raumfahrt, Klimaschutz…','vor 5 Std.',false,null],
      ['NovCloud ⚠️','Speicher fast voll','Du nutzt 92% deines Cloud-Speichers (4.6/5 GB).','gestern',false,'#ff6a8a'],
      ['team@novacorp.io','Kick-off Meeting morgen 10:00','Bitte Kalender prüfen. Raum A3, Hybridformat.','vor 2 Tagen',false,null],
    ];
    return `<div class="browser-page"><h1>📧 NovMail</h1>
    <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center">
      <span style="font-size:12px;color:var(--text2)">${mails.filter(m=>m[4]).length} ungelesen</span>
      <button class="setting-btn" style="font-size:11px;padding:4px 10px" onclick="showNotif('NovMail','Postfach aktualisiert ✓')">↻ Aktualisieren</button>
      <button class="setting-btn" style="font-size:11px;padding:4px 10px;margin-left:auto" onclick="showNotif('NovMail','Neue E-Mail geöffnet ✉️')">✉️ Neu</button>
    </div>
    ${mails.map(([von,betr,prev,t,unread,c])=>`
    <div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.1s;${unread?'background:rgba(124,106,255,0.05);':''}" onclick="this.style.fontWeight='normal';showNotif('NovMail','${betr.slice(0,30)}…')"
      onmouseover="this.style.background='rgba(124,106,255,0.08)'" onmouseout="this.style.background='${unread?'rgba(124,106,255,0.05)':'none'}'">
      <div style="width:36px;height:36px;border-radius:50%;background:${c||'var(--panel2)'};${c?'':'border:1px solid var(--border);'}display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">✉️</div>
      <div style="flex:1;min-width:0">
        <div style="display:flex;justify-content:space-between;margin-bottom:2px;gap:8px">
          <span style="font-size:12px;font-weight:${unread?700:500};color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${von}</span>
          <span style="font-size:10px;color:var(--text2);flex-shrink:0">${t}</span>
        </div>
        <div style="font-size:12px;color:var(--text);margin-bottom:2px;font-weight:${unread?600:400}">${betr}</div>
        <div style="font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${prev}</div>
      </div>
    </div>`).join('')}</div>`;
  }

  if(url==='nov://docs') return `<div class="browser-page"><h1>📄 NovDocs</h1>
    <p>Zuletzt bearbeitet</p>
    ${[['📄','Projektplan 2027.docx','vor 2 Std.'],['📊','Quartalsbericht Q4.xlsx','gestern'],['📝','Ideen.txt','vor 3 Tagen'],['📋','Präsentation Final.pptx','vor 1 Woche'],['📄','Vertrag NovaCorp.pdf','vor 2 Wochen']].map(([i,n,t])=>`
    <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.1s" onclick="showNotif('NovDocs','${n} wird geöffnet')" onmouseover="this.style.background='rgba(124,106,255,0.05)'" onmouseout="this.style.background='none'">
      <span style="font-size:24px">${i}</span>
      <div style="flex:1"><div style="font-size:13px;color:var(--text)">${n}</div><div style="font-size:10px;color:var(--text2)">${t}</div></div>
      <button class="setting-btn" style="font-size:10px;padding:4px 8px" onclick="event.stopPropagation();showNotif('NovDocs','${n} wird heruntergeladen 💾')">↓</button>
    </div>`).join('')}</div>`;

  return `<div class="browser-page">
    <h1 style="color:var(--accent2)">404 – Nicht gefunden</h1>
    <p><code style="background:var(--panel2);padding:2px 6px;border-radius:4px;font-size:12px">${url}</code></p>
    <p style="margin-top:12px">Diese interne Seite existiert nicht.</p>
    <button class="setting-btn" onclick="browserGo('nov://start')" style="margin-top:16px">⌂ Zur Startseite</button>
  </div>`;
}

// ══════════════════════════════════════
// MUSIC
// ══════════════════════════════════════
let musicPlaying=false, musicInterval=null, progressPct=0, curTrack=0;
const tracks=[
  {title:'Neon Drift',         artist:'Synthwave Collective', album:'Digital Dreams',    dur:'3:42',secs:222,ico:'🌆',year:2023,genre:'Synthwave'},
  {title:'Quantum Beat',       artist:'Nova Circuit',         album:'System Sounds',     dur:'4:15',secs:255,ico:'⚡',year:2022,genre:'Electronic'},
  {title:'Stellar Void',       artist:'Deep Space Audio',     album:'Cosmos EP',         dur:'5:01',secs:301,ico:'🌌',year:2024,genre:'Ambient'},
  {title:'Cyber Rain',         artist:'NeonPulse',            album:'Rain Sessions',     dur:'3:28',secs:208,ico:'🌧️',year:2023,genre:'Chillwave'},
  {title:'Nova Rise',          artist:'Synthwave Collective', album:'Digital Dreams',    dur:'4:44',secs:284,ico:'🚀',year:2023,genre:'Synthwave'},
  {title:'Midnight Protocol',  artist:'Binary Ghost',         album:'Dark Net Vol.2',    dur:'3:56',secs:236,ico:'🌃',year:2022,genre:'Dark Synth'},
  {title:'Aurora Circuit',     artist:'Deep Space Audio',     album:'Cosmos EP',         dur:'6:12',secs:372,ico:'🌠',year:2024,genre:'Ambient'},
  {title:'Chrome Horizon',     artist:'NeonPulse',            album:'Velocity',          dur:'3:21',secs:201,ico:'🌅',year:2023,genre:'Electro'},
];
const trackColors = [
  ['#7c6aff','#ff6a8a'],['#3a8fff','#6affca'],['#a78bfa','#6affca'],
  ['#ff6ab0','#ff9f6a'],['#6affca','#3a8fff'],['#ff6a8a','#7c6aff'],
  ['#ffca6a','#ff6ab0'],['#6affca','#a78bfa'],
];
let elapsed=0, musicVolume=70, musicShuffle=false, musicRepeat=false, musicView='library';

function buildMusic() {
  return `
    <div class="music-shell">
      <div class="music-sidebar">
        <div class="music-nav-section">Bibliothek</div>
        <div class="music-nav-item active" onclick="musicSetView('library',this)">🎵 Alle Titel</div>
        <div class="music-nav-item" onclick="musicSetView('albums',this)">💿 Alben</div>
        <div class="music-nav-item" onclick="musicSetView('artists',this)">🎤 Künstler</div>
        <div class="music-nav-section">Playlists</div>
        <div class="music-nav-item" onclick="showNotif('NovMusic','🎵 Playlist: Favoriten')">❤️ Favoriten</div>
        <div class="music-nav-item" onclick="showNotif('NovMusic','🎵 Playlist: Zuletzt gespielt')">🕐 Zuletzt gespielt</div>
        <div class="music-nav-item" onclick="showNotif('NovMusic','🎵 Playlist: Schlafzimmer')">🌙 Abend-Mix</div>
        <div class="music-nav-section">Dienste</div>
        <div class="music-nav-item" onclick="showNotif('NovMusic','☁️ NovCloud Musik – 347 Titel synchronisiert')">☁️ NovCloud</div>
        <div class="music-nav-item" onclick="showNotif('NovMusic','📻 NovRadio – 8 Sender verfügbar')">📻 NovRadio</div>
      </div>
      <div class="music-main-area">
        <div class="music-library" id="music-library-pane"></div>
        <div class="music-player-bar">
          <div class="music-player-top">
            <div class="music-mini-art ${musicPlaying?'playing':''}" id="music-mini-art">
              ${tracks[curTrack].ico}
            </div>
            <div class="music-mini-info">
              <div class="music-mini-title" id="music-mini-title">${tracks[curTrack].title}</div>
              <div class="music-mini-artist" id="music-mini-artist">${tracks[curTrack].artist} · ${tracks[curTrack].album}</div>
            </div>
            <div class="music-player-controls">
              <button class="music-ctrl-btn ${musicShuffle?'active':''}" id="music-btn-shuffle" onclick="musicToggleShuffle()" title="Zufallswiedergabe">⇌</button>
              <button class="music-ctrl-btn" onclick="prevTrack()" title="Zurück">⏮</button>
              <button class="music-play-btn" id="music-play-btn" onclick="togglePlay()">${musicPlaying?'⏸':'▶'}</button>
              <button class="music-ctrl-btn" onclick="nextTrack()" title="Weiter">⏭</button>
              <button class="music-ctrl-btn ${musicRepeat?'active':''}" id="music-btn-repeat" onclick="musicToggleRepeat()" title="Wiederholen">🔁</button>
            </div>
            <div class="music-vol-row" style="width:120px;margin-left:8px">
              <span class="music-vol-icon" onclick="musicToggleMute()" id="music-vol-ico">🔊</span>
              <input type="range" class="music-vol-slider" id="music-vol" min="0" max="100" value="${musicVolume}" oninput="musicSetVol(this.value)">
            </div>
          </div>
          <div class="music-player-progress">
            <span class="music-prog-time" id="music-cur-time">0:00</span>
            <div class="music-prog-track" id="music-prog-track" onclick="musicSeek(event,this)">
              <div class="music-prog-fill" id="music-prog-fill" style="width:0%"></div>
            </div>
            <span class="music-prog-time end" id="music-dur">${tracks[curTrack].dur}</span>
          </div>
        </div>
      </div>
    </div>`;
}

function initMusic() { musicRenderLibrary(); }

function musicSetView(view, el) {
  musicView = view;
  document.querySelectorAll('#body-music .music-nav-item').forEach(e=>e.classList.remove('active'));
  if(el) el.classList.add('active');
  musicRenderLibrary();
}

function musicRenderLibrary() {
  const pane = document.getElementById('music-library-pane');
  if(!pane) return;

  if(musicView === 'albums') {
    const albums = [...new Set(tracks.map(t=>t.album))];
    pane.innerHTML = `
      <div class="music-lib-header"><div class="music-lib-title">Alben</div><span style="font-size:11px;color:var(--text2)">${albums.length} Alben · ${tracks.length} Titel</span></div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,130px);gap:14px;padding:4px">
        ${albums.map(album => {
          const t = tracks.find(tr=>tr.album===album);
          const [c1,c2] = trackColors[tracks.indexOf(t) % trackColors.length];
          return `<div onclick="musicSetView('library',null)" style="cursor:pointer;border-radius:10px;overflow:hidden;border:1px solid var(--border);transition:all 0.15s" onmouseover="this.style.transform='scale(1.03)';this.style.borderColor='var(--accent)'" onmouseout="this.style.transform='';this.style.borderColor='var(--border)'">
            <div style="height:80px;background:linear-gradient(135deg,${c1},${c2});display:flex;align-items:center;justify-content:center;font-size:32px">${t.ico}</div>
            <div style="padding:8px;background:var(--panel2)">
              <div style="font-size:11px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${album}</div>
              <div style="font-size:10px;color:var(--text2);margin-top:2px">${t.artist}</div>
            </div>
          </div>`;
        }).join('')}
      </div>`;
    return;
  }

  if(musicView === 'artists') {
    const artists = [...new Set(tracks.map(t=>t.artist))];
    pane.innerHTML = `
      <div class="music-lib-header"><div class="music-lib-title">Künstler</div><span style="font-size:11px;color:var(--text2)">${artists.length} Künstler</span></div>
      ${artists.map(artist => {
        const artistTracks = tracks.filter(t=>t.artist===artist);
        return `<div onclick="musicSetView('library',null)" style="display:flex;align-items:center;gap:14px;padding:12px 8px;border-bottom:1px solid var(--border);cursor:pointer;border-radius:8px;transition:background 0.1s" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background=''">
          <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,${trackColors[artists.indexOf(artist)%8][0]},${trackColors[artists.indexOf(artist)%8][1]});display:flex;align-items:center;justify-content:center;font-size:18px">${artistTracks[0].ico}</div>
          <div style="flex:1">
            <div style="font-size:13px;font-weight:600;color:var(--text)">${artist}</div>
            <div style="font-size:11px;color:var(--text2)">${artistTracks.length} Titel · ${[...new Set(artistTracks.map(t=>t.album))].length} Alben</div>
          </div>
        </div>`;
      }).join('')}`;
    return;
  }

  // Default: library / all tracks
  pane.innerHTML = `
    <div class="music-lib-header">
      <div class="music-lib-title">Alle Titel</div>
      <span style="font-size:11px;color:var(--text2)">${tracks.length} Titel</span>
    </div>
    <div style="display:grid;grid-template-columns:28px 1fr 1fr 60px;align-items:center;gap:12px;padding:4px 10px 8px;border-bottom:1px solid var(--border)">
      <span style="font-size:9px;color:var(--text2)">#</span>
      <span style="font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px">Titel</span>
      <span style="font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px">Album</span>
      <span style="font-size:9px;color:var(--text2);text-align:right">⏱</span>
    </div>
    ${tracks.map((t,i) => `
      <div class="music-track-row ${i===curTrack?'playing':''}" ondblclick="selectTrack(${i})" onclick="selectTrack(${i})">
        <span class="tnum ${i===curTrack&&musicPlaying?'eq':''}">${i===curTrack&&musicPlaying?'♪':(i+1)}</span>
        <div>
          <div class="tname" style="color:${i===curTrack?'var(--accent)':'var(--text)'}">${t.title}</div>
          <div class="tartist">${t.artist}</div>
        </div>
        <div class="tartist">${t.album}</div>
        <div class="tdur">${t.dur}</div>
      </div>`).join('')}`;
}

function togglePlay() {
  musicPlaying=!musicPlaying;
  const pb=document.getElementById('music-play-btn');
  if(pb) pb.textContent=musicPlaying?'⏸':'▶';
  const art=document.getElementById('music-mini-art');
  if(art) art.classList.toggle('playing',musicPlaying);
  if(musicPlaying) {
    musicInterval=setInterval(()=>{
      elapsed=Math.min(elapsed+1, tracks[curTrack].secs);
      if(elapsed>=tracks[curTrack].secs){
        if(musicRepeat){elapsed=0;}
        else{nextTrack();return;}
      }
      const pct=(elapsed/tracks[curTrack].secs)*100;
      const pf=document.getElementById('music-prog-fill');
      if(pf) pf.style.width=pct+'%';
      const ct=document.getElementById('music-cur-time');
      if(ct) ct.textContent=`${Math.floor(elapsed/60)}:${String(elapsed%60).padStart(2,'0')}`;
    },1000);
  } else clearInterval(musicInterval);
  musicRenderLibrary();
}

function nextTrack(){
  if(musicShuffle) curTrack=Math.floor(Math.random()*tracks.length);
  else curTrack=(curTrack+1)%tracks.length;
  elapsed=0; musicUpdateBar();
  if(musicPlaying){clearInterval(musicInterval);musicPlaying=false;togglePlay();}
}
function prevTrack(){
  if(elapsed>3){elapsed=0;musicUpdateBar();return;}
  curTrack=(curTrack-1+tracks.length)%tracks.length;
  elapsed=0; musicUpdateBar();
  if(musicPlaying){clearInterval(musicInterval);musicPlaying=false;togglePlay();}
}
function selectTrack(i){
  curTrack=i; elapsed=0;
  if(!musicPlaying) togglePlay(); else { clearInterval(musicInterval); musicPlaying=false; togglePlay(); }
}
function musicUpdateBar(){
  const t=tracks[curTrack];
  const setT=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v;};
  setT('music-mini-title',t.title);
  setT('music-mini-artist',t.artist+' · '+t.album);
  setT('music-dur',t.dur);
  setT('music-cur-time','0:00');
  const pf=document.getElementById('music-prog-fill');if(pf)pf.style.width='0%';
  const art=document.getElementById('music-mini-art');
  if(art){const[c1,c2]=trackColors[curTrack%8];art.style.background=`linear-gradient(135deg,${c1},${c2})`;art.textContent=t.ico;}
  musicRenderLibrary();
}
function musicSeek(e,bar){
  const r=bar.getBoundingClientRect();
  const pct=Math.max(0,Math.min(1,(e.clientX-r.left)/r.width));
  elapsed=Math.floor(pct*tracks[curTrack].secs);
  const pf=document.getElementById('music-prog-fill');if(pf)pf.style.width=(pct*100)+'%';
  const ct=document.getElementById('music-cur-time');if(ct)ct.textContent=`${Math.floor(elapsed/60)}:${String(elapsed%60).padStart(2,'0')}`;
}
function musicSetVol(v){
  musicVolume=parseInt(v);
  const ico=document.getElementById('music-vol-ico');
  if(ico) ico.textContent = v==0?'🔇':v<40?'🔈':'🔊';
}
function musicToggleMute(){
  const sl=document.getElementById('music-vol');
  if(!sl) return;
  if(musicVolume>0){sl._prevVol=musicVolume;sl.value=0;musicSetVol(0);}
  else{const v=sl._prevVol||70;sl.value=v;musicSetVol(v);}
}
function musicToggleShuffle(){
  musicShuffle=!musicShuffle;
  const btn=document.getElementById('music-btn-shuffle');
  if(btn) btn.classList.toggle('active',musicShuffle);
  showNotif('NovMusic',musicShuffle?'Zufallswiedergabe aktiviert ⇌':'Zufallswiedergabe deaktiviert');
}
function musicToggleRepeat(){
  musicRepeat=!musicRepeat;
  const btn=document.getElementById('music-btn-repeat');
  if(btn) btn.classList.toggle('active',musicRepeat);
  showNotif('NovMusic',musicRepeat?'Wiederholen aktiviert 🔁':'Wiederholen deaktiviert');
}

// ══════════════════════════════════════
// CALCULATOR
// ══════════════════════════════════════
let calcExpr='', calcVal='0', calcNewNum=true, calcMode='standard', calcHistList=[];
function buildCalc() {
  return `
    <div class="calc-shell">
      <div class="calc-mode-bar">
        <button class="calc-mode-btn active" id="cm-standard" onclick="calcSwitchMode('standard',this)">Standard</button>
        <button class="calc-mode-btn" id="cm-scientific" onclick="calcSwitchMode('scientific',this)">Wissenschaftlich</button>
        <button class="calc-mode-btn" id="cm-history" onclick="calcSwitchMode('history',this)">Verlauf</button>
      </div>
      <div class="calc-display">
        <div class="calc-history-strip" id="calc-hist-strip"></div>
        <div class="calc-expr" id="calc-expr"></div>
        <div class="calc-val" id="calc-val">0</div>
      </div>
      <div id="calc-buttons">
        ${calcBuildStandardGrid()}
      </div>
    </div>`;
}

function calcBuildStandardGrid() {
  return `<div class="calc-grid">
    <button class="calc-btn clr" onclick="calcPress('C')">C</button>
    <button class="calc-btn clr" onclick="calcPress('←')">⌫</button>
    <button class="calc-btn clr" onclick="calcPress('%')">%</button>
    <button class="calc-btn op"  onclick="calcPress('÷')">÷</button>
    <button class="calc-btn" onclick="calcPress('7')">7</button>
    <button class="calc-btn" onclick="calcPress('8')">8</button>
    <button class="calc-btn" onclick="calcPress('9')">9</button>
    <button class="calc-btn op" onclick="calcPress('×')">×</button>
    <button class="calc-btn" onclick="calcPress('4')">4</button>
    <button class="calc-btn" onclick="calcPress('5')">5</button>
    <button class="calc-btn" onclick="calcPress('6')">6</button>
    <button class="calc-btn op" onclick="calcPress('−')">−</button>
    <button class="calc-btn" onclick="calcPress('1')">1</button>
    <button class="calc-btn" onclick="calcPress('2')">2</button>
    <button class="calc-btn" onclick="calcPress('3')">3</button>
    <button class="calc-btn op" onclick="calcPress('+')">+</button>
    <button class="calc-btn clr" onclick="calcPress('±')">±</button>
    <button class="calc-btn" onclick="calcPress('0')">0</button>
    <button class="calc-btn" onclick="calcPress('.')">.</button>
    <button class="calc-btn eq" onclick="calcPress('=')">=</button>
  </div>`;
}

function calcBuildSciGrid() {
  return `<div class="calc-grid-sci">
    <button class="calc-btn sci" onclick="calcSci('sin')">sin</button>
    <button class="calc-btn sci" onclick="calcSci('cos')">cos</button>
    <button class="calc-btn sci" onclick="calcSci('tan')">tan</button>
    <button class="calc-btn sci" onclick="calcSci('log')">log</button>
    <button class="calc-btn sci" onclick="calcSci('ln')">ln</button>
    <button class="calc-btn sci" onclick="calcSci('sqrt')">√</button>
    <button class="calc-btn sci" onclick="calcSci('sq')">x²</button>
    <button class="calc-btn sci" onclick="calcSci('inv')">1/x</button>
    <button class="calc-btn sci" onclick="calcSci('pi')">π</button>
    <button class="calc-btn sci" onclick="calcSci('e')">e</button>
    <button class="calc-btn sci" onclick="calcPress('(')">( </button>
    <button class="calc-btn sci" onclick="calcPress(')')"> )</button>
    <button class="calc-btn clr" onclick="calcPress('C')">C</button>
    <button class="calc-btn clr" onclick="calcPress('←')">⌫</button>
    <button class="calc-btn clr" onclick="calcPress('%')">%</button>
    <button class="calc-btn op"  onclick="calcPress('÷')">÷</button>
    <button class="calc-btn" onclick="calcPress('7')">7</button>
    <button class="calc-btn" onclick="calcPress('8')">8</button>
    <button class="calc-btn" onclick="calcPress('9')">9</button>
    <button class="calc-btn op" onclick="calcPress('×')">×</button>
    <button class="calc-btn" onclick="calcPress('4')">4</button>
    <button class="calc-btn" onclick="calcPress('5')">5</button>
    <button class="calc-btn" onclick="calcPress('6')">6</button>
    <button class="calc-btn op" onclick="calcPress('−')">−</button>
    <button class="calc-btn" onclick="calcPress('1')">1</button>
    <button class="calc-btn" onclick="calcPress('2')">2</button>
    <button class="calc-btn" onclick="calcPress('3')">3</button>
    <button class="calc-btn op" onclick="calcPress('+')">+</button>
    <button class="calc-btn clr" onclick="calcPress('±')">±</button>
    <button class="calc-btn" onclick="calcPress('0')">0</button>
    <button class="calc-btn" onclick="calcPress('.')">.</button>
    <button class="calc-btn eq" onclick="calcPress('=')">=</button>
  </div>`;
}

function calcSwitchMode(mode, el) {
  calcMode = mode;
  document.querySelectorAll('.calc-mode-btn').forEach(b=>b.classList.remove('active'));
  if(el) el.classList.add('active');
  const btn = document.getElementById('calc-buttons');
  if(!btn) return;
  if(mode === 'standard')    btn.innerHTML = calcBuildStandardGrid();
  else if(mode === 'scientific') btn.innerHTML = calcBuildSciGrid();
  else if(mode === 'history') {
    btn.innerHTML = `<div class="calc-history-panel" style="max-height:none;flex:1">
      ${calcHistList.length === 0
        ? '<div style="text-align:center;padding:24px;color:var(--text2);font-size:12px">Kein Verlauf vorhanden</div>'
        : calcHistList.map((h,i)=>`<div class="calc-hist-row" onclick="calcVal='${h.result}';calcNewNum=true;calcUpdateDisplay();calcSwitchMode('standard',document.getElementById('cm-standard'))">${h.expr} = <strong style="color:var(--accent)">${h.result}</strong></div>`).reverse().join('')
      }
      ${calcHistList.length > 0 ? '<button class="setting-btn" style="margin:8px;font-size:10px" onclick="calcHistList=[];calcSwitchMode(\'history\',document.getElementById(\'cm-history\'))">Verlauf löschen</button>' : ''}
    </div>`;
  }
}

function calcSci(fn) {
  const v = parseFloat(calcVal);
  let res;
  try {
    if(fn==='sin')  res = Math.sin(v * Math.PI/180);
    else if(fn==='cos')  res = Math.cos(v * Math.PI/180);
    else if(fn==='tan')  res = Math.tan(v * Math.PI/180);
    else if(fn==='log')  res = Math.log10(v);
    else if(fn==='ln')   res = Math.log(v);
    else if(fn==='sqrt') res = Math.sqrt(v);
    else if(fn==='sq')   res = v*v;
    else if(fn==='inv')  res = 1/v;
    else if(fn==='pi')   { calcVal='3.14159265358979'; calcNewNum=true; calcUpdateDisplay(); return; }
    else if(fn==='e')    { calcVal='2.71828182845905'; calcNewNum=true; calcUpdateDisplay(); return; }
    calcExpr = fn+'('+calcVal+')';
    calcVal = parseFloat(res.toFixed(10)).toString();
    calcNewNum = true;
    calcUpdateDisplay();
  } catch(e) { calcVal='Fehler'; calcNewNum=true; calcUpdateDisplay(); }
}

function calcPress(k) {
  if(k==='C') { calcVal='0'; calcExpr=''; calcNewNum=true; }
  else if(k==='←') { if(calcNewNum){calcExpr='';calcVal='0';} else calcVal=calcVal.length>1?calcVal.slice(0,-1):'0'; }
  else if(k==='±') { calcVal=(parseFloat(calcVal)*-1).toString(); }
  else if(k==='%') { calcVal=(parseFloat(calcVal)/100).toString(); }
  else if(['÷','×','−','+'].includes(k)) {
    if(calcExpr && !calcNewNum) {
      const parts = calcExpr.trim().split(' ');
      const a = parseFloat(parts[0]);
      const op2 = parts[1];
      const b = parseFloat(calcVal);
      let r = b;
      if(op2==='÷'&&b!==0) r=a/b; else if(op2==='×') r=a*b; else if(op2==='−') r=a-b; else if(op2==='+') r=a+b;
      calcVal = parseFloat(r.toFixed(10)).toString();
    }
    calcExpr=calcVal+' '+k; calcNewNum=true;
  }
  else if(k==='=') {
    if(!calcExpr) return;
    try {
      const parts = calcExpr.trim().split(' ');
      const a=parseFloat(parts[0]); const op=parts[1]; const b=parseFloat(calcVal);
      let res = b;
      if(op==='÷') res = b!==0 ? a/b : 'Fehler';
      else if(op==='×') res=a*b;
      else if(op==='−') res=a-b;
      else if(op==='+') res=a+b;
      else res=parseFloat(calcVal);
      const finalRes = (typeof res==='string') ? res : parseFloat(res.toFixed(10)).toString();
      const histEntry = calcExpr+' '+calcVal;
      calcHistList.push({expr: histEntry, result: finalRes});
      if(calcHistList.length>50) calcHistList.shift();
      const strip = document.getElementById('calc-hist-strip');
      if(strip && calcHistList.length > 0) {
        const last = calcHistList[calcHistList.length-2];
        strip.textContent = last ? last.expr+' '+last.result+' =' : '';
      }
      calcExpr=histEntry+' ='; calcVal=finalRes; calcNewNum=true;
    } catch(e){ calcVal='Fehler'; calcNewNum=true; }
  }
  else if(k==='(') { calcExpr+='('; }
  else if(k===')') { calcExpr+=')'; }
  else if(k==='.') { if(calcNewNum){calcVal='0.';calcNewNum=false;} else if(!calcVal.includes('.')) calcVal+='.'; }
  else {
    if(calcNewNum||calcVal==='0'){calcVal=k;calcNewNum=false;}
    else calcVal+=k;
  }
  calcUpdateDisplay();
}

function calcUpdateDisplay() {
  const vEl=document.getElementById('calc-val');
  const eEl=document.getElementById('calc-expr');
  if(vEl) vEl.textContent=calcVal;
  if(eEl) eEl.textContent=calcExpr;
}

// Keyboard support for calculator
document.addEventListener('keydown', e => {
  if(!windows['calc']) return;
  const map = {'0':'0','1':'1','2':'2','3':'3','4':'4','5':'5','6':'6','7':'7','8':'8','9':'9','.':'.','Enter':'=','Backspace':'←','Escape':'C','+':'+','-':'−','*':'×','/':'÷','%':'%'};
  if(map[e.key]) { e.preventDefault(); calcPress(map[e.key]); }
});
let editorTabs = []; // {id, name, content, vfsPath, unsaved}
let editorActiveTab = null;
let editorNextId = 1;

function buildEditor() {
  return `
    <div id="editor-tabs-bar" style="display:flex;align-items:center;background:var(--panel2);border-bottom:1px solid var(--border);overflow-x:auto;flex-shrink:0;min-height:34px;"></div>
    <div class="editor-toolbar" id="editor-toolbar">
      <button class="editor-btn" onclick="editorNew()" title="Neue Datei (Strg+N)">📄 Neu</button>
      <button class="editor-btn" onclick="editorOpenFromPC()" title="Datei öffnen">📂 Öffnen</button>
      <button class="editor-btn" onclick="editorSave()" title="Speichern (Strg+S)" id="editor-save-btn">💾 Speichern</button>
      <button class="editor-btn" onclick="editorSaveAs()" title="Speichern unter">💾 Als...</button>
      <div class="editor-sep"></div>
      <button class="editor-btn" onclick="editorUndo()" title="Rückgängig">↩</button>
      <button class="editor-btn" onclick="editorRedo()" title="Wiederholen">↪</button>
      <div class="editor-sep"></div>
      <button class="editor-btn" id="editor-wrap-btn" onclick="editorToggleWrap()" title="Zeilenumbruch">↵ Wrap</button>
      <select class="setting-select" id="editor-font-size" onchange="editorChangeFontSize(this.value)" title="Schriftgröße">
        <option value="11px">11px</option>
        <option value="12px">12px</option>
        <option value="13px" selected>13px</option>
        <option value="15px">15px</option>
        <option value="18px">18px</option>
        <option value="22px">22px</option>
      </select>
      <select class="setting-select" id="editor-font-family" onchange="document.getElementById('editor-area').style.fontFamily=this.value" title="Schriftart">
        <option value="'Courier New',monospace">Monospace</option>
        <option value="Inter,sans-serif">Sans-Serif</option>
        <option value="Georgia,serif">Serif</option>
      </select>
      <div class="editor-sep"></div>
      <button class="editor-btn" onclick="editorFindOpen()" title="Suchen (Strg+F)">🔍 Suchen</button>
      <button class="editor-btn" onclick="editorWordCount()">📊 Stats</button>
    </div>
    <!-- Find & Replace Bar -->
    <div id="editor-find-bar" style="display:none;padding:6px 12px;background:rgba(124,106,255,0.08);border-bottom:1px solid var(--border);display:none;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap;">
      <span style="font-size:11px;color:var(--text2)">Suchen:</span>
      <input id="editor-find-inp" class="sm-search" style="width:140px;margin:0;padding:4px 8px" placeholder="Suchbegriff..." oninput="editorFindHighlight()">
      <span style="font-size:11px;color:var(--text2)">Ersetzen:</span>
      <input id="editor-replace-inp" class="sm-search" style="width:140px;margin:0;padding:4px 8px" placeholder="Ersetzung...">
      <button class="editor-btn" onclick="editorFindNext()">Nächste</button>
      <button class="editor-btn" onclick="editorReplaceOne()">Ersetzen</button>
      <button class="editor-btn" onclick="editorReplaceAll()">Alle ersetzen</button>
      <span id="editor-find-count" style="font-size:11px;color:var(--accent)"></span>
      <button class="editor-btn" onclick="editorFindClose()" style="margin-left:auto">✕</button>
    </div>
    <textarea class="editor-area" id="editor-area" spellcheck="true" style="resize:none;"></textarea>
    <div class="editor-statusbar">
      <span id="editor-file-name" style="color:var(--accent);font-weight:600">Unbenannt</span>
      <span id="editor-pos">Zeile 1, Spalte 1</span>
      <span id="editor-words">0 Wö · 0 Z</span>
      <span id="editor-encoding">UTF-8</span>
      <span>NovEdit 2.0</span>
    </div>`;
}

function initEditor() {
  const area = document.getElementById('editor-area'); if(!area) return;
  // Create default tab if no tabs
  if(editorTabs.length === 0) {
    editorNewTab('Unbenannt.txt', '# Willkommen in NovEdit 2.0\n\nNeu: Tabs, Suchen/Ersetzen, echte Datei-Integration!\n\nTipps:\n- Strg+S = Speichern\n- Strg+N = Neue Datei\n- Strg+F = Suchen\n- Dateien aus dem Dateimanager öffnen\n\nViel Spaß! ✦', null);
  } else {
    renderTabs(); loadActiveTab();
  }
  area.addEventListener('input', () => { editorMarkUnsaved(); updateEditorStatus(); });
  area.addEventListener('keyup', updateEditorStatus);
  area.addEventListener('keydown', e => {
    if(e.ctrlKey||e.metaKey) {
      if(e.key==='s'){e.preventDefault();editorSave();}
      else if(e.key==='n'){e.preventDefault();editorNew();}
      else if(e.key==='f'){e.preventDefault();editorFindOpen();}
      else if(e.key==='z'){e.preventDefault();editorUndo();}
      else if(e.key==='y'){e.preventDefault();editorRedo();}
    }
    if(e.key==='Tab'){e.preventDefault(); document.execCommand('insertText',false,'  ');}
  });
  area.addEventListener('click', updateEditorStatus);
  updateEditorStatus();
}

function editorNewTab(name, content, vfsPath) {
  const id = 'tab'+editorNextId++;
  editorTabs.push({id, name, content: content||'', vfsPath, unsaved:false});
  editorActiveTab = id;
  renderTabs();
  loadActiveTab();
  return id;
}

function renderTabs() {
  const bar = document.getElementById('editor-tabs-bar'); if(!bar) return;
  bar.innerHTML = editorTabs.map(tab => `
    <div onclick="editorSwitchTab('${tab.id}')" style="
      display:inline-flex;align-items:center;gap:6px;padding:0 12px;height:34px;
      font-size:11px;cursor:pointer;white-space:nowrap;border-right:1px solid var(--border);
      background:${tab.id===editorActiveTab?'var(--panel)':'var(--panel2)'};
      color:${tab.id===editorActiveTab?'var(--text)':'var(--text2)'};
      border-bottom:${tab.id===editorActiveTab?'2px solid var(--accent)':'2px solid transparent'};
      flex-shrink:0;">
      ${tab.unsaved?'●':''} ${tab.name}
      <span onclick="editorCloseTab(event,'${tab.id}')" style="opacity:0.5;padding:2px 3px;border-radius:3px;font-size:10px;" onmouseover="this.style.opacity=1;this.style.background='var(--border)'" onmouseout="this.style.opacity=0.5;this.style.background='none'">✕</span>
    </div>`).join('') +
    `<div onclick="editorNew()" style="display:inline-flex;align-items:center;padding:0 10px;height:34px;cursor:pointer;color:var(--text2);font-size:16px;opacity:0.5;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">+</div>`;
}

function editorSwitchTab(id) {
  // save current content to current tab
  const cur = editorTabs.find(t=>t.id===editorActiveTab);
  if(cur) { cur.content = document.getElementById('editor-area')?.value||''; }
  editorActiveTab = id;
  renderTabs();
  loadActiveTab();
}

async function editorCloseTab(e, id) {
  e.stopPropagation();
  const tab = editorTabs.find(t=>t.id===id);
  if(tab?.unsaved) {
    const ok = await novDialog({
      icon:'⚠️', title:'Ungespeicherte Änderungen',
      msg:'"' + tab.name + '" hat ungespeicherte Änderungen.\nTrotzdem schließen?',
      confirmLabel:'Schließen', danger:true
    });
    if(!ok) return;
  }
  editorTabs = editorTabs.filter(t=>t.id!==id);
  if(editorActiveTab===id) {
    editorActiveTab = editorTabs.length ? editorTabs[editorTabs.length-1].id : null;
    if(!editorTabs.length) editorNewTab('Unbenannt.txt','',null);
    else { renderTabs(); loadActiveTab(); }
  } else { renderTabs(); }
}

function loadActiveTab() {
  const area = document.getElementById('editor-area'); if(!area) return;
  const tab = editorTabs.find(t=>t.id===editorActiveTab);
  if(!tab) return;
  area.value = tab.content;
  const fn = document.getElementById('editor-file-name');
  if(fn) fn.textContent = tab.name;
  updateEditorStatus();
}

function editorMarkUnsaved() {
  const tab = editorTabs.find(t=>t.id===editorActiveTab);
  if(tab && !tab.unsaved) { tab.unsaved=true; renderTabs(); }
}

async function editorNew() {
  const name = await novDialog({
    icon:'📄', title:'Neue Datei',
    msg:'Dateiname:',
    input:true, inputDefault:'Unbenannt.txt', inputPlaceholder:'datei.txt',
    confirmLabel:'Erstellen'
  });
  editorNewTab(name || 'Unbenannt.txt', '', null);
}

function editorOpenFromPC() {
  const input = document.createElement('input');
  input.type='file'; input.accept='.txt,.md,.json,.csv,.log,.xml,.html,.js,.py,.css,.ini,.yaml,.toml,.sh,.bat';
  input.onchange = e => {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      editorNewTab(file.name, ev.target.result, null);
      showNotif('NovEdit', file.name+' geöffnet ✓', '#6affca');
    };
    reader.readAsText(file);
  };
  input.click();
}

// Open file from VFS (called by file manager)
function editorOpenFile(name, content, vfsPath) {
  // Check if already open
  const existing = editorTabs.find(t=>t.vfsPath===vfsPath);
  if(existing) { editorSwitchTab(existing.id); openApp('editor'); return; }
  openApp('editor');
  // save current before switching
  const cur = editorTabs.find(t=>t.id===editorActiveTab);
  if(cur) cur.content = document.getElementById('editor-area')?.value||'';
  editorNewTab(name, content, vfsPath);
  showNotif('NovEdit', name+' geöffnet 📝');
}

function editorSave() {
  const area = document.getElementById('editor-area'); if(!area) return;
  const tab = editorTabs.find(t=>t.id===editorActiveTab); if(!tab) return;
  tab.content = area.value;
  tab.unsaved = false;
  // Save back to VFS if linked
  if(tab.vfsPath) {
    vfsContents[tab.vfsPath] = area.value;
    vfsSave();
    showNotif('NovEdit', tab.name+' gespeichert ✓', '#6affca');
  } else {
    // Download as real file
    const blob = new Blob([area.value],{type:'text/plain'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=tab.name; a.click();
    showNotif('NovEdit', tab.name+' heruntergeladen 💾', '#6affca');
  }
  renderTabs();
}

async function editorSaveAs() {
  const area = document.getElementById('editor-area'); if(!area) return;
  const tab = editorTabs.find(t=>t.id===editorActiveTab); if(!tab) return;
  const newName = await novDialog({
    icon:'💾', title:'Speichern als',
    msg:'Dateiname:',
    input:true, inputDefault:tab.name,
    confirmLabel:'Herunterladen'
  });
  if(!newName) return;
  tab.content = area.value;
  const blob = new Blob([area.value],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=newName; a.click();
  showNotif('NovEdit', newName+' heruntergeladen 💾', '#6affca');
}

function editorUndo() { document.getElementById('editor-area')?.focus(); document.execCommand('undo'); }
function editorRedo() { document.getElementById('editor-area')?.focus(); document.execCommand('redo'); }

let editorWrapOn = true;
function editorToggleWrap() {
  editorWrapOn = !editorWrapOn;
  const area = document.getElementById('editor-area');
  if(area) area.style.whiteSpace = editorWrapOn ? 'pre-wrap' : 'pre';
  const btn = document.getElementById('editor-wrap-btn');
  if(btn) btn.style.color = editorWrapOn ? 'var(--accent)' : 'var(--text2)';
}
function editorChangeFontSize(v) {
  const area = document.getElementById('editor-area');
  if(area) area.style.fontSize = v;
}

// Find & Replace
let findMatches=[], findIdx=0;
function editorFindOpen() {
  const bar = document.getElementById('editor-find-bar');
  if(bar) { bar.style.display='flex'; document.getElementById('editor-find-inp')?.focus(); }
}
function editorFindClose() {
  const bar = document.getElementById('editor-find-bar');
  if(bar) bar.style.display='none';
  document.getElementById('editor-find-count').textContent='';
}
function editorFindHighlight() {
  const term = document.getElementById('editor-find-inp')?.value;
  const area = document.getElementById('editor-area'); if(!area) return;
  const cnt = document.getElementById('editor-find-count');
  if(!term) { if(cnt) cnt.textContent=''; return; }
  const text = area.value;
  const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
  const matches = [...text.matchAll(regex)];
  findMatches = matches.map(m=>m.index);
  if(cnt) cnt.textContent = findMatches.length ? findMatches.length+' Treffer' : 'Kein Treffer';
}
function editorFindNext() {
  editorFindHighlight();
  if(!findMatches.length) return;
  findIdx = (findIdx+1) % findMatches.length;
  const area = document.getElementById('editor-area'); if(!area) return;
  const term = document.getElementById('editor-find-inp')?.value||'';
  area.focus();
  area.setSelectionRange(findMatches[findIdx], findMatches[findIdx]+term.length);
  // scroll to selection
  const lineH = parseInt(getComputedStyle(area).lineHeight)||18;
  const line = area.value.slice(0,findMatches[findIdx]).split('\n').length;
  area.scrollTop = Math.max(0,(line-3)*lineH);
}
function editorReplaceOne() {
  const find = document.getElementById('editor-find-inp')?.value; if(!find) return;
  const rep  = document.getElementById('editor-replace-inp')?.value||'';
  const area = document.getElementById('editor-area'); if(!area) return;
  const start=area.selectionStart, end=area.selectionEnd;
  if(area.value.slice(start,end).toLowerCase()===find.toLowerCase()) {
    area.setRangeText(rep,start,end,'end');
    editorMarkUnsaved(); updateEditorStatus();
  }
  editorFindNext();
}
function editorReplaceAll() {
  const find = document.getElementById('editor-find-inp')?.value; if(!find) return;
  const rep  = document.getElementById('editor-replace-inp')?.value||'';
  const area = document.getElementById('editor-area'); if(!area) return;
  const regex = new RegExp(find.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
  const before = area.value;
  area.value = before.replace(regex, rep);
  const cnt = (before.match(regex)||[]).length;
  editorMarkUnsaved(); updateEditorStatus();
  showNotif('NovEdit', cnt+' Ersetzungen vorgenommen ✓', '#6affca');
  editorFindHighlight();
}

function updateEditorStatus() {
  const area = document.getElementById('editor-area'); if(!area) return;
  const text = area.value||'';
  const words = text.trim() ? text.trim().split(/\s+/).length : 0;
  const chars = text.length;
  const lines = text.slice(0,area.selectionStart).split('\n');
  const lineNum = lines.length;
  const col = lines[lines.length-1].length+1;
  const wc = document.getElementById('editor-words');
  const pos = document.getElementById('editor-pos');
  if(wc) wc.textContent = `${words} Wö · ${chars} Z`;
  if(pos) pos.textContent = `Zeile ${lineNum}, Sp ${col}`;
}

function editorWordCount() {
  const area = document.getElementById('editor-area'); if(!area) return;
  const text = area.value||'';
  const words = text.trim() ? text.trim().split(/\s+/).length : 0;
  const lines = text.split('\n').length;
  const chars = text.length;
  showNotif('NovEdit',`${words} Wörter · ${chars} Zeichen · ${lines} Zeilen`);
}

// ══════════════════════════════════════
// GALLERY
// ══════════════════════════════════════
// ══════════════════════════════════════
// GALLERY
// ══════════════════════════════════════
let galleryView = 'grid';    // grid | list
let gallerySelected = null;
let galleryFilter = 'all';   // all | image | video
let gallerySortKey = 'name'; // name | date | size
let gallerySlideInterval = null;
let gallerySlideIdx = 0;
let galleryImportedImages = []; // {name, dataUrl, size, date, type}

const galleryBuiltin = [
  {name:'Sonnenuntergang.jpg', ico:'🌅', bg:'linear-gradient(135deg,#ff6a00,#ee0979)', date:'2025-09-12', size:2847392, type:'image'},
  {name:'Ozean_Wellen.jpg',    ico:'🌊', bg:'linear-gradient(135deg,#00b4db,#0083b0)', date:'2025-08-04', size:3124800, type:'image'},
  {name:'Bergpanorama.png',    ico:'🏔️', bg:'linear-gradient(135deg,#a8edea,#5fa8d3)', date:'2025-07-19', size:5234100, type:'image'},
  {name:'Kirschblüte.jpg',     ico:'🌸', bg:'linear-gradient(135deg,#f093fb,#f5576c)', date:'2025-04-07', size:1928400, type:'image'},
  {name:'Nachtstadt.png',      ico:'🌃', bg:'linear-gradient(135deg,#0f0c29,#302b63)', date:'2025-06-23', size:4102000, type:'image'},
  {name:'Schmetterling.jpg',   ico:'🦋', bg:'linear-gradient(135deg,#43e97b,#38f9d7)', date:'2025-05-15', size:987300,  type:'image'},
  {name:'Bergbach.jpg',        ico:'🏞️', bg:'linear-gradient(135deg,#2af598,#009efd)', date:'2025-08-29', size:3401200, type:'image'},
  {name:'Wüste_Dünen.jpg',     ico:'🏜️', bg:'linear-gradient(135deg,#f7971e,#ffd200)', date:'2025-10-01', size:2765000, type:'image'},
  {name:'Nordlichter.jpg',     ico:'🌌', bg:'linear-gradient(135deg,#12c2e9,#f64f59)', date:'2025-12-20', size:6102300, type:'image'},
  {name:'Herbstwald.jpg',      ico:'🍂', bg:'linear-gradient(135deg,#d4731b,#a84210)', date:'2025-10-28', size:3827100, type:'image'},
  {name:'Urlaub_Strand.mp4',   ico:'🎬', bg:'linear-gradient(135deg,#006994,#00c6ff)', date:'2025-08-06', size:52428800, type:'video'},
  {name:'Geburtstag.mp4',      ico:'🎂', bg:'linear-gradient(135deg,#da4453,#89216b)', date:'2025-03-14', size:38000000, type:'video'},
];

function galleryAllImages() {
  return [
    ...galleryBuiltin,
    ...galleryImportedImages
  ];
}

function buildGallery() {
  return `
    <div class="gallery-shell">
      <div class="gallery-sidebar">
        <div class="gallery-nav-section">Mediathek</div>
        <div class="gallery-nav-item active" data-gf="all"   onclick="gallerySetFilter('all',this)">🖼️ Alle Medien</div>
        <div class="gallery-nav-item" data-gf="image" onclick="gallerySetFilter('image',this)">📷 Fotos</div>
        <div class="gallery-nav-item" data-gf="video" onclick="gallerySetFilter('video',this)">🎬 Videos</div>
        <div class="gallery-nav-section">Alben</div>
        <div class="gallery-nav-item" onclick="gallerySetAlbum('Urlaub')">✈️ Urlaub</div>
        <div class="gallery-nav-item" onclick="gallerySetAlbum('Natur')">🌿 Natur</div>
        <div class="gallery-nav-item" onclick="gallerySetAlbum('Sonstiges')">📁 Sonstiges</div>
        <div class="gallery-nav-section">Aktionen</div>
        <div class="gallery-nav-item" onclick="galleryImport()">📥 Importieren</div>
        <div class="gallery-nav-item" onclick="galleryStartSlideshow()">▶ Diashow</div>
      </div>
      <div class="gallery-main">
        <div class="gallery-toolbar">
          <input type="text" id="gallery-search" placeholder="🔍 Suchen…" style="
            background:var(--panel); border:1px solid var(--border); border-radius:20px;
            padding:5px 12px; color:var(--text); font-family:'Inter',sans-serif; font-size:11px;
            outline:none; width:160px; transition:border-color 0.15s;"
            oninput="galleryRender()" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor=''">
          <span style="flex:1"></span>
          <select id="gallery-sort" style="background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-family:'Inter',sans-serif;font-size:11px;outline:none;cursor:pointer" onchange="gallerySortKey=this.value;galleryRender()">
            <option value="name">Name</option>
            <option value="date">Datum</option>
            <option value="size">Größe</option>
          </select>
          <div class="gallery-view-toggle">
            <button class="gallery-view-btn active" id="gvb-grid" onclick="gallerySetView('grid',this)" title="Rasteransicht">⊞</button>
            <button class="gallery-view-btn" id="gvb-list" onclick="gallerySetView('list',this)" title="Listenansicht">≡</button>
          </div>
        </div>
        <div class="gallery-content" id="gallery-content"></div>
        <div class="gallery-info-bar" id="gallery-info-bar">
          <span id="gallery-count">0 Objekte</span>
          <span style="flex:1"></span>
          <span id="gallery-sel-info" style="color:var(--text)"></span>
        </div>
      </div>
    </div>`;
}

function initGallery() { galleryRender(); }

function gallerySetFilter(f, el) {
  galleryFilter = f;
  gallerySelected = null;
  document.querySelectorAll('#body-gallery .gallery-nav-item').forEach(e => e.classList.remove('active'));
  if(el) el.classList.add('active');
  galleryRender();
}
function gallerySetAlbum(name) {
  showNotif('NovGalerie', 'Album "' + name + '" – ' + Math.floor(Math.random()*8+2) + ' Fotos 🖼️');
}
function gallerySetView(v, el) {
  galleryView = v;
  document.querySelectorAll('.gallery-view-btn').forEach(b => b.classList.remove('active'));
  if(el) el.classList.add('active');
  galleryRender();
}

function galleryRender() {
  const content = document.getElementById('gallery-content'); if(!content) return;
  const search = (document.getElementById('gallery-search')?.value || '').toLowerCase();
  const sortKey = document.getElementById('gallery-sort')?.value || gallerySortKey;

  let imgs = galleryAllImages();
  if(galleryFilter !== 'all') imgs = imgs.filter(i => i.type === galleryFilter);
  if(search) imgs = imgs.filter(i => i.name.toLowerCase().includes(search));

  imgs = [...imgs].sort((a,b) => {
    if(sortKey === 'date') return (b.date||'') < (a.date||'') ? -1 : 1;
    if(sortKey === 'size') return (b.size||0) - (a.size||0);
    return a.name.localeCompare(b.name);
  });

  const cnt = document.getElementById('gallery-count');
  if(cnt) cnt.textContent = imgs.length + ' Objekt' + (imgs.length === 1 ? '' : 'e');

  if(imgs.length === 0) {
    content.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:12px;color:var(--text2)"><div style="font-size:48px">🖼️</div><div>Keine Bilder gefunden</div><button class="setting-btn" onclick="galleryImport()">📥 Fotos importieren</button></div>';
    return;
  }

  if(galleryView === 'grid') {
    content.innerHTML = '<div class="gallery-grid-view">' +
      imgs.map((img, i) => {
        const isImported = !!img.dataUrl;
        const isSelected = gallerySelected === img.name;
        return '<div class="gallery-tile' + (isSelected?' selected':'') + '" onclick="gallerySelectImg(' + i + ',event)" ondblclick="galleryOpenLightbox(' + i + ')" title="' + img.name + '">' +
          '<div class="gallery-tile-img"' + (isImported ? ' style="background:var(--panel2);overflow:hidden">' + '<img src="' + img.dataUrl + '" style="width:100%;height:100%;object-fit:cover">' : ' style="background:' + img.bg + '">' + '<span style="font-size:36px">' + img.ico + '</span>') + '</div>' +
          '<div class="gallery-tile-label">' + img.name + '</div>' +
          (img.type === 'video' ? '<div style="position:absolute;top:6px;left:6px;background:rgba(0,0,0,0.6);border-radius:4px;padding:2px 5px;font-size:9px;color:white">▶ Video</div>' : '') +
          '</div>';
      }).join('') + '</div>';
  } else {
    content.innerHTML = '<div class="gallery-list-view">' +
      '<div style="display:grid;grid-template-columns:36px 1fr 90px 90px 60px;align-items:center;gap:12px;padding:4px 10px 8px;font-size:10px;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--border)"><span></span><span>Name</span><span>Datum</span><span>Größe</span><span>Typ</span></div>' +
      imgs.map((img, i) => {
        const isImported = !!img.dataUrl;
        const isSelected = gallerySelected === img.name;
        const sizeStr = img.size > 1048576 ? (img.size/1048576).toFixed(1)+' MB' : (img.size/1024).toFixed(0)+' KB';
        return '<div class="gallery-list-row' + (isSelected?' selected':'') + '" style="' + (isSelected?'background:rgba(124,106,255,0.12);':'') + 'display:grid;grid-template-columns:36px 1fr 90px 90px 60px" onclick="gallerySelectImg(' + i + ',event)" ondblclick="galleryOpenLightbox(' + i + ')">' +
          '<span style="font-size:20px">' + img.ico + '</span>' +
          '<span style="color:var(--text);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + img.name + '</span>' +
          '<span>' + (img.date||'—') + '</span>' +
          '<span>' + sizeStr + '</span>' +
          '<span style="color:var(--text2)">' + (img.type === 'image' ? '🖼️ Bild' : '🎬 Video') + '</span>' +
          '</div>';
      }).join('') + '</div>';
  }
}

function gallerySelectImg(idx, e) {
  e.stopPropagation();
  const imgs = galleryGetFiltered();
  const img = imgs[idx];
  gallerySelected = gallerySelected === img?.name ? null : img?.name;
  const selInfo = document.getElementById('gallery-sel-info');
  if(selInfo) {
    if(gallerySelected && img) {
      const sizeStr = img.size > 1048576 ? (img.size/1048576).toFixed(1)+' MB' : (img.size/1024).toFixed(0)+' KB';
      selInfo.textContent = img.name + ' · ' + sizeStr + (img.date ? ' · ' + img.date : '');
    } else selInfo.textContent = '';
  }
  galleryRender();
}

function galleryGetFiltered() {
  const search = (document.getElementById('gallery-search')?.value || '').toLowerCase();
  const sortKey = document.getElementById('gallery-sort')?.value || gallerySortKey;
  let imgs = galleryAllImages();
  if(galleryFilter !== 'all') imgs = imgs.filter(i => i.type === galleryFilter);
  if(search) imgs = imgs.filter(i => i.name.toLowerCase().includes(search));
  return [...imgs].sort((a,b) => {
    if(sortKey === 'date') return (b.date||'') < (a.date||'') ? -1 : 1;
    if(sortKey === 'size') return (b.size||0) - (a.size||0);
    return a.name.localeCompare(b.name);
  });
}

function galleryOpenLightbox(idx) {
  const imgs = galleryGetFiltered();
  const img = imgs[idx];
  if(!img) return;

  const existing = document.getElementById('gallery-lightbox');
  if(existing) existing.remove();

  const lb = document.createElement('div');
  lb.id = 'gallery-lightbox';
  lb.style.cssText = 'position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,0.92);display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(10px)';

  const imgHtml = img.dataUrl
    ? `<img src="${img.dataUrl}" style="max-width:85vw;max-height:75vh;border-radius:8px;object-fit:contain;box-shadow:0 24px 80px rgba(0,0,0,0.8)">`
    : `<div style="width:420px;height:300px;border-radius:8px;background:${img.bg};display:flex;align-items:center;justify-content:center;font-size:120px;box-shadow:0 24px 80px rgba(0,0,0,0.8)">${img.ico}</div>`;

  lb.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;width:100%;max-width:900px;padding:16px 24px;position:absolute;top:0">
      <div>
        <div style="font-size:14px;font-weight:600;color:white">${img.name}</div>
        <div style="font-size:11px;color:rgba(255,255,255,0.45)">${img.date||''} · ${(img.size/1048576).toFixed(1)} MB · ${img.type === 'image'?'Bild':'Video'}</div>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <span style="font-size:11px;color:rgba(255,255,255,0.4)">${idx+1} / ${imgs.length}</span>
        <button onclick="document.getElementById('gallery-lightbox').remove()" style="background:rgba(255,255,255,0.1);border:none;border-radius:8px;color:white;padding:6px 12px;cursor:pointer;font-size:13px;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">✕ Schließen</button>
      </div>
    </div>
    ${imgHtml}
    <div style="display:flex;align-items:center;gap:24px;margin-top:20px">
      ${idx > 0 ? `<button onclick="galleryOpenLightbox(${idx-1})" style="background:rgba(255,255,255,0.1);border:none;border-radius:50%;color:white;width:42px;height:42px;cursor:pointer;font-size:18px;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">‹</button>` : '<div style="width:42px"></div>'}
      <button onclick="document.getElementById('gallery-lightbox').remove();galleryStartSlideshow()" style="background:rgba(255,255,255,0.1);border:none;border-radius:8px;color:white;padding:8px 16px;cursor:pointer;font-size:12px;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">▶ Diashow</button>
      ${idx < imgs.length-1 ? `<button onclick="galleryOpenLightbox(${idx+1})" style="background:rgba(255,255,255,0.1);border:none;border-radius:50%;color:white;width:42px;height:42px;cursor:pointer;font-size:18px;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">›</button>` : '<div style="width:42px"></div>'}
    </div>`;

  lb.addEventListener('click', e => { if(e.target === lb) lb.remove(); });
  document.getElementById('desktop').appendChild(lb);

  // Keyboard nav
  lb._keyHandler = e => {
    if(e.key === 'Escape') lb.remove();
    if(e.key === 'ArrowRight' && idx < imgs.length-1) { lb.remove(); galleryOpenLightbox(idx+1); }
    if(e.key === 'ArrowLeft' && idx > 0) { lb.remove(); galleryOpenLightbox(idx-1); }
  };
  document.addEventListener('keydown', lb._keyHandler);
  lb.addEventListener('remove', () => document.removeEventListener('keydown', lb._keyHandler));
}

function galleryImport() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*,video/*';
  input.multiple = true;
  input.onchange = e => {
    const files = Array.from(e.target.files);
    let done = 0;
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = ev => {
        const dataUrl = ev.target.result;
        const type = file.type.startsWith('video') ? 'video' : 'image';
        const ico = type === 'video' ? '🎬' : '🖼️';
        const today = new Date().toISOString().slice(0,10);
        // Add to pics vfs too
        if(!vfs.pics.find(f => f.n === file.name)) {
          vfs.pics.push({ico, n:file.name, type});
        }
        // Store preview in gallery
        if(!galleryImportedImages.find(i => i.name === file.name)) {
          galleryImportedImages.push({
            name: file.name, dataUrl, ico, bg:'linear-gradient(135deg,#2a2a3a,#3a3a4a)',
            date: today, size: file.size, type
          });
        }
        done++;
        if(done === files.length) {
          vfsSave();
          galleryRender();
          showNotif('NovGalerie', done + ' Bild(er) importiert ✓', '#6affca');
        }
      };
      reader.readAsDataURL(file);
    });
  };
  input.click();
}

function galleryStartSlideshow() {
  if(gallerySlideInterval) { clearInterval(gallerySlideInterval); gallerySlideInterval = null; }
  const imgs = galleryGetFiltered();
  if(!imgs.length) { showNotif('NovGalerie', 'Keine Bilder für Diashow', '#ff6a8a'); return; }

  gallerySlideIdx = 0;
  const lb = document.createElement('div');
  lb.id = 'gallery-slideshow';
  lb.style.cssText = 'position:fixed;inset:0;z-index:8100;background:black;display:flex;flex-direction:column;align-items:center;justify-content:center';

  function showSlide() {
    const img = imgs[gallerySlideIdx % imgs.length];
    const imgHtml = img.dataUrl
      ? `<img src="${img.dataUrl}" style="max-width:100vw;max-height:90vh;object-fit:contain">`
      : `<div style="width:500px;height:380px;background:${img.bg};display:flex;align-items:center;justify-content:center;font-size:140px">${img.ico}</div>`;
    lb.innerHTML = `
      ${imgHtml}
      <div style="position:absolute;bottom:24px;left:0;right:0;text-align:center">
        <div style="color:white;font-size:14px;font-weight:600">${img.name}</div>
        <div style="color:rgba(255,255,255,0.4);font-size:11px;margin-top:4px">${gallerySlideIdx+1} / ${imgs.length}</div>
        <button onclick="clearInterval(gallerySlideInterval);gallerySlideInterval=null;document.getElementById('gallery-slideshow')?.remove()" style="margin-top:16px;background:rgba(255,255,255,0.1);border:none;border-radius:8px;color:white;padding:8px 20px;cursor:pointer;font-size:12px">■ Beenden</button>
      </div>`;
    gallerySlideIdx++;
  }

  showSlide();
  gallerySlideInterval = setInterval(showSlide, 3500);
  document.getElementById('desktop').appendChild(lb);
}

const galleryImages = galleryBuiltin; // backward compat alias
// ══════════════════════════════════════
// PDF VIEWER
// ══════════════════════════════════════

// Built-in PDF documents stored in VFS as structured data
const pdfDocs = {
  'docs/Bericht.pdf': {
    title: 'Quartalsbericht Q4',
    author: 'Nova Corp Analytics',
    pages: [
      {
        heading: 'Quartalsbericht Q4 – Zusammenfassung',
        body: `Dieser Bericht fasst die wichtigsten Kennzahlen und Entwicklungen des vierten Quartals zusammen.

Umsatz: 4.820.000 €  (+12% gegenüber Vorquartal)
Betriebsergebnis: 940.000 €  (+8%)
Neue Kunden: 347
Kundenbindungsrate: 94,2%

Das Quartal verlief insgesamt positiv. Besonders der Bereich Cloud-Services verzeichnete ein starkes Wachstum von 23%. Die Produktlinie NovOS erreichte mit Version 3.1 einen Marktanteil von 4,7% im Segment der Web-Betriebssysteme.`
      },
      {
        heading: 'Umsatzentwicklung nach Segmenten',
        body: `Software-Lizenzen:       1.920.000 €   (40%)
Cloud-Services:          1.448.000 €   (30%)
Support & Wartung:         964.000 €   (20%)
Beratungsleistungen:       482.000 €   (10%)

──────────────────────────────────────
Gesamt:                  4.820.000 €

Im Vergleich zum Vorjahr (Q4) konnte der Gesamtumsatz um 31% gesteigert werden. Treiber war vor allem die Expansion in den europäischen Märkten sowie die gestiegene Nachfrage nach KI-integrierten Lösungen.`
      },
      {
        heading: 'Ausblick Q1 – Planungsziele',
        body: `Für das erste Quartal des kommenden Jahres werden folgende Ziele angestrebt:

1. Einführung von NovOS 3.2 mit verbessertem KI-Assistenten
2. Erweiterung des Partner-Netzwerks auf 50+ Integrationen
3. Zielumsatz: 5.400.000 € (+12% gegenüber Q4)
4. Einstieg in den US-amerikanischen Markt (Beta-Phase)
5. Erhöhung der Entwicklerkapazitäten um 20%

Das Team ist gut aufgestellt. Risiken bestehen hauptsächlich durch regulatorische Änderungen im Bereich Datenschutz sowie durch den zunehmenden Wettbewerb im Cloud-Segment.`
      }
    ]
  },
  'home/NovOS_Handbuch.pdf': {
    title: 'NovOS 3.1 – Benutzerhandbuch',
    author: 'Nova Corp Dokumentation',
    pages: [
      {
        heading: 'Willkommen bei NovOS 3.1',
        body: `NovOS ist ein modernes Web-Betriebssystem, das vollständig im Browser läuft. Es bietet eine vertraute Desktop-Umgebung mit Fenstern, Apps und einem virtuellen Dateisystem.

Systemvoraussetzungen:
– Moderner Browser (Chrome, Firefox, Edge, Safari)
– Keine Installation erforderlich
– Alle Daten werden lokal gespeichert

Erste Schritte:
Doppelklick auf Desktop-Icons öffnet Apps.
Das ✦ Start-Symbol öffnet das Startmenü.
Klick auf die Uhrzeit öffnet das Kontrollzentrum.`
      },
      {
        heading: 'Apps & Funktionen',
        body: `NovOS enthält folgende integrierte Apps:

📂  Dateien – Virtuelles Dateisystem mit Ordnern
📝  TextEditor – Mehrtabben-Editor mit VFS-Integration
🌐  NovBrowser – Browser mit internen nov://-Seiten
📋  NovPDF – PDF-Betrachter mit VFS-Unterstützung
🧮  Rechner – Wissenschaftlicher Taschenrechner
🎵  NovMusic – Musik-Player mit Playlist
🖼️  Galerie – Bildverwaltung
🌤️  Wetter – Wettervorhersage
📊  Systemmonitor – Ressourcen-Überwachung
⚙️  Einstellungen – Design, Themes, Speicher`
      },
      {
        heading: 'Dateisystem & Persistenz',
        body: `Das virtuelle Dateisystem (VFS) von NovOS speichert alle Daten im localStorage des Browsers.

Ordnerstruktur:
~/              (Heimordner)
~/Dokumente/    (Texte, PDFs, Tabellen)
~/Bilder/       (Bilder und Grafiken)
~/Downloads/    (Heruntergeladene Dateien)
~/Videos/       (Videodateien)

Unterstützte Aktionen:
– Neue Dateien und Ordner erstellen
– Dateien umbenennen und löschen
– Textdateien importieren (vom PC)
– Dateien herunterladen
– Änderungen bleiben über Sitzungen erhalten`
      }
    ]
  }
};

// Add built-in PDFs to VFS on first load
(function initPdfVFS() {
  if(!vfs.docs.find(f => f.n === 'Bericht.pdf')) {
    vfs.docs.push({ico:'📋', n:'Bericht.pdf', type:'pdf'});
  }
  if(!vfs.home.find(f => f.n === 'NovOS_Handbuch.pdf')) {
    vfs.home.push({ico:'📋', n:'NovOS_Handbuch.pdf', type:'pdf'});
  }
})();

let pdfCurrentDoc = null;   // key into pdfDocs
let pdfCurrentPage = 0;
let pdfZoom = 1.0;

function buildPDF() {
  return `
    <div class="pdf-toolbar">
      <button class="editor-btn" onclick="pdfOpenFromVFSPicker()">📂 Öffnen</button>
      <button class="editor-btn" onclick="pdfImportFromPC()" title="PDF vom PC importieren">📥 Importieren</button>
      <div class="editor-sep"></div>
      <button class="editor-btn" id="pdf-btn-prev" onclick="pdfGoPage(-1)" disabled>◀</button>
      <span id="pdf-page-info" style="font-size:11px;color:var(--text2);min-width:70px;text-align:center">–</span>
      <button class="editor-btn" id="pdf-btn-next" onclick="pdfGoPage(1)" disabled>▶</button>
      <div class="editor-sep"></div>
      <button class="editor-btn" onclick="pdfZoomOut()">🔍−</button>
      <button class="editor-btn" onclick="pdfZoomIn()">🔍+</button>
      <span id="pdf-zoom-label" style="font-size:11px;color:var(--text2);min-width:38px;text-align:center">100%</span>
      <div class="editor-sep"></div>
      <span id="pdf-doc-title" style="font-size:11px;color:var(--text2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
    </div>
    <div class="pdf-body">
      <div class="pdf-sidebar" id="pdf-sidebar">
        <div class="pdf-sidebar-title">Seiten</div>
        <div id="pdf-thumbs"></div>
      </div>
      <div class="pdf-main" id="pdf-main">
        <div class="pdf-empty" id="pdf-empty">
          <div style="font-size:64px">📋</div>
          <div style="font-size:16px;font-weight:600;color:var(--text)">NovPDF</div>
          <div style="font-size:12px">Öffne ein Dokument aus dem Dateisystem</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px">
            ${Object.entries(pdfDocs).map(([k,d]) =>
              '<button class="setting-btn" onclick="pdfOpenDoc(\'' + k + '\')">' + d.title + '</button>'
            ).join('')}
          </div>
        </div>
      </div>
    </div>`;
}

function initPDF() {
  // nothing needed on open — wait for user to pick a doc
}

function pdfOpenFromVFSPicker() {
  const pdfs = [];
  for(const [dir, files] of Object.entries(vfs)) {
    for(const f of files) {
      if(f.type === 'pdf') {
        const key = dir+'/'+f.n;
        const isImported = !pdfDocs[key] && vfsContents[key]?.startsWith('data:application/pdf');
        const isBuiltin  = !!pdfDocs[key];
        pdfs.push({key, name: f.n, dir, isImported, isBuiltin});
      }
    }
  }

  const main = document.getElementById('pdf-main');
  if(!main) return;

  const listHtml = pdfs.length === 0
    ? '<div style="color:var(--text2);font-size:12px;padding:16px 0">Keine PDF-Dateien im Dateisystem.<br>Importiere eine PDF über den Datei-Manager oder die Schaltfläche unten.</div>'
    : pdfs.map(p => `
        <div onclick="pdfOpenDoc('${p.key}')" style="
          display:flex;align-items:center;gap:12px;padding:12px;
          background:var(--panel2);border:1px solid var(--border);border-radius:10px;
          margin-bottom:8px;cursor:pointer;transition:all 0.15s"
          onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
          <span style="font-size:28px">📋</span>
          <div style="flex:1;min-width:0">
            <div style="font-size:12px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.name}</div>
            <div style="font-size:10px;color:var(--text2)">~/${p.dir}/ · ${p.isImported ? '📥 Importiert' : '📦 Eingebaut'}</div>
          </div>
        </div>`).join('');

  main.innerHTML = `
    <div style="max-width:420px;width:100%;margin-top:24px">
      <div style="font-size:15px;font-weight:700;margin-bottom:16px;color:var(--text)">📂 PDF öffnen</div>
      ${listHtml}
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button class="setting-btn" onclick="pdfImportFromPC()" style="background:var(--accent);color:white;border-color:var(--accent)">📥 Von PC importieren</button>
        <button class="setting-btn" onclick="pdfShowEmpty()">✕ Abbrechen</button>
      </div>
    </div>`;
}

function pdfImportFromPC() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pdf';
  input.multiple = true;
  input.onchange = e => {
    const files = Array.from(e.target.files);
    let done = 0;
    files.forEach(file => {
      const name = file.name;
      const reader = new FileReader();
      reader.onload = ev => {
        const ab = ev.target.result;
        const bytes = new Uint8Array(ab);
        let binary = '';
        for(let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        const dataUri = 'data:application/pdf;base64,' + btoa(binary);
        const dir = 'home'; // import PDFs to home dir
        const key = dir + '/' + name;
        if(!vfs[dir].find(f => f.n === name)) {
          vfs[dir].push({ico:'📋', n:name, type:'pdf'});
        }
        vfsContents[key] = dataUri;
        vfsSave();
        done++;
        if(done === files.length) {
          showNotif('NovPDF', files.length + ' PDF(s) importiert ✓', '#6affca');
          // Open last imported
          pdfOpenDoc(dir + '/' + files[files.length-1].name);
        }
      };
      reader.readAsArrayBuffer(file);
    });
  };
  input.click();
}

function pdfOpenFromVFS(dir, name) {
  openApp('pdf');
  setTimeout(() => pdfOpenDoc(dir+'/'+name), 80);
}

function pdfOpenDoc(key) {
  const doc = pdfDocs[key];
  const stored = vfsContents[key]; // base64 data URI for imported PDFs

  if(!doc && !stored) {
    showNotif('NovPDF', 'Dieses Dokument kann nicht angezeigt werden', '#ff6a8a');
    pdfCurrentDoc = null;
    pdfRender();
    return;
  }

  pdfCurrentDoc = key;
  pdfCurrentPage = 0;
  pdfZoom = 1.0;

  // If it's an imported PDF (base64 in vfsContents), show in iframe
  if(!doc && stored && stored.startsWith('data:application/pdf')) {
    pdfRenderImported(key, stored);
    return;
  }

  pdfRender();
  showNotif('NovPDF', '"' + doc.title + '" geöffnet 📋', '#6affca');
}

function pdfRenderImported(key, dataUri) {
  const main = document.getElementById('pdf-main');
  const thumbs = document.getElementById('pdf-thumbs');
  const titleEl = document.getElementById('pdf-doc-title');
  const pageInfo = document.getElementById('pdf-page-info');
  const btnPrev = document.getElementById('pdf-btn-prev');
  const btnNext = document.getElementById('pdf-btn-next');
  const zoomLabel = document.getElementById('pdf-zoom-label');
  if(!main) return;

  const name = key.split('/').pop();
  if(titleEl) titleEl.textContent = name;
  if(pageInfo) pageInfo.textContent = 'Importiert';
  if(btnPrev) btnPrev.disabled = true;
  if(btnNext) btnNext.disabled = true;
  if(zoomLabel) zoomLabel.textContent = '100%';
  if(thumbs) thumbs.innerHTML = `<div style="padding:8px;text-align:center">
    <div style="font-size:28px;margin-bottom:4px">📋</div>
    <div style="font-size:9px;color:var(--text2);word-break:break-all">${name}</div>
  </div>`;

  main.innerHTML = `<iframe
    src="${dataUri}"
    style="width:100%;height:100%;border:none;flex:1;display:block;background:white"
    title="${name}">
  </iframe>`;

  showNotif('NovPDF', '"' + name + '" geöffnet 📋', '#6affca');
}

function pdfRender() {
  const main = document.getElementById('pdf-main');
  const thumbs = document.getElementById('pdf-thumbs');
  const empty = document.getElementById('pdf-empty');
  const pageInfo = document.getElementById('pdf-page-info');
  const titleEl = document.getElementById('pdf-doc-title');
  const btnPrev = document.getElementById('pdf-btn-prev');
  const btnNext = document.getElementById('pdf-btn-next');
  const zoomLabel = document.getElementById('pdf-zoom-label');
  if(!main) return;

  if(!pdfCurrentDoc || !pdfDocs[pdfCurrentDoc]) {
    pdfShowEmpty(); return;
  }

  const doc = pdfDocs[pdfCurrentDoc];
  const totalPages = doc.pages.length;

  if(empty) empty.style.display = 'none';
  if(titleEl) titleEl.textContent = doc.title + ' — ' + doc.author;
  if(pageInfo) pageInfo.textContent = (pdfCurrentPage+1) + ' / ' + totalPages;
  if(zoomLabel) zoomLabel.textContent = Math.round(pdfZoom*100) + '%';
  if(btnPrev) btnPrev.disabled = pdfCurrentPage <= 0;
  if(btnNext) btnNext.disabled = pdfCurrentPage >= totalPages-1;

  // Render thumbnails
  if(thumbs) {
    thumbs.innerHTML = doc.pages.map((p,i) => `
      <div class="pdf-thumb ${i===pdfCurrentPage?'active':''}" onclick="pdfGoTo(${i})">
        <div class="pdf-thumb-page" style="background:white;padding:8px">
          <div style="font-size:7px;color:#333;line-height:1.4;overflow:hidden;max-height:80px;text-align:left;width:100%">
            <strong style="display:block;margin-bottom:3px;font-size:6px">${p.heading}</strong>
            ${p.body.slice(0,200)}
          </div>
        </div>
        <div class="pdf-thumb-num">Seite ${i+1}</div>
      </div>`).join('');
  }

  // Render current page
  const page = doc.pages[pdfCurrentPage];
  const scale = pdfZoom;

  // Find or create page container (keep scroll pos)
  let pageContainer = document.getElementById('pdf-page-container');
  if(!pageContainer) {
    // Clear main and rebuild
    main.innerHTML = '';
    pageContainer = document.createElement('div');
    pageContainer.id = 'pdf-page-container';
    pageContainer.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:0;width:100%;';
    main.appendChild(pageContainer);
  }

  pageContainer.innerHTML = `
    <div class="pdf-page" style="transform:scale(${scale});transform-origin:top center;margin-bottom:${(scale-1)*800+20}px">
      <div class="pdf-page-content">
        <h2 style="font-size:16px;font-weight:700;color:#1a1a2e;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #e0e0f0">${page.heading}</h2>
        <div style="white-space:pre-wrap;color:#2c2c3e">${page.body}</div>
      </div>
      <div class="pdf-page-num">— ${pdfCurrentPage+1} —</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;justify-content:center;flex-shrink:0">
      <button class="setting-btn" onclick="pdfGoPage(-1)" ${pdfCurrentPage<=0?'disabled':''}>◀ Zurück</button>
      <button class="setting-btn" onclick="pdfGoPage(1)"  ${pdfCurrentPage>=totalPages-1?'disabled':''}>Weiter ▶</button>
    </div>`;

  main.scrollTop = 0;
}

function pdfShowEmpty() {
  const main = document.getElementById('pdf-main');
  if(!main) return;
  pdfCurrentDoc = null;
  main.innerHTML = `
    <div class="pdf-empty" id="pdf-empty">
      <div style="font-size:64px">📋</div>
      <div style="font-size:16px;font-weight:600;color:var(--text)">NovPDF</div>
      <div style="font-size:12px">Öffne oder importiere ein PDF-Dokument</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px">
        ${Object.entries(pdfDocs).map(([k,d]) =>
          '<button class="setting-btn" onclick="pdfOpenDoc(\'' + k + '\')">' + d.title + '</button>'
        ).join('')}
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="setting-btn" onclick="pdfOpenFromVFSPicker()">📂 Aus Dateisystem</button>
        <button class="setting-btn" style="background:var(--accent);color:white;border-color:var(--accent)" onclick="pdfImportFromPC()">📥 Von PC importieren</button>
      </div>
    </div>`;
}

function pdfGoPage(delta) {
  if(!pdfCurrentDoc) return;
  const total = pdfDocs[pdfCurrentDoc].pages.length;
  pdfCurrentPage = Math.max(0, Math.min(total-1, pdfCurrentPage + delta));
  pdfRender();
}
function pdfGoTo(idx) {
  pdfCurrentPage = idx;
  pdfRender();
}
function pdfZoomIn()  { pdfZoom = Math.min(2.0, pdfZoom + 0.15); pdfRender(); }
function pdfZoomOut() { pdfZoom = Math.max(0.5, pdfZoom - 0.15); pdfRender(); }

// ══════════════════════════════════════
// GALLERY
// ══════════════════════════════════════
// ══════════════════════════════════════
// WEATHER
// ══════════════════════════════════════
const weatherCities = {
  'Nova City':    { temp:18, feels:15, desc:'Teilweise bewölkt',   ico:'⛅', humidity:68, wind:12, visibility:8,  uv:4, pressure:1013, sunrise:'07:12', sunset:'18:44' },
  'Berlin':       { temp:8,  feels:5,  desc:'Bedeckt',             ico:'☁️', humidity:82, wind:22, visibility:5,  uv:1, pressure:1002, sunrise:'07:45', sunset:'17:30' },
  'München':      { temp:5,  feels:2,  desc:'Leichter Schneefall', ico:'🌨️', humidity:90, wind:8,  visibility:3,  uv:1, pressure:994,  sunrise:'07:50', sunset:'17:20' },
  'Hamburg':      { temp:6,  feels:3,  desc:'Regen',               ico:'🌧️', humidity:88, wind:28, visibility:4,  uv:1, pressure:998,  sunrise:'07:40', sunset:'17:35' },
  'Wien':         { temp:7,  feels:4,  desc:'Neblig',              ico:'🌫️', humidity:93, wind:5,  visibility:1,  uv:0, pressure:1008, sunrise:'07:35', sunset:'17:28' },
  'Zürich':       { temp:4,  feels:0,  desc:'Schnee',              ico:'❄️', humidity:95, wind:10, visibility:2,  uv:1, pressure:990,  sunrise:'07:55', sunset:'17:15' },
  'Madrid':       { temp:16, feels:14, desc:'Sonnig',              ico:'☀️', humidity:45, wind:15, visibility:14, uv:6, pressure:1018, sunrise:'08:00', sunset:'18:20' },
  'Paris':        { temp:10, feels:7,  desc:'Leichter Regen',      ico:'🌦️', humidity:76, wind:18, visibility:6,  uv:2, pressure:1006, sunrise:'08:10', sunset:'17:45' },
  'London':       { temp:9,  feels:6,  desc:'Bewölkt',             ico:'🌥️', humidity:78, wind:20, visibility:7,  uv:2, pressure:1010, sunrise:'08:00', sunset:'17:50' },
  'New York':     { temp:3,  feels:-2, desc:'Klar und kalt',       ico:'🌬️', humidity:55, wind:32, visibility:16, uv:3, pressure:1024, sunrise:'07:15', sunset:'17:00' },
  'Tokyo':        { temp:12, feels:9,  desc:'Klar',                ico:'☀️', humidity:52, wind:8,  visibility:20, uv:5, pressure:1016, sunrise:'06:30', sunset:'17:10' },
  'Dubai':        { temp:28, feels:30, desc:'Sonnig & heiß',       ico:'☀️', humidity:38, wind:14, visibility:18, uv:9, pressure:1012, sunrise:'06:45', sunset:'18:00' },
};

let weatherCurrentCity = 'Nova City';
let weatherUnit = 'C';

function weatherGetData(city) {
  const d = weatherCities[city] || weatherCities['Nova City'];
  return d;
}

function buildWeather() {
  return `<div class="weather-shell" id="weather-shell"></div>`;
}

function initWeather() { weatherRender(); }

function weatherRender() {
  const shell = document.getElementById('weather-shell'); if(!shell) return;
  const d = weatherGetData(weatherCurrentCity);
  const temp = weatherUnit === 'F' ? Math.round(d.temp * 9/5 + 32) : d.temp;
  const feels = weatherUnit === 'F' ? Math.round(d.feels * 9/5 + 32) : d.feels;
  const unit = '°' + weatherUnit;

  // Generate hourly forecast (random variation around current)
  const now = new Date();
  const hourly = Array.from({length: 12}, (_, i) => {
    const h = (now.getHours() + i) % 24;
    const variation = Math.round((Math.random() - 0.5) * 6);
    const t = (weatherUnit === 'F') ? Math.round((d.temp + variation) * 9/5 + 32) : (d.temp + variation);
    const icons = ['☀️','🌤️','⛅','🌥️','☁️','🌧️','⛈️','🌨️'];
    const ico = i < 2 ? d.ico : icons[Math.floor(Math.random() * 4)];
    const rain = Math.floor(Math.random() * 40);
    return {h, t, ico, rain, isNow: i === 0};
  });

  // 7-day forecast
  const days = ['So','Mo','Di','Mi','Do','Fr','Sa'];
  const dayForecast = Array.from({length: 7}, (_, i) => {
    const dayIdx = (now.getDay() + i) % 7;
    const hi = d.temp + Math.round(Math.random()*8 - 2);
    const lo = hi - Math.round(Math.random()*8 + 4);
    const hiF = Math.round(hi * 9/5 + 32), loF = Math.round(lo * 9/5 + 32);
    const icons = ['☀️','🌤️','⛅','🌥️','☁️','🌧️','🌨️'];
    const ico = i === 0 ? d.ico : icons[Math.floor(Math.random() * icons.length)];
    const rain = Math.floor(Math.random() * 80);
    return {
      day: i === 0 ? 'Heute' : i === 1 ? 'Morgen' : days[dayIdx],
      ico, rain,
      hi: weatherUnit === 'F' ? hiF : hi,
      lo: weatherUnit === 'F' ? loF : lo
    };
  });

  shell.innerHTML = `
    <div class="weather-search-bar">
      <input class="weather-search-inp" id="weather-city-inp" type="text" placeholder="🔍 Stadt suchen…"
        value="${weatherCurrentCity}"
        onkeydown="if(event.key==='Enter')weatherSearch(this.value)"
        list="weather-cities-list">
      <datalist id="weather-cities-list">
        ${Object.keys(weatherCities).map(c => `<option value="${c}">`).join('')}
      </datalist>
      <button class="editor-btn" onclick="weatherSearch(document.getElementById('weather-city-inp').value)" style="white-space:nowrap">🔍 Suchen</button>
      <button class="editor-btn" onclick="weatherUnit=weatherUnit==='C'?'F':'C';weatherRender()" style="white-space:nowrap">${unit === '°C' ? '→°F' : '→°C'}</button>
    </div>

    <div class="weather-hero">
      <div class="weather-anim-icon">${d.ico}</div>
      <div class="weather-temp-big">${temp}${unit}</div>
      <div class="weather-feels">Gefühlt wie ${feels}${unit}</div>
      <div class="weather-desc-big">${d.desc}</div>
      <div class="weather-location">📍 ${weatherCurrentCity}</div>
    </div>

      <div class="weather-stats">
      <div class="weather-stat"><div class="weather-stat-ico">💧</div><div class="weather-stat-val">${d.humidity}%</div><div class="weather-stat-label">Luftfeuchte</div></div>
      <div class="weather-stat"><div class="weather-stat-ico">💨</div><div class="weather-stat-val">${d.wind} km/h</div><div class="weather-stat-label">Wind</div></div>
      <div class="weather-stat"><div class="weather-stat-ico">👁️</div><div class="weather-stat-val">${d.visibility} km</div><div class="weather-stat-label">Sicht</div></div>
      <div class="weather-stat"><div class="weather-stat-ico">🌡️</div><div class="weather-stat-val">${d.pressure} hPa</div><div class="weather-stat-label">Luftdruck</div></div>
      <div class="weather-stat"><div class="weather-stat-ico">☀️</div><div class="weather-stat-val">UV ${d.uv}</div><div class="weather-stat-label">UV-Index</div></div>
      <div class="weather-stat"><div class="weather-stat-ico">🌅</div><div class="weather-stat-val">${d.sunrise}</div><div class="weather-stat-label">Sonnenaufgang</div></div>
      <div class="weather-stat"><div class="weather-stat-ico">🌇</div><div class="weather-stat-val">${d.sunset}</div><div class="weather-stat-label">Sonnenuntergang</div></div>
      <div class="weather-stat"><div class="weather-stat-ico">👁️‍🗨️</div><div class="weather-stat-val">${feels}${unit}</div><div class="weather-stat-label">Gefühlt</div></div>
    </div>

    <div class="weather-hourly">
      ${hourly.map(h => `
        <div class="weather-hour${h.isNow?' now':''}">
          <div class="wh-time">${h.isNow ? 'Jetzt' : String(h.h).padStart(2,'0')+':00'}</div>
          <div class="wh-ico">${h.ico}</div>
          <div class="wh-temp">${h.t}${unit}</div>
          <div class="wh-rain">${h.rain ? h.rain+'%💧' : '—'}</div>
        </div>`).join('')}
    </div>

    <div class="weather-forecast-section">
      <div class="weather-forecast-title">7-Tage-Vorhersage</div>
      ${dayForecast.map(day => {
        const range = day.hi - day.lo;
        const pct = Math.max(10, Math.min(90, ((day.hi - d.temp + 10) / 20) * 100));
        return `<div class="forecast-row">
          <span class="forecast-day">${day.day}</span>
          <span class="forecast-ico">${day.ico}</span>
          <div class="forecast-bar-wrap" style="flex:1">
            <div class="forecast-bar-fill" style="left:${100-pct}%;width:${pct*0.6}%"></div>
          </div>
          <span class="forecast-temps">${day.hi}${unit} <span class="low">${day.lo}${unit}</span></span>
        </div>`;
      }).join('')}
    </div>`;
}

function weatherSearch(city) {
  const match = Object.keys(weatherCities).find(c => c.toLowerCase() === city.toLowerCase()) || city;
  if(weatherCities[match]) {
    weatherCurrentCity = match;
    weatherRender();
  } else {
    showNotif('NovWetter', '"' + city + '" nicht gefunden. Versuche: Berlin, München, Hamburg, Wien…', '#ff6a8a');
  }
}

// ══════════════════════════════════════
// SYSTEM MONITOR
// ══════════════════════════════════════
let sysmonInterval = null;
let sysmonTab = 'overview';
let sysmonSortCol = 'cpu';
let sysmonSortDir = -1; // -1=desc, 1=asc
const SM_TOTAL_RAM = 16;
const SM_TOTAL_DISK = 512;
let cpuHistory = Array(60).fill(0);
let ramHistory = Array(60).fill(0);
let netUpHistory = Array(60).fill(0);
let netDownHistory = Array(60).fill(0);

const smProcesses = [
  { pid: 1,    name: 'systemd',         user: 'root',  cpu: 0.1, mem: 8.2,   status: 'S', cmd: '/sbin/init' },
  { pid: 892,  name: 'novd',            user: 'root',  cpu: 0.8, mem: 64,    status: 'S', cmd: '/usr/sbin/novd' },
  { pid: 1120, name: 'net-manager',     user: 'root',  cpu: 0.2, mem: 32,    status: 'S', cmd: '/usr/sbin/net-manager' },
  { pid: 1203, name: 'Xorg',            user: 'root',  cpu: 3.4, mem: 256,   status: 'R', cmd: '/usr/bin/Xorg :0' },
  { pid: 1445, name: 'audio-server',    user: 'user',  cpu: 0.9, mem: 48,    status: 'S', cmd: '/usr/bin/audio-server' },
  { pid: 1842, name: 'novshell',        user: 'user',  cpu: 2.1, mem: 184,   status: 'S', cmd: '/usr/bin/novshell --session' },
  { pid: 2012, name: 'dbus-daemon',     user: 'user',  cpu: 0.1, mem: 12,    status: 'S', cmd: '/usr/bin/dbus-daemon --session' },
  { pid: 2103, name: 'update-service',  user: 'root',  cpu: 0.0, mem: 28,    status: 'S', cmd: '/usr/sbin/update-service' },
  { pid: 2567, name: 'novbar',          user: 'user',  cpu: 0.4, mem: 44,    status: 'S', cmd: '/usr/bin/novbar' },
  { pid: 2891, name: 'NovBrowser',      user: 'user',  cpu: 8.2, mem: 512,   status: 'R', cmd: '/usr/bin/NovBrowser --renderer' },
  { pid: 3012, name: 'NovBrowser:GPU',  user: 'user',  cpu: 1.4, mem: 128,   status: 'S', cmd: '/usr/bin/NovBrowser --gpu' },
  { pid: 3104, name: 'NovEdit',         user: 'user',  cpu: 0.6, mem: 128,   status: 'S', cmd: '/usr/bin/NovEdit' },
  { pid: 3201, name: 'NovSysmon',       user: 'user',  cpu: 0.3, mem: 24,    status: 'R', cmd: '/usr/bin/NovSysmon' },
  { pid: 3345, name: 'NovMusic',        user: 'user',  cpu: 1.2, mem: 96,    status: 'S', cmd: '/usr/bin/NovMusic' },
  { pid: 3512, name: 'novterm',         user: 'user',  cpu: 0.1, mem: 20,    status: 'S', cmd: '/usr/bin/novterm' },
  { pid: 4001, name: 'kworker/0:1',     user: 'root',  cpu: 0.0, mem: 0,     status: 'S', cmd: '[kworker/0:1]' },
  { pid: 4102, name: 'sshd',            user: 'root',  cpu: 0.0, mem: 6,     status: 'S', cmd: '/usr/sbin/sshd' },
];

let smProcs = smProcesses.map(p => ({...p}));
let smKilledPids = new Set();

function buildSysmon() {
  return `
    <div style="display:flex;flex-direction:column;flex:1;overflow:hidden">
      <div class="sysmon-tabs">
        <button class="sysmon-tab active" id="smt-overview" onclick="sysmonSwitchTab('overview',this)">📊 Übersicht</button>
        <button class="sysmon-tab" id="smt-processes" onclick="sysmonSwitchTab('processes',this)">⚙️ Prozesse</button>
        <button class="sysmon-tab" id="smt-resources" onclick="sysmonSwitchTab('resources',this)">📈 Ressourcen</button>
        <button class="sysmon-tab" id="smt-disk" onclick="sysmonSwitchTab('disk',this)">💾 Datenträger</button>
      </div>
      <div class="sysmon-pane" id="sysmon-content"></div>
    </div>`;
}

function initSysmon() {
  sysmonTab = 'overview';
  sysmonRenderTab();
  sysmonInterval = setInterval(() => {
    sysmonTick();
    sysmonRenderTab();
  }, 1500);
}

function sysmonTick() {
  // Update process CPU/mem with realistic variation
  smProcs.forEach(p => {
    if(smKilledPids.has(p.pid)) return;
    p.cpu = Math.max(0, p.cpu + (Math.random()-0.5)*2);
    p.cpu = Math.min(p.cpu, p.name.includes('Browser') ? 25 : p.name === 'Xorg' ? 12 : 6);
    p.mem = Math.max(1, p.mem + (Math.random()-0.5)*4);
  });

  const totalCpu = smProcs.filter(p=>!smKilledPids.has(p.pid)).reduce((s,p)=>s+p.cpu,0);
  const cpu = Math.min(100, totalCpu);
  cpuHistory.push(cpu); cpuHistory.shift();
  const ram = SM_TOTAL_RAM * 0.3 + (Math.random()-0.5)*0.5;
  ramHistory.push(ram); ramHistory.shift();
  netUpHistory.push((Math.random()*3).toFixed(1)*1); netUpHistory.shift();
  netDownHistory.push((Math.random()*15).toFixed(1)*1); netDownHistory.shift();
}

function sysmonSwitchTab(tab, el) {
  sysmonTab = tab;
  document.querySelectorAll('.sysmon-tab').forEach(t => t.classList.remove('active'));
  if(el) el.classList.add('active');
  sysmonRenderTab();
}

function sysmonRenderTab() {
  const c = document.getElementById('sysmon-content'); if(!c) return;
  if(sysmonTab === 'overview') sysmonRenderOverview(c);
  else if(sysmonTab === 'processes') sysmonRenderProcesses(c);
  else if(sysmonTab === 'resources') sysmonRenderResources(c);
  else if(sysmonTab === 'disk') sysmonRenderDisk(c);
}

function sysmonSparkline(data, color, h=32) {
  const w = 200, max = Math.max(1, ...data);
  const pts = data.map((v,i) => `${i*(w/(data.length-1))},${h-1-(v/max*(h-2))}`).join(' ');
  return `<svg width="${w}" height="${h}" style="display:block"><polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round"/></svg>`;
}

function sysmonRenderOverview(c) {
  const cpu = cpuHistory[cpuHistory.length-1].toFixed(1);
  const ram = ramHistory[ramHistory.length-1];
  const ramPct = (ram/SM_TOTAL_RAM*100).toFixed(0);
  const netUp = netUpHistory[netUpHistory.length-1].toFixed(1);
  const netDown = netDownHistory[netDownHistory.length-1].toFixed(1);
  const diskUsed = 128, diskPct = (diskUsed/SM_TOTAL_DISK*100).toFixed(0);
  const activeProcs = smProcs.filter(p=>!smKilledPids.has(p.pid)).length;

  c.innerHTML = `
    <div class="sysmon-overview">
      <div class="sysmon-card">
        <div class="sysmon-card-title">CPU <span style="font-weight:400;color:var(--text2)">Nova-Core i9 · 8 Kerne</span></div>
        <div class="sysmon-val-row"><span class="sysmon-big">${cpu}%</span><span class="sysmon-sub">von 100%</span></div>
        <div class="bar-track"><div class="bar-fill" style="background:linear-gradient(90deg,var(--accent),var(--accent2));width:${cpu}%"></div></div>
        <div class="sysmon-label-row"><span>0%</span><span>50%</span><span>100%</span></div>
        ${sysmonSparkline(cpuHistory, 'var(--accent)')}
      </div>
      <div class="sysmon-card">
        <div class="sysmon-card-title">Arbeitsspeicher <span style="font-weight:400;color:var(--text2)">DDR5-4800</span></div>
        <div class="sysmon-val-row"><span class="sysmon-big">${ram.toFixed(1)} GB</span><span class="sysmon-sub">von ${SM_TOTAL_RAM} GB (${ramPct}%)</span></div>
        <div class="bar-track"><div class="bar-fill" style="background:linear-gradient(90deg,var(--accent3),#00b4db);width:${ramPct}%"></div></div>
        <div class="sysmon-label-row"><span>0</span><span>${SM_TOTAL_RAM/2}GB</span><span>${SM_TOTAL_RAM}GB</span></div>
        ${sysmonSparkline(ramHistory.map(v=>v/SM_TOTAL_RAM*100), 'var(--accent3)')}
      </div>
      <div class="sysmon-card">
        <div class="sysmon-card-title">Netzwerk <span style="font-weight:400;color:var(--text2)">NovNet 1Gbps</span></div>
        <div class="sysmon-val-row">
          <span class="sysmon-big" style="font-size:20px">↑ ${netUp} <span class="sysmon-sub">MB/s</span></span>
          <span class="sysmon-big" style="font-size:20px;margin-left:16px">↓ ${netDown} <span class="sysmon-sub">MB/s</span></span>
        </div>
        <div style="display:flex;gap:8px;margin-top:4px">
          ${sysmonSparkline(netUpHistory, '#6affca', 28)}
          ${sysmonSparkline(netDownHistory, '#ffca6a', 28)}
        </div>
      </div>
      <div class="sysmon-card">
        <div class="sysmon-card-title">Datenträger <span style="font-weight:400;color:var(--text2)">NovSSD Gen4</span></div>
        <div class="sysmon-val-row"><span class="sysmon-big">${diskUsed} GB</span><span class="sysmon-sub">von ${SM_TOTAL_DISK} GB (${diskPct}%)</span></div>
        <div class="bar-track"><div class="bar-fill" style="background:linear-gradient(90deg,#f7971e,#ffd200);width:${diskPct}%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text2);margin-top:6px">
          <span>Lesen: 3.2 GB/s</span><span>Schreiben: 2.8 GB/s</span>
        </div>
      </div>
    </div>
    <div class="sysmon-card">
      <div class="sysmon-card-title">Systeminfo</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px 24px;font-size:11px">
        ${[['OS','NovOS 3.1.0 (nova-6.4.2-lts)'],['Uptime','12 Std. 43 Min.'],['CPU','Nova-Core i9-14900K @ 3.2GHz'],['Kerne','8 Kerne / 16 Threads'],['RAM','16 GB DDR5-4800'],['GPU','NovGPU RTX 5080'],['Hostname','novos-desktop'],['Prozesse',activeProcs+' aktiv / '+smProcs.length+' gesamt']].map(([k,v])=>`
          <div><span style="color:var(--text2)">${k}:</span> <span style="color:var(--text);font-weight:600">${v}</span></div>`).join('')}
      </div>
    </div>`;
}

function sysmonRenderProcesses(c) {
  const alive = smProcs.filter(p => !smKilledPids.has(p.pid));
  const sorted = [...alive].sort((a,b) => {
    const va = a[sysmonSortCol], vb = b[sysmonSortCol];
    return typeof va === 'string' ? va.localeCompare(vb)*sysmonSortDir : (vb-va)*sysmonSortDir;
  });

  const totalCpu = alive.reduce((s,p)=>s+p.cpu,0).toFixed(1);
  const totalMem = alive.reduce((s,p)=>s+p.mem,0);

  const cols = [
    {key:'pid',  label:'PID',    w:'55px'},
    {key:'name', label:'Name',   w:'1fr'},
    {key:'user', label:'Benutzer',w:'80px'},
    {key:'status',label:'Status',w:'60px'},
    {key:'cpu',  label:'CPU %',  w:'70px'},
    {key:'mem',  label:'RAM MB', w:'70px'},
    {key:'_kill',label:'',       w:'36px'},
  ];

  c.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:0 0 10px;flex-shrink:0">
      <span style="font-size:12px;color:var(--text2)">${alive.length} Prozesse · CPU gesamt: <span style="color:var(--accent)">${totalCpu}%</span> · RAM gesamt: <span style="color:var(--accent3)">${(totalMem/1024).toFixed(1)} GB</span></span>
      <input type="text" id="sm-proc-search" placeholder="Filtern…" style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:4px 10px;color:var(--text);font-family:'Inter',sans-serif;font-size:11px;outline:none;width:140px" oninput="sysmonRenderTab()">
    </div>
    <div style="overflow-y:auto;flex:1">
      <table class="proc-table" style="width:100%">
        <thead><tr>${cols.map(col => col.key === '_kill' ? '<th></th>' :
          `<th onclick="sysmonSortProc('${col.key}')" style="width:${col.w};cursor:pointer">
            ${col.label} ${sysmonSortCol===col.key?(sysmonSortDir<0?'↓':'↑'):''}
          </th>`).join('')}</tr></thead>
        <tbody>${sorted.filter(p => {
          const search = document.getElementById('sm-proc-search')?.value?.toLowerCase() || '';
          return !search || p.name.toLowerCase().includes(search) || String(p.pid).includes(search);
        }).map(p => {
          const cpuBar = `<span class="proc-cpu-bar" style="width:${Math.min(80,p.cpu*3)}px"></span>`;
          const statusColor = p.status === 'R' ? 'var(--accent3)' : 'var(--text2)';
          return `<tr>
            <td style="color:var(--text2)">${p.pid}</td>
            <td><span style="font-weight:600;color:var(--text)">${p.name}</span><span style="color:var(--text2);font-size:10px;margin-left:6px">${p.cmd.length>30?p.cmd.slice(0,30)+'…':p.cmd}</span></td>
            <td>${p.user}</td>
            <td><span style="color:${statusColor};font-weight:600">${p.status === 'R' ? '● Aktiv' : '◌ Warten'}</span></td>
            <td>${p.cpu.toFixed(1)}%${cpuBar}</td>
            <td>${p.mem.toFixed(0)}</td>
            <td><button class="kill-btn" onclick="sysmonKillProc(${p.pid})" title="Prozess beenden">✕</button></td>
          </tr>`;
        }).join('')}</tbody>
      </table>
    </div>`;
}

function sysmonSortProc(col) {
  if(sysmonSortCol === col) sysmonSortDir *= -1;
  else { sysmonSortCol = col; sysmonSortDir = -1; }
  sysmonRenderTab();
}

async function sysmonKillProc(pid) {
  const p = smProcs.find(pr => pr.pid === pid);
  if(!p) return;
  const ok = await novDialog({
    icon:'⚠️', title:'Prozess beenden',
    msg:`"${p.name}" (PID ${pid}) wirklich beenden?\nUngespeicherte Daten gehen verloren.`,
    confirmLabel:'Beenden', danger:true
  });
  if(!ok) return;
  smKilledPids.add(pid);
  showNotif('System-Monitor', '"' + p.name + '" (PID '+pid+') beendet', '#ff6a8a');
  sysmonRenderTab();
}

function sysmonRenderResources(c) {
  c.innerHTML = `
    <div class="sysmon-card">
      <div class="sysmon-card-title">CPU-Verlauf (letzte 60s)</div>
      <svg width="100%" height="80" viewBox="0 0 600 80" preserveAspectRatio="none" style="display:block">
        <defs><linearGradient id="cpuGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent)" stop-opacity="0.3"/><stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/></linearGradient></defs>
        <polygon points="${cpuHistory.map((v,i)=>`${i*(600/59)},${79-v*0.77}`).join(' ')} 600,79 0,79" fill="url(#cpuGrad)"/>
        <polyline points="${cpuHistory.map((v,i)=>`${i*(600/59)},${79-v*0.77}`).join(' ')}" fill="none" stroke="var(--accent)" stroke-width="2"/>
      </svg>
      <div class="sysmon-label-row"><span>vor 60s</span><span>vor 30s</span><span>jetzt</span></div>
    </div>
    <div class="sysmon-card">
      <div class="sysmon-card-title">RAM-Verlauf (letzte 60s)</div>
      <svg width="100%" height="80" viewBox="0 0 600 80" preserveAspectRatio="none" style="display:block">
        <defs><linearGradient id="ramGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--accent3)" stop-opacity="0.3"/><stop offset="100%" stop-color="var(--accent3)" stop-opacity="0"/></linearGradient></defs>
        <polygon points="${ramHistory.map((v,i)=>`${i*(600/59)},${79-(v/SM_TOTAL_RAM)*77}`).join(' ')} 600,79 0,79" fill="url(#ramGrad)"/>
        <polyline points="${ramHistory.map((v,i)=>`${i*(600/59)},${79-(v/SM_TOTAL_RAM)*77}`).join(' ')}" fill="none" stroke="var(--accent3)" stroke-width="2"/>
      </svg>
      <div class="sysmon-label-row"><span>vor 60s</span><span>vor 30s</span><span>jetzt (${ramHistory[59]?.toFixed(1)} GB)</span></div>
    </div>
    <div class="sysmon-card">
      <div class="sysmon-card-title">Netzwerk ↑↓ (letzte 60s)</div>
      <svg width="100%" height="80" viewBox="0 0 600 80" preserveAspectRatio="none" style="display:block">
        <polyline points="${netDownHistory.map((v,i)=>`${i*(600/59)},${79-Math.min(v/20,1)*77}`).join(' ')}" fill="none" stroke="#ffca6a" stroke-width="1.5"/>
        <polyline points="${netUpHistory.map((v,i)=>`${i*(600/59)},${79-Math.min(v/10,1)*77}`).join(' ')}" fill="none" stroke="#6affca" stroke-width="1.5"/>
      </svg>
      <div style="display:flex;gap:16px;font-size:10px;margin-top:4px">
        <span style="color:#ffca6a">↓ Download</span>
        <span style="color:#6affca">↑ Upload</span>
      </div>
    </div>`;
}

function sysmonRenderDisk(c) {
  const partitions = [
    {mount:'/',       label:'System',     used:47,  total:128, color:'var(--accent)',  fs:'ext4'},
    {mount:'/home',   label:'Privat',     used:81,  total:256, color:'var(--accent3)', fs:'ext4'},
    {mount:'/boot',   label:'Boot',       used:0.3, total:1,   color:'var(--accent2)', fs:'vfat'},
    {mount:'/var',    label:'Variabel',   used:12,  total:64,  color:'#ffca6a',        fs:'ext4'},
    {mount:'/tmp',    label:'Temporär',   used:0.8, total:8,   color:'#6affca',        fs:'tmpfs'},
  ];
  c.innerHTML = `
    <div class="sysmon-card">
      <div class="sysmon-card-title">Datenträger-Übersicht · NovSSD Gen4 PCIe 5.0</div>
      <div style="display:flex;gap:16px;font-size:11px;margin-bottom:12px;color:var(--text2)">
        <span>Modell: Nova Storage NV2000</span>
        <span>Lesen: 3.2 GB/s</span>
        <span>Schreiben: 2.8 GB/s</span>
        <span>Temperatur: 38°C</span>
      </div>
      ${partitions.map(p => {
        const pct = (p.used/p.total*100).toFixed(0);
        const usedStr = p.used < 1 ? (p.used*1024).toFixed(0)+' MB' : p.used+' GB';
        const totalStr = p.total < 1 ? (p.total*1024).toFixed(0)+' MB' : p.total+' GB';
        return `
          <div style="margin-bottom:14px">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px">
              <span style="font-weight:600;color:var(--text)">${p.label}</span>
              <span style="color:var(--text2);font-size:10px">${p.mount} · ${p.fs} · ${usedStr} / ${totalStr}</span>
              <span style="color:${p.color};font-weight:700">${pct}%</span>
            </div>
            <div class="bar-track">
              <div class="bar-fill" style="background:${p.color};width:${pct}%"></div>
            </div>
          </div>`;
      }).join('')}
    </div>
    <div class="sysmon-card">
      <div class="sysmon-card-title">I/O-Aktivität</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:12px">
        ${[['📖 Gelesen','1.24 TB'],['✏️ Geschrieben','0.87 TB'],['⚡ Lesen','3.2 GB/s'],['⚡ Schreiben','2.8 GB/s'],['🔄 IOPS (Lesen)','890.000'],['🔄 IOPS (Schreiben)','780.000']].map(([k,v])=>`
          <div style="background:var(--panel2);padding:10px;border-radius:8px;border:1px solid var(--border)">
            <div style="color:var(--text2);font-size:10px">${k}</div>
            <div style="font-size:15px;font-weight:700;color:var(--text);margin-top:3px">${v}</div>
          </div>`).join('')}
      </div>
    </div>`;
}

// ══════════════════════════════════════
// CLOCK APP
// ══════════════════════════════════════
let clockInterval = null;
let clockTab = 'clock';

// Stopwatch
let swRunning = false, swInterval = null;
let swElapsed = 0; // ms
let swLaps = [];

// Timer
let timerInterval = null, timerRunning = false;
let timerTotal = 0, timerRemaining = 0;

// Alarms
let alarms = [
  { time:'07:00', label:'Aufstehen', enabled:true },
  { time:'09:00', label:'Meeting',   enabled:false },
  { time:'13:00', label:'Mittagspause', enabled:true },
];

const worldClocks = [
  { city:'New York',  tz:'America/New_York',   flag:'🇺🇸' },
  { city:'London',    tz:'Europe/London',       flag:'🇬🇧' },
  { city:'Berlin',    tz:'Europe/Berlin',       flag:'🇩🇪' },
  { city:'Dubai',     tz:'Asia/Dubai',          flag:'🇦🇪' },
  { city:'Tokio',     tz:'Asia/Tokyo',          flag:'🇯🇵' },
  { city:'Sydney',    tz:'Australia/Sydney',    flag:'🇦🇺' },
];

function buildClock() {
  return `
    <div class="clock-shell">
      <div class="clock-tabs">
        <button class="clock-tab active" id="ct-clock"    onclick="clockSwitchTab('clock',this)">🕐 Uhr</button>
        <button class="clock-tab"        id="ct-world"    onclick="clockSwitchTab('world',this)">🌍 Weltuhr</button>
        <button class="clock-tab"        id="ct-stopwatch"onclick="clockSwitchTab('stopwatch',this)">⏱ Stoppuhr</button>
        <button class="clock-tab"        id="ct-timer"    onclick="clockSwitchTab('timer',this)">⏳ Timer</button>
        <button class="clock-tab"        id="ct-alarm"    onclick="clockSwitchTab('alarm',this)">🔔 Wecker</button>
      </div>
      <div class="clock-pane" id="clock-pane"></div>
    </div>`;
}

function initClock() {
  clockTab = 'clock';
  clockRenderTab();
  clockInterval = setInterval(() => {
    if(clockTab === 'clock') clockRenderAnalog();
    if(clockTab === 'world') clockRenderWorld();
    clockCheckAlarms();
  }, 1000);
}

function clockSwitchTab(tab, el) {
  clockTab = tab;
  document.querySelectorAll('.clock-tab').forEach(t => t.classList.remove('active'));
  if(el) el.classList.add('active');
  clockRenderTab();
}

function clockRenderTab() {
  const pane = document.getElementById('clock-pane'); if(!pane) return;
  if(clockTab === 'clock')     { clockRenderMain(pane); }
  else if(clockTab === 'world'){ clockRenderWorld(pane); }
  else if(clockTab === 'stopwatch') { clockRenderStopwatch(pane); }
  else if(clockTab === 'timer'){ clockRenderTimerTab(pane); }
  else if(clockTab === 'alarm'){ clockRenderAlarms(pane); }
}

function clockRenderMain(pane) {
  pane = pane || document.getElementById('clock-pane');
  if(!pane) return;
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
  const ms = now.getMilliseconds();
  const dateStr = now.toLocaleDateString('de-DE', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  const h12 = h % 12 || 12;
  const ampm = h < 12 ? 'AM' : 'PM';
  const hAngle = (h % 12) * 30 + m * 0.5;
  const mAngle = m * 6 + s * 0.1;
  const sAngle = s * 6 + ms * 0.006;

  // Generate 60 tick dots + 12 hour numbers
  let dotsHtml = '';
  for(let i = 0; i < 60; i++) {
    const angle = i * 6 - 90;
    const rad = angle * Math.PI / 180;
    const isMajor = i % 5 === 0;
    const r = isMajor ? 82 : 86;
    const x = 100 + r * Math.cos(rad);
    const y = 100 + r * Math.sin(rad);
    if(isMajor) {
      const hr = i / 5 || 12;
      const nr = 72;
      const nx = 100 + nr * Math.cos(rad);
      const ny = 100 + nr * Math.sin(rad);
      dotsHtml += `<text x="${nx}" y="${ny}" text-anchor="middle" dominant-baseline="central" fill="rgba(255,255,255,0.5)" font-size="10" font-weight="700" font-family="Inter,sans-serif">${hr}</text>`;
      dotsHtml += `<circle cx="${x}" cy="${y}" r="3" fill="rgba(255,255,255,0.4)"/>`;
    } else {
      dotsHtml += `<circle cx="${x}" cy="${y}" r="1" fill="rgba(255,255,255,0.15)"/>`;
    }
  }

  pane.innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;gap:20px;width:100%;padding-top:8px">
      <!-- Analog Clock SVG -->
      <svg width="220" height="220" viewBox="0 0 200 200" style="filter:drop-shadow(0 8px 32px rgba(0,0,0,0.5))">
        <!-- Face -->
        <defs>
          <radialGradient id="faceGrad" cx="40%" cy="35%" r="70%">
            <stop offset="0%" stop-color="#1e1e32"/>
            <stop offset="100%" stop-color="#0a0a16"/>
          </radialGradient>
          <filter id="glow">
            <feGaussianBlur stdDeviation="2" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <circle cx="100" cy="100" r="98" fill="#0d0d1a" stroke="rgba(124,106,255,0.2)" stroke-width="1"/>
        <circle cx="100" cy="100" r="96" fill="url(#faceGrad)"/>
        <!-- Ticks & numbers -->
        ${dotsHtml}
        <!-- Accent ring -->
        <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(124,106,255,0.08)" stroke-width="1"/>
        <!-- Hour hand -->
        <line x1="100" y1="100" x2="${100 + 48 * Math.sin((hAngle)*Math.PI/180)}" y2="${100 - 48 * Math.cos((hAngle)*Math.PI/180)}"
          stroke="rgba(255,255,255,0.9)" stroke-width="5" stroke-linecap="round" filter="url(#glow)"/>
        <!-- Minute hand -->
        <line x1="100" y1="100" x2="${100 + 68 * Math.sin((mAngle)*Math.PI/180)}" y2="${100 - 68 * Math.cos((mAngle)*Math.PI/180)}"
          stroke="rgba(124,106,255,0.95)" stroke-width="3" stroke-linecap="round" filter="url(#glow)"/>
        <!-- Second hand -->
        <line x1="${100 - 18 * Math.sin((sAngle)*Math.PI/180)}" y1="${100 + 18 * Math.cos((sAngle)*Math.PI/180)}"
          x2="${100 + 80 * Math.sin((sAngle)*Math.PI/180)}" y2="${100 - 80 * Math.cos((sAngle)*Math.PI/180)}"
          stroke="rgba(255,80,120,0.95)" stroke-width="1.5" stroke-linecap="round" filter="url(#glow)"/>
        <!-- Center dot -->
        <circle cx="100" cy="100" r="5" fill="#ff5080"/>
        <circle cx="100" cy="100" r="2.5" fill="white"/>
      </svg>

      <!-- Digital time -->
      <div style="text-align:center">
        <div class="clock-digital">${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</div>
        <div class="clock-digital-sm">${dateStr}</div>
      </div>

      <!-- Timezone info -->
      <div style="display:flex;gap:16px;font-size:11px;color:var(--text2)">
        <span>🌍 ${Intl.DateTimeFormat().resolvedOptions().timeZone.replace('_',' ')}</span>
        <span>GMT${now.getTimezoneOffset() <= 0 ? '+' : ''}${(-now.getTimezoneOffset()/60).toFixed(0)}</span>
        <span>KW ${clockGetWeekNum(now)}</span>
      </div>
    </div>`;
}

function clockGetWeekNum(d) {
  const oneJan = new Date(d.getFullYear(), 0, 1);
  return Math.ceil((((d - oneJan) / 86400000) + oneJan.getDay() + 1) / 7);
}

function clockRenderAnalog() {
  if(clockTab === 'clock') clockRenderMain();
}

function clockRenderWorld(pane) {
  pane = pane || document.getElementById('clock-pane');
  if(!pane || clockTab !== 'world') return;
  const now = new Date();

  pane.innerHTML = `
    <div style="width:100%;display:flex;flex-direction:column;gap:8px">
      <div style="font-size:11px;color:var(--text2);text-align:center;margin-bottom:4px">Lokale Zeit: ${now.toLocaleTimeString('de-DE')}</div>
      ${worldClocks.map(wc => {
        const tzTime = new Date().toLocaleTimeString('de-DE', { timeZone: wc.tz, hour:'2-digit', minute:'2-digit' });
        const tzDate = new Date().toLocaleDateString('de-DE', { timeZone: wc.tz, weekday:'short', day:'numeric', month:'short' });
        const offsetMin = -new Date().getTimezoneOffset();
        const tzOffsetMs = now - new Date(now.toLocaleString('en-US', { timeZone: wc.tz }));
        const tzH = now.toLocaleString('en-US', { timeZone: wc.tz, hour:'numeric', hour12:false });
        const isDay = parseInt(tzH) >= 6 && parseInt(tzH) < 20;
        return `<div class="world-clock-row">
          <div>
            <div class="wc-city">${wc.flag} ${wc.city}</div>
            <div class="wc-tz">${wc.tz.replace('/',', ')} · ${isDay ? '☀️ Tag' : '🌙 Nacht'}</div>
          </div>
          <div style="text-align:right">
            <div class="wc-time">${tzTime}</div>
            <div class="wc-offset">${tzDate}</div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

function clockRenderStopwatch(pane) {
  pane = pane || document.getElementById('clock-pane');
  if(!pane) return;
  const elapsed = swElapsed;
  const cs = Math.floor(elapsed / 10) % 100;
  const s = Math.floor(elapsed / 1000) % 60;
  const m = Math.floor(elapsed / 60000) % 60;
  const h = Math.floor(elapsed / 3600000);

  const timeStr = h > 0
    ? `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
    : `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

  pane.innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;gap:20px;padding-top:12px;width:100%">
      <div style="text-align:center">
        <div class="sw-display">${timeStr}<span class="sw-ms">.${String(cs).padStart(2,'0')}</span></div>
      </div>
      <div class="clock-btn-row">
        <button class="clock-btn ${swRunning ? 'danger' : 'primary'}" onclick="swToggle()">${swRunning ? '⏸ Pause' : (swElapsed > 0 ? '▶ Weiter' : '▶ Start')}</button>
        ${swRunning ? `<button class="clock-btn" onclick="swLap()">🏁 Runde</button>` : ''}
        ${!swRunning && swElapsed > 0 ? `<button class="clock-btn" onclick="swReset()">↺ Zurücksetzen</button>` : ''}
      </div>
      ${swLaps.length > 0 ? `
        <div style="width:100%">
          <div style="font-size:10px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;display:flex;justify-content:space-between;padding:0 12px">
            <span>Runde</span><span>Rundenzeit</span><span>Gesamt</span>
          </div>
          <div class="laps-list">
            ${[...swLaps].reverse().map((lap, ri) => {
              const i = swLaps.length - 1 - ri;
              const prev = i > 0 ? swLaps[i-1].total : 0;
              const lapTime = lap.total - prev;
              return `<div class="lap-row" style="${ri === 0 ? 'background:rgba(124,106,255,0.1);' : ''}">
                <span>Runde ${i+1}</span>
                <span>${swFormatTime(lapTime)}</span>
                <span>${swFormatTime(lap.total)}</span>
              </div>`;
            }).join('')}
          </div>
        </div>` : ''}
    </div>`;
}

function swFormatTime(ms) {
  const cs = Math.floor(ms / 10) % 100;
  const s = Math.floor(ms / 1000) % 60;
  const m = Math.floor(ms / 60000) % 60;
  const h = Math.floor(ms / 3600000);
  return (h > 0 ? String(h).padStart(2,'0')+':' : '') +
    String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0') + '.' + String(cs).padStart(2,'0');
}

let swLastTick = 0;
function swToggle() {
  if(swRunning) {
    clearInterval(swInterval); swRunning = false;
  } else {
    swLastTick = Date.now() - swElapsed;
    swRunning = true;
    swInterval = setInterval(() => {
      swElapsed = Date.now() - swLastTick;
      if(clockTab === 'stopwatch') clockRenderStopwatch();
    }, 50);
  }
  clockRenderStopwatch();
}
function swLap() {
  swLaps.push({ total: swElapsed });
  clockRenderStopwatch();
}
function swReset() {
  clearInterval(swInterval); swRunning = false; swElapsed = 0; swLaps = [];
  clockRenderStopwatch();
}

function clockRenderTimerTab(pane) {
  pane = pane || document.getElementById('clock-pane');
  if(!pane) return;

  const rem = timerRemaining;
  const total = timerTotal || 1;
  const frac = Math.max(0, Math.min(1, rem / total));
  const circumference = 2 * Math.PI * 80;
  const dashOffset = circumference * (1 - frac);
  const urgent = rem <= 10000 && rem > 0 && timerRunning;

  const s = Math.floor(rem / 1000) % 60;
  const m = Math.floor(rem / 60000) % 60;
  const h = Math.floor(rem / 3600000);
  const timeStr = h > 0
    ? `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
    : `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

  pane.innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;gap:20px;padding-top:12px;width:100%">
      <!-- Ring -->
      <div class="timer-ring-wrap">
        <svg width="180" height="180" viewBox="0 0 180 180">
          <circle class="timer-ring-bg" cx="90" cy="90" r="80"/>
          <circle class="timer-ring-fill ${urgent ? 'timer-ring-urgent' : ''}" cx="90" cy="90" r="80"
            stroke-dasharray="${circumference.toFixed(1)}"
            stroke-dashoffset="${dashOffset.toFixed(1)}"
            transform="rotate(-90 90 90)"/>
        </svg>
        <div class="timer-center-text">
          <div class="sw-display" style="font-size:38px">${timeStr}</div>
          <div style="font-size:10px;color:var(--text2);margin-top:4px">${timerRunning ? '⏱ Läuft' : rem === 0 && timerTotal > 0 ? '✅ Fertig' : '⏸ Bereit'}</div>
        </div>
      </div>

      <!-- Preset buttons -->
      ${!timerRunning && timerRemaining === 0 ? `
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
        ${[[1,'1 Min'],[3,'3 Min'],[5,'5 Min'],[10,'10 Min'],[15,'15 Min'],[25,'25 Min'],[30,'30 Min'],[60,'1 Std']].map(([min,label])=>
          `<button class="clock-btn" style="min-width:70px;padding:8px 12px" onclick="timerSetMin(${min})">${label}</button>`
        ).join('')}
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <input type="number" id="timer-custom-h" placeholder="hh" min="0" max="23" style="width:48px;text-align:center;background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;outline:none">
        <span style="color:var(--text2)">:</span>
        <input type="number" id="timer-custom-m" placeholder="mm" min="0" max="59" style="width:48px;text-align:center;background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;outline:none">
        <span style="color:var(--text2)">:</span>
        <input type="number" id="timer-custom-s" placeholder="ss" min="0" max="59" style="width:48px;text-align:center;background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:6px;color:var(--text);font-family:'Inter',sans-serif;font-size:13px;outline:none">
        <button class="clock-btn primary" onclick="timerSetCustom()">▶ Start</button>
      </div>` : ''}

      <div class="clock-btn-row">
        ${timerTotal > 0 ? `
          <button class="clock-btn ${timerRunning ? 'danger' : 'primary'}" onclick="timerToggle()">
            ${timerRunning ? '⏸ Pause' : '▶ ' + (timerRemaining === timerTotal ? 'Start' : 'Weiter')}
          </button>
          <button class="clock-btn" onclick="timerReset()">↺ Zurücksetzen</button>
        ` : ''}
      </div>
    </div>`;
}

function timerSetMin(min) {
  timerTotal = min * 60000;
  timerRemaining = timerTotal;
  timerRunning = false;
  clearInterval(timerInterval);
  clockRenderTimerTab();
  // Auto-start
  timerToggle();
}
function timerSetCustom() {
  const h = parseInt(document.getElementById('timer-custom-h')?.value) || 0;
  const m = parseInt(document.getElementById('timer-custom-m')?.value) || 0;
  const s = parseInt(document.getElementById('timer-custom-s')?.value) || 0;
  const ms = (h*3600 + m*60 + s)*1000;
  if(ms <= 0) return;
  timerTotal = ms; timerRemaining = ms;
  clearInterval(timerInterval); timerRunning = false;
  clockRenderTimerTab();
  timerToggle();
}
function timerToggle() {
  if(timerRunning) {
    clearInterval(timerInterval); timerRunning = false;
    clockRenderTimerTab();
  } else if(timerRemaining > 0) {
    timerRunning = true;
    const tickRate = 250;
    timerInterval = setInterval(() => {
      timerRemaining = Math.max(0, timerRemaining - tickRate);
      if(timerRemaining <= 0) {
        clearInterval(timerInterval); timerRunning = false;
        showNotif('NovUhr', '⏰ Timer abgelaufen!', '#ffca6a');
      }
      if(clockTab === 'timer') clockRenderTimerTab();
    }, tickRate);
    clockRenderTimerTab();
  }
}
function timerReset() {
  clearInterval(timerInterval); timerRunning = false;
  timerRemaining = timerTotal;
  clockRenderTimerTab();
}

function clockRenderAlarms(pane) {
  pane = pane || document.getElementById('clock-pane');
  if(!pane) return;

  pane.innerHTML = `
    <div style="width:100%;display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <div style="font-size:13px;font-weight:700;color:var(--text)">Wecker</div>
        <button class="clock-btn primary" style="padding:6px 14px" onclick="alarmAdd()">＋ Neu</button>
      </div>
      ${alarms.length === 0 ? '<div style="text-align:center;color:var(--text2);padding:24px">Kein Wecker eingestellt</div>' : ''}
      ${alarms.map((al, i) => `
        <div class="alarm-row" style="opacity:${al.enabled ? '1' : '0.45'}">
          <div style="flex:1">
            <div class="alarm-time-disp">${al.time}</div>
            <div class="alarm-label">${al.label}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="toggle ${al.enabled?'on':''}" onclick="alarmToggle(${i})" style="cursor:pointer"></div>
            <button class="clock-btn danger" style="min-width:auto;padding:6px 10px" onclick="alarmDelete(${i})">✕</button>
          </div>
        </div>`).join('')}
      <div style="font-size:10px;color:var(--text2);text-align:center;margin-top:8px">
        Nächster Wecker: ${alarmNext()}
      </div>
    </div>`;
}

function alarmNext() {
  const enabled = alarms.filter(a => a.enabled);
  if(!enabled.length) return '—';
  const now = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();
  const sorted = [...enabled].sort((a,b) => {
    const [ah,am] = a.time.split(':').map(Number);
    const [bh,bm] = b.time.split(':').map(Number);
    const da = (ah*60+am - nowMin + 1440) % 1440;
    const db = (bh*60+bm - nowMin + 1440) % 1440;
    return da - db;
  });
  return sorted[0].time + ' – ' + sorted[0].label;
}

async function alarmAdd() {
  const time = await novDialog({ icon:'🔔', title:'Neuer Wecker', msg:'Uhrzeit (HH:MM):', input:true, inputDefault:'07:00', confirmLabel:'Hinzufügen' });
  if(!time) return;
  const label = await novDialog({ icon:'🏷️', title:'Bezeichnung', msg:'Bezeichnung (optional):', input:true, inputDefault:'Wecker', confirmLabel:'Speichern' });
  if(label === null) return;
  alarms.push({ time: time.trim(), label: label || 'Wecker', enabled: true });
  if(clockTab === 'alarm') clockRenderAlarms();
}

function alarmToggle(i) {
  alarms[i].enabled = !alarms[i].enabled;
  if(clockTab === 'alarm') clockRenderAlarms();
}

async function alarmDelete(i) {
  const ok = await novDialog({ icon:'🗑️', title:'Wecker löschen', msg:`"${alarms[i].time} – ${alarms[i].label}" löschen?`, danger:true, confirmLabel:'Löschen' });
  if(!ok) return;
  alarms.splice(i, 1);
  if(clockTab === 'alarm') clockRenderAlarms();
}

let _lastAlarmCheck = '';
function clockCheckAlarms() {
  const now = new Date();
  const timeStr = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  if(now.getSeconds() !== 0 || timeStr === _lastAlarmCheck) return;
  _lastAlarmCheck = timeStr;
  alarms.filter(a => a.enabled && a.time === timeStr).forEach(a => {
    showNotif('⏰ Wecker', a.label + ' – ' + a.time, '#ffca6a');
  });
}

// Settings UI
function buildSettings() {
  return `
    <div style="display:flex;flex:1;overflow:hidden;min-height:0;">
      <div class="settings-sidebar">
        <div class="fm-section">System</div>
        ${[['design','🎨 Design'],['sound','🔊 Ton'],['network','📶 Netzwerk'],['security','🔒 Sicherheit'],['storage','💾 Speicher']].map(([k,l])=>`
        <div class="fm-item ${k==='design'?'active':''}" id="si-${k}" onclick="loadSettings('${k}')">${l}</div>`).join('')}
        <div class="fm-section">Anpassung</div>
        ${[['notifs','🔔 Benachrichtigungen'],['privacy','🕵️ Datenschutz'],['browser_set','🌐 Browser']].map(([k,l])=>`
        <div class="fm-item" id="si-${k}" onclick="loadSettings('${k}')">${l}</div>`).join('')}
        <div class="fm-section">Info</div>
        <div class="fm-item" id="si-about" onclick="loadSettings('about')">ℹ️ Über NovOS</div>
      </div>
      <div class="settings-content" id="settings-pane"></div>
    </div>`;
}
function initSettingsSidebar() { loadSettings('design'); }

function settingToggle(key, label, small='') {
  const on = !!NovSettings[key];
  return `<div class="setting-row">
    <div class="setting-label">${label}${small ? `<small>${small}</small>` : ''}</div>
    <div class="toggle ${on?'on':''}" data-key="${key}"
      onclick="NovSettings['${key}']=!NovSettings['${key}'];saveNovSettings();applyAllSettings();this.classList.toggle('on',!!NovSettings['${key}'])">
    </div>
  </div>`;
}

const settingsBuilders = {
  design: () => `<div class="setting-group">
    <h3>🎨 Erscheinungsbild</h3>
    ${settingToggle('darkMode','Dunkles Design','Systemweites dunkles Farbschema')}
    ${settingToggle('transparency','Transparenz-Effekte','Glasmorphismus & Blur')}
    ${settingToggle('animations','Animationen','Fenster- & UI-Übergänge')}
    <div class="setting-row">
      <div class="setting-label">Akzentfarbe</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${Object.entries(ACCENT_PRESETS).map(([k,v])=>`
          <div onclick="setSetting('accentPreset','${k}');renderSettingsAccents()" title="${k}" style="
            width:22px;height:22px;border-radius:50%;background:${v.accent};cursor:pointer;
            border:2px solid ${NovSettings.accentPreset===k?'white':'transparent'};
            box-shadow:0 0 0 1px rgba(255,255,255,0.2);transition:transform 0.1s;"
            id="accent-dot-${k}"
            onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
          </div>`).join('')}
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">UI-Schriftgröße</div>
      <select class="setting-select" onchange="setSetting('uiScale',this.value)">
        ${['11px','12px','13px','14px','15px'].map(s=>`<option ${NovSettings.uiScale===s?'selected':''}>${s}</option>`).join('')}
      </select>
    </div>
    <div class="setting-row">
      <div class="setting-label">Hintergrund</div>
      <div>
        <div style="font-size:10px;color:var(--text2);margin-bottom:4px">Hell</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
          ${WALLPAPER_PRESETS.slice(0,4).map((wp,i)=>`
            <div onclick="setSetting('wallpaperIdx',${i});renderSettingsWP()" title="Hell ${i+1}" style="
              width:32px;height:22px;border-radius:4px;background:${wp};cursor:pointer;
              border:2px solid ${NovSettings.wallpaperIdx===i?'var(--accent)':'transparent'};
              box-shadow:0 0 0 1px rgba(0,0,0,0.15);transition:transform 0.1s"
              id="wp-thumb-${i}"
              onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            </div>`).join('')}
        </div>
        <div style="font-size:10px;color:var(--text2);margin-bottom:4px">Dunkel</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          ${WALLPAPER_PRESETS.slice(4,8).map((wp,i)=>`
            <div onclick="setSetting('wallpaperIdx',${i+4});renderSettingsWP()" title="Dunkel ${i+1}" style="
              width:32px;height:22px;border-radius:4px;background:${wp};cursor:pointer;
              border:2px solid ${NovSettings.wallpaperIdx===i+4?'var(--accent)':'transparent'};
              box-shadow:0 0 0 1px rgba(255,255,255,0.1);transition:transform 0.1s"
              id="wp-thumb-${i+4}"
              onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            </div>`).join('')}
        </div>
      </div>
    </div>
  </div>`,

  sound: () => `<div class="setting-group">
    <h3>🔊 Ton & Audio</h3>
    <div class="setting-row">
      <div class="setting-label">Lautstärke</div>
      <div style="display:flex;align-items:center;gap:8px">
        <input type="range" style="width:120px" min="0" max="100" value="${NovSettings.volume}"
          oninput="setSetting('volume',+this.value);document.getElementById('vol-display').textContent=this.value+'%'">
        <span id="vol-display" style="font-size:11px;color:var(--text2);width:32px">${NovSettings.volume}%</span>
      </div>
    </div>
    ${settingToggle('systemSounds','Systemklänge','Benachrichtigungs- und UI-Töne')}
    <div class="setting-row"><div class="setting-label">Ausgabegerät</div>
      <select class="setting-select"><option>NovSound HD</option><option>HDMI Audio</option><option>Bluetooth LE Audio</option></select>
    </div>
  </div>`,

  network: () => `<div class="setting-group">
    <h3>📶 Netzwerk</h3>
    ${settingToggle('wifiEnabled','WLAN','Verbunden mit: NovNet-5G')}
    ${settingToggle('bluetooth','Bluetooth','')}
    ${settingToggle('vpn','VPN','Sicheres Tunneling')}
    <div class="setting-row"><div class="setting-label">IP-Adresse</div><span style="font-size:12px;color:var(--text2)">192.168.1.42</span></div>
    <div class="setting-row"><div class="setting-label">MAC-Adresse</div><span style="font-size:12px;color:var(--text2)">A4:C3:F0:12:34:56</span></div>
    <div class="setting-row"><div class="setting-label">DNS</div><span style="font-size:12px;color:var(--text2)">1.1.1.1 (Cloudflare)</span></div>
  </div>`,

  security: () => `<div class="setting-group">
    <h3>🔒 Sicherheit</h3>
    <div class="setting-row">
      <div class="setting-label">Benutzername<small>Wird auf dem Login-Bildschirm angezeigt</small></div>
      <div style="display:flex;gap:6px">
        <input id="username-inp" class="sm-search" style="width:120px;margin:0;padding:4px 8px" value="${NovSettings.userName}">
        <button class="setting-btn" onclick="setSetting('userName',document.getElementById('username-inp').value);showNotif('Einstellungen','Name gespeichert ✓','#6affca')">✓</button>
      </div>
    </div>
    <div class="setting-row"><div class="setting-label">Bildschirmsperre</div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
    <div class="setting-row"><div class="setting-label">Zwei-Faktor-Auth</div><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
    <div class="setting-row"><div class="setting-label">Firewall</div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
    <div class="setting-row"><div class="setting-label">Virenscanner</div>
      <button class="setting-btn" onclick="this.textContent='Scannt…';setTimeout(()=>{this.textContent='Jetzt scannen';showNotif('Sicherheit','Scan abgeschlossen – Keine Bedrohungen ✓','#6affca')},1800)">Jetzt scannen</button>
    </div>
  </div>`,

  storage: () => {
    const used = Object.values(vfsContents).join('').length;
    const lsUsed = JSON.stringify(localStorage).length;
    return `<div class="setting-group">
    <h3>💾 Speicher</h3>
    <div class="setting-row"><div class="setting-label">Systemlaufwerk</div><span style="font-size:12px;color:var(--text2)">128 GB / 512 GB (25%)</span></div>
    <div style="margin:8px 0"><div class="bar-track" style="height:10px"><div class="bar-fill" style="background:linear-gradient(90deg,var(--accent),var(--accent2));width:25%;height:100%"></div></div></div>
    <div class="setting-row"><div class="setting-label">Einstellungen (localStorage)</div><span style="font-size:12px;color:var(--accent3)">${lsUsed} Bytes</span></div>
    <div class="setting-row"><div class="setting-label">VFS-Inhalt</div><span style="font-size:12px;color:var(--accent3)">${used} Bytes</span></div>
    <div class="setting-row"><div class="setting-label">Einstellungen zurücksetzen</div>
      <button class="setting-btn danger" onclick="novDlgResetSettings()">↺ Reset</button>
    </div>
    <div class="setting-row"><div class="setting-label">Dateisystem zurücksetzen</div>
      <button class="setting-btn danger" onclick="novDlgResetVFS()">🗑️ Reset</button>
    </div>
  </div>`;
  },

  notifs: () => `<div class="setting-group">
    <h3>🔔 Benachrichtigungen</h3>
    ${settingToggle('doNotDisturb','Nicht stören','Alle Benachrichtigungen stumm')}
    ${settingToggle('notifBrowser','NovBrowser','')}
    ${settingToggle('notifMusic','NovMusic','')}
    ${settingToggle('notifMail','NovMail','')}
    <div class="setting-row"><div class="setting-label">NovUpdate</div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
    <div class="setting-row"><div class="setting-label">Testbenachrichtigung</div>
      <button class="setting-btn" onclick="showNotif('Test','Das ist eine Testbenachrichtigung 🔔')">Senden</button>
    </div>
  </div>`,

  privacy: () => `<div class="setting-group">
    <h3>🕵️ Datenschutz</h3>
    ${settingToggle('telemetry','Telemetrie','Anonyme Nutzungsdaten senden')}
    ${settingToggle('locationServices','Standortdienste','')}
    <div class="setting-row"><div class="setting-label">Kamera</div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
    <div class="setting-row"><div class="setting-label">Gespeicherte Daten</div>
      <button class="setting-btn danger" onclick="novDlgClearAll()">🗑️ Alle löschen</button>
    </div>
  </div>`,

  browser_set: () => `<div class="setting-group">
    <h3>🌐 Browser-Einstellungen</h3>
    <div class="setting-row">
      <div class="setting-label">Startseite</div>
      <div style="display:flex;gap:6px">
        <input id="homepage-inp" class="sm-search" style="width:150px;margin:0;padding:4px 8px" value="${NovSettings.browserHomepage}">
        <button class="setting-btn" onclick="setSetting('browserHomepage',document.getElementById('homepage-inp').value);showNotif('Browser','Startseite gespeichert ✓','#6affca')">✓</button>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">Suchmaschine</div>
      <select class="setting-select" onchange="setSetting('browserSearch',this.value)">
        ${['DuckDuckGo','Google','Bing','Ecosia','Startpage'].map(s=>`<option ${NovSettings.browserSearch===s?'selected':''}>${s}</option>`).join('')}
      </select>
    </div>
    <div class="setting-row"><div class="setting-label">Verlauf löschen</div>
      <button class="setting-btn danger" onclick="browserTabsData=[{id:'t1',url:NovSettings.browserHomepage,title:'Neuer Tab',history:[NovSettings.browserHomepage],histPos:0}];browserActiveTab='t1';if(windows.browser)browserRebuildTabs();showNotif('Browser','Verlauf gelöscht 🗑️','#ff6a8a')">🗑️ Löschen</button>
    </div>
    <div class="setting-row"><div class="setting-label">Lesezeichen</div>
      <button class="setting-btn" onclick="openApp('browser');browserGo('nov://bookmarks')">📚 Öffnen</button>
    </div>
  </div>`,

  about: () => `<div class="setting-group">
    <h3>ℹ️ Über NovOS</h3>
    <div class="about-box">
      <div class="about-logo">✦</div>
      <div><div class="about-name">NovOS</div><div class="about-ver">Version 3.1.0 – nova-6.4.2</div></div>
    </div>
    <div class="setting-row"><div class="setting-label">Gerätename</div><span style="font-size:12px;color:var(--text2)">nova-machine</span></div>
    <div class="setting-row"><div class="setting-label">Prozessor</div><span style="font-size:12px;color:var(--text2)">nova-core i9 (16 Kerne)</span></div>
    <div class="setting-row"><div class="setting-label">Arbeitsspeicher</div><span style="font-size:12px;color:var(--text2)">16 GB DDR5</span></div>
    <div class="setting-row"><div class="setting-label">localStorage-Einstellungen</div><span style="font-size:11px;color:var(--accent3)">✓ Aktiv – Einstellungen bleiben beim Neuladen erhalten</span></div>
    <div class="setting-row"><div class="setting-label">Updates</div>
      <button class="setting-btn" onclick="this.textContent='Prüfe…';setTimeout(()=>{this.textContent='🔄 Prüfen';showNotif('NovUpdate','Alle Updates installiert ✓','#6affca')},1200)">🔄 Prüfen</button>
    </div>
  </div>`,
};

function loadSettings(key) {
  document.querySelectorAll('[id^="si-"]').forEach(i=>i.classList.remove('active'));
  document.getElementById('si-'+key)?.classList.add('active');
  const pane = document.getElementById('settings-pane');
  if(!pane) return;
  const builder = settingsBuilders[key];
  pane.innerHTML = builder ? builder() : '<div style="padding:20px;color:var(--text2)">Seite nicht gefunden</div>';
}
function renderSettingsAccents() {
  Object.keys(ACCENT_PRESETS).forEach(k=>{
    const el=document.getElementById('accent-dot-'+k);
    if(el) el.style.border=`2px solid ${NovSettings.accentPreset===k?'white':'transparent'}`;
  });
}
function renderSettingsWP() {
  WALLPAPER_PRESETS.forEach((_,i)=>{
    const el=document.getElementById('wp-thumb-'+i);
    if(el) el.style.border=`2px solid ${NovSettings.wallpaperIdx===i?'white':'transparent'}`;
  });
}
</script>
</body>
</html>
